<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="FengJian's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="FengJian&#39;s Blog">
<meta property="og:url" content="http://fengjian0106.github.io/index.html">
<meta property="og:site_name" content="FengJian&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="FengJian&#39;s Blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> FengJian's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?eeb1f7ee5ca721cee0bcad8df6a28d5e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">FengJian's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">iOS Golang node.js Developer</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/02/Document-Scanning-With-TensorFlow-And-OpenCV-Part-Two/" itemprop="url">
                  手机端运行卷积神经网络实现文档检测功能(二) -- 从 VGG 到 MobileNetV2 知识梳理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-06-02T18:00:00+08:00" content="2018-06-02">
              2018-06-02
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/06/02/Document-Scanning-With-TensorFlow-And-OpenCV-Part-Two/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/02/Document-Scanning-With-TensorFlow-And-OpenCV-Part-Two/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><ul>
<li>这是 <strong><em><a href="http://fengjian0106.github.io/2017/05/08/Document-Scanning-With-TensorFlow-And-OpenCV/">上一篇博客</a></em></strong> 的后续和补充，这次对边缘检测算法的升级优化，起源于一个意外事件，前一个版本是使用 TensorFlow 1.0 部署的， 并且是用 <a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/slim" target="_blank" rel="noopener">TF-Slim API</a> 编写的代码，最近想使用 TensorFlow 1.7 重新部署一遍，本来以为是一件比较容易的事情，结果实操的时候才发现全是坑，首先遇到的就是废弃 API 的问题，TensorFlow 1.0 里面的某些 API 在 TensorFlow 1.7 里面已经是彻底废弃掉不能使用了，这个问题还好办，修改一下代码就行。后面遇到的一个问题就让我彻底傻眼了，用新的代码加载了旧的模型文件，想 Fine Tuning 一下，结果模型不收敛了，从零开始重新训练也是无法收敛，查了挺长时间也没定位到原因，所以，干脆重写一遍代码。</li>
<li>反正都要重写代码了，那也就可以把最近一年学到的新东西融合进来，就当做是效果验证了。引入这些新的技术后，原始模型其实变化挺大的，而且用到的这些技术，又会牵扯出很多比较通用的基础知识，所以从这个角度来说，这篇文章要记录的重点并不是升级优化(升级后的模型，准确性和前一个版本相比并没有明显的区别，但是模型的体积从 <em>4.4M</em> 减小到了 <em>1.6M</em> ，网络的训练过程也比之前容易了许多)，而是对 <strong><em>多个基础知识点的梳理和总结</em></strong> 。</li>
<li>涉及到的知识点比较多，有工程层面的，也有理论算法层面的，和工程相关的内容会尽量用代码片段来展示，遇到理论知识，只会简单的介绍一下，划出重点，不会做数学层面的推导，同时，会在最后的『参考资料』章节中列出更多的参考内容。</li>
<li>趁这个机会也把代码重新整理了一遍，放在了 github 上，<a href="https://github.com/fengjian0106/hed-tutorial-for-document-scanning" target="_blank" rel="noopener">https://github.com/fengjian0106/hed-tutorial-for-document-scanning</a></li>
</ul>
<h3 id="TensorFlow-Code-Style-For-CNN-Net"><a href="#TensorFlow-Code-Style-For-CNN-Net" class="headerlink" title="TensorFlow Code Style For CNN Net"></a>TensorFlow Code Style For CNN Net</h3><p>之前的那个版本，选用 TF-Slim API 编写代码，就是因为这套 API 是比较优雅的，比如想调用一次最基本的卷积层运算，如果直接使用 <a href="https://www.tensorflow.org/api_docs/python/tf/nn/conv2d" target="_blank" rel="noopener">tf.nn.conv2d</a> 的话，代码会是下面这个样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">input = ...</span><br><span class="line"><span class="keyword">with</span> tf.name_scope(<span class="string">'conv1_1'</span>) <span class="keyword">as</span> scope:</span><br><span class="line">	kernel = tf.Variable(tf.truncated_normal([<span class="number">3</span>, <span class="number">3</span>, <span class="number">64</span>, <span class="number">128</span>], dtype=tf.float32, stddev=<span class="number">1e-1</span>), name=<span class="string">'weights'</span>)</span><br><span class="line">	conv = tf.nn.conv2d(input, kernel, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">'SAME'</span>)</span><br><span class="line">	biases = tf.Variable(tf.constant(<span class="number">0.0</span>, shape=[<span class="number">128</span>], dtype=tf.float32), trainable=<span class="keyword">True</span>, name=<span class="string">'biases'</span>)</span><br><span class="line">	bias = tf.nn.bias_add(conv, biases)</span><br><span class="line">	conv1 = tf.nn.relu(bias, name=scope)</span><br></pre></td></tr></table></figure>
<p>如果用 TF-Slim API 编码的话，则会变成下面这种风格：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">input = ...</span><br><span class="line">net = slim.conv2d(input, <span class="number">128</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv1_1'</span>)</span><br></pre></td></tr></table></figure>
<p>因为在各种卷积神经网络结构中，通常都会大量的使用卷积运算，构建很多卷积层，并且使用不同的配置参数，所以很明显，TF-Slim 风格的 API 可以很优雅的简化代码。</p>
<p>但是，在看过图像处理领域的一些论文和各种版本的参考代码之后，发现 TF-Slim 还是有一些局限性的。常规的卷积层操作，用 TF-Slim 是可以简化代码，但是神经网络这个领域发展的速度太快了，经常都会有新的论文发表出来，也就经常会遇到一些新的 layer 结构，TF-Slim 并不是总能很方便的表达出这些 layer，因此需要一种更低层一些、但是更灵活，同时还保持优雅的解决办法。</p>
<p>顺着这个思路，后来发现其实 <a href="https://www.tensorflow.org/api_docs/python/tf/layers" target="_blank" rel="noopener">tf.layers</a> 这个 Module 就可以很好的满足前面提到的这些需求。</p>
<p>另外，这次遇到的在 TensorFlow 1.7 上旧模型不收敛的情况，虽然没有准确定位到原因、没找到解决办法，但是分析了一圈后，其实还是怀疑是因为使用 TF-Slim 而引出的问题，虽然 TF-Slim 简化了卷积层相关的代码，但是完整的代码中还是要使用 TensorFlow 中的其他 API 的，TF-Slim 封装出来的抽象度比较高，除了卷积操作的 API，它还封装了其他的一些 API，但是它的抽象设计和 TensorFlow 是有一种分裂感的，混合在一起编程时会觉得有点奇怪，我这次遇到的问题，也可能就是某些 API 使用的不正确而引起的(TF1.0时运行正常，TF1.7时运行不正常)。而 tf.layers 就不会有这种感觉，tf.layers 的抽象度比 TF-Slim 更低一些，它更像是 TensorFlow 的底层 API 的一个延展，并没有引入新的抽象度，这套 API 用起来就更舒服一些。</p>
<p>比如，升级前的 HED 网络，换用 tf.layers 后，代码是下面这个样子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">vgg_style_hed</span><span class="params">(inputs, batch_size, is_training)</span>:</span></span><br><span class="line">    filter_initializer = tf.contrib.layers.xavier_initializer()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> const.use_kernel_regularizer:</span><br><span class="line">        weights_regularizer = tf.contrib.layers.l2_regularizer(scale=<span class="number">0.0005</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        weights_regularizer = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_vgg_conv2d</span><span class="params">(inputs, filters, kernel_size)</span>:</span></span><br><span class="line">        use_bias = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            use_bias = <span class="keyword">False</span></span><br><span class="line">            </span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## call relu after batch normalization</span></span><br><span class="line">                                   use_bias=use_bias,</span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">        outputs = tf.nn.relu(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_max_pool2d</span><span class="params">(inputs)</span>:</span></span><br><span class="line">        outputs = tf.layers.max_pooling2d(inputs, </span><br><span class="line">                                          [<span class="number">2</span>, <span class="number">2</span>], </span><br><span class="line">                                          strides=(<span class="number">2</span>, <span class="number">2</span>),</span><br><span class="line">                                          padding=<span class="string">'same'</span>)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dsn_1x1_conv2d</span><span class="params">(inputs, filters)</span>:</span></span><br><span class="line">        use_bias = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            use_bias = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                   use_bias=use_bias, </span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">        <span class="comment">## no activation</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_output_1x1_conv2d</span><span class="params">(inputs, filters)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                   use_bias=<span class="keyword">True</span>, <span class="comment">## use bias</span></span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        <span class="comment">## no batch normalization</span></span><br><span class="line">        <span class="comment">## no activation</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dsn_deconv2d_with_upsample_factor</span><span class="params">(inputs, filters, upsample_factor)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">2</span> * upsample_factor, <span class="number">2</span> * upsample_factor]</span><br><span class="line">        outputs = tf.layers.conv2d_transpose(inputs,</span><br><span class="line">                                             filters, </span><br><span class="line">                                             kernel_size, </span><br><span class="line">                                             strides=(upsample_factor, upsample_factor), </span><br><span class="line">                                             padding=<span class="string">'same'</span>, </span><br><span class="line">                                             activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                             use_bias=<span class="keyword">True</span>, <span class="comment">## use bias</span></span><br><span class="line">                                             kernel_initializer=filter_initializer,</span><br><span class="line">                                             kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        <span class="comment">## no batch normalization</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="comment"># ref https://github.com/s9xie/hed/blob/master/examples/hed/train_val.prototxt</span></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">'hed'</span>, <span class="string">'hed'</span>, [inputs]):</span><br><span class="line">        end_points = &#123;&#125;</span><br><span class="line">        net = inputs</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv1'</span>):</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">12</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">12</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            dsn1 = net</span><br><span class="line">            net = _max_pool2d(net)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv2'</span>):</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">24</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">24</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            dsn2 = net</span><br><span class="line">            net = _max_pool2d(net)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv3'</span>):</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">48</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">48</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">48</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            dsn3 = net</span><br><span class="line">            net = _max_pool2d(net)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv4'</span>):</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">96</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">96</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">96</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            dsn4 = net</span><br><span class="line">            net = _max_pool2d(net)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv5'</span>):</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">192</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">192</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            net = _vgg_conv2d(net, <span class="number">192</span>, [<span class="number">3</span>, <span class="number">3</span>])</span><br><span class="line">            dsn5 = net</span><br><span class="line">            <span class="comment"># net = _max_pool2d(net) # no need this pool layer</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">## dsn layers</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn1'</span>):</span><br><span class="line">            dsn1 = _dsn_1x1_conv2d(dsn1, <span class="number">1</span>)</span><br><span class="line">            <span class="comment">## no need deconv2d</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn2'</span>):</span><br><span class="line">            dsn2 = _dsn_1x1_conv2d(dsn2, <span class="number">1</span>)</span><br><span class="line">            dsn2 = _dsn_deconv2d_with_upsample_factor(dsn2, <span class="number">1</span>, upsample_factor = <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn3'</span>):</span><br><span class="line">            dsn3 = _dsn_1x1_conv2d(dsn3, <span class="number">1</span>)</span><br><span class="line">            dsn3 = _dsn_deconv2d_with_upsample_factor(dsn3, <span class="number">1</span>, upsample_factor = <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn4'</span>):</span><br><span class="line">            dsn4 = _dsn_1x1_conv2d(dsn4, <span class="number">1</span>)</span><br><span class="line">            dsn4 = _dsn_deconv2d_with_upsample_factor(dsn4, <span class="number">1</span>, upsample_factor = <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn5'</span>):</span><br><span class="line">            dsn5 = _dsn_1x1_conv2d(dsn5, <span class="number">1</span>)</span><br><span class="line">            dsn5 = _dsn_deconv2d_with_upsample_factor(dsn5, <span class="number">1</span>, upsample_factor = <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">##dsn fuse</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn_fuse'</span>):</span><br><span class="line">            dsn_fuse = tf.concat([dsn1, dsn2, dsn3, dsn4, dsn5], <span class="number">3</span>)</span><br><span class="line">            dsn_fuse = _output_1x1_conv2d(dsn_fuse, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dsn_fuse, dsn1, dsn2, dsn3, dsn4, dsn5</span><br></pre></td></tr></table></figure>
<p>上面这份代码里面的一些细节，会在后面的章节里详细介绍，并且会逐步的演化成 MobileNetV2 style 的 HED 网络。这里首先看一下代码的整体结构，相当于是套用了下面这种形式的模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xx_net</span><span class="params">(inputs, batch_size, is_training)</span>:</span></span><br><span class="line">    filter_initializer = tf.contrib.layers.xavier_initializer()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">layer_for_type1</span><span class="params">(inputs, ...)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">layer_for_type2</span><span class="params">(inputs, ...)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">layer_for_typeN</span><span class="params">(inputs, ...)</span>:</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">with</span> tf.variable_scope(<span class="string">'xx_net'</span>, <span class="string">'xx_net'</span>, [inputs]):</span><br><span class="line">        end_points = &#123;&#125;</span><br><span class="line">        net = inputs</span><br><span class="line"></span><br><span class="line">        net = layer_for_type1(net, ...)</span><br><span class="line">        net = layer_for_type1(net, ...)</span><br><span class="line">        net = layer_for_type2(net, ...)</span><br><span class="line">        ...</span><br><span class="line">        net = layer_for_typeN(net, ...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> net, end_points</span><br></pre></td></tr></table></figure>
<p>这种风格的代码，前面一部分就是定义实现不同功能的各种 layer，后面部分就是用各种 layer 来组装 net 的主体结构。layer 由嵌套函数定义，方便进行各种自定义的配置或组装，net 主体部分，跟 TF-Slim 的风格其实也是类似的，layer 之间的层级关系简单明了，更容易和论文中的配置表格或结构示意图对应起来。我在实现其他网络结构的时候，都是套用的这种代码结构，基本上都能满足灵活性和简洁性的需求。  </p>
<h3 id="矩阵初始化"><a href="#矩阵初始化" class="headerlink" title="矩阵初始化"></a>矩阵初始化</h3><p>矩阵的初始化方法有很多种，在 TensorFlow 里，常规初始化方法的效果对比可以看这篇文章 <a href="https://github.com/udacity/deep-learning/blob/master/weight-initialization/weight_initialization.ipynb" target="_blank" rel="noopener">Weight Initialization</a>，能使用 <a href="https://www.tensorflow.org/api_docs/python/tf/truncated_normal" target="_blank" rel="noopener">tf.truncated_normal</a> 或 <a href="https://www.tensorflow.org/api_docs/python/tf/truncated_normal_initializer" target="_blank" rel="noopener">tf.truncated_normal_initializer</a> 进行初始化，说明已经对这个问题有所掌握了，随着学习的深入，更推荐使用另外一种初始化方法 <strong><em>Xavier initialization</em></strong> ，使用起来也比较简单：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W = tf.get_variable(<span class="string">'W'</span>, shape=[<span class="number">784</span>, <span class="number">256</span>], </span><br><span class="line">                    initializer=tf.contrib.layers.xavier_initializer())</span><br></pre></td></tr></table></figure>
<p>关于 Xavier initialization 的更多内容，请参考本文末尾部分列出的资料。</p>
<h3 id="Batch-Normalization"><a href="#Batch-Normalization" class="headerlink" title="Batch Normalization"></a>Batch Normalization</h3><p><a href="https://github.com/udacity/deep-learning/blob/master/batch-norm/Batch_Normalization_Lesson.ipynb" target="_blank" rel="noopener">Batch Normalization – Lesson</a> 这篇教程对 Batch Normalization 解释的比较清楚，通俗点描述，普通的 Normalization 是对神经网络的输入数据做归一化处理，把输入数据和输出数据的取值都缩放到一个范围内，通常都是 0.0 ~ 1.0 这个区间，而 Batch Normalization 则是把整体的神经网络结构看成是由很多不同的 layer 组成的，对每个 layer 的输入数据再做一次规范化的操作，因为只能在训练的过程中才能获取到每个 layer 上的 input data，而训练过程又是基于 batch 的，所以叫做 <em>Batch Normalization</em>。Batch Normalization 的具体数学公式，这里不详细描述了，有兴趣的读者请参考末尾部分列出的资料，下面仅从工程层面提出一些建议和要注意的细节点。</p>
<h5 id="Batch-Normalization-的优势很明显，尽量使用"><a href="#Batch-Normalization-的优势很明显，尽量使用" class="headerlink" title="Batch Normalization 的优势很明显，尽量使用"></a>Batch Normalization 的优势很明显，尽量使用</h5><p>Batch Normalization 的优势挺多的，比如可以加快模型收敛的速度、可以使用较高的 learning rates、可以降低权重矩阵初始化的难度、可以提高网络的训练效果等等，总而言之，就是要尽量的使用 Batch Normalization 技术。近几年新发表的很多论文中，也是经常看到 Batch Normalization 的身影。</p>
<p>TensorFlow 提供了相关的 API，在 layer 中添加 Batch Normalization 也就是一行代码的事，不过因为 Batch Normalization 里面有一部分参数也是需要参与反向传播过程进行训练的，所以构造优化器的时候，还要额外添加一些代码把 Batch Normalization 的权重参数也包含进去，类似下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_vgg_conv2d</span><span class="params">(inputs, filters, kernel_size)</span>:</span></span><br><span class="line">        use_bias = <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            use_bias = <span class="keyword">False</span></span><br><span class="line">            </span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## call relu after batch normalization</span></span><br><span class="line">                                   use_bias=use_bias,</span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm:</span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">        outputs = tf.nn.relu(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">        </span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.variable_scope(<span class="string">"adam_vars"</span>):</span><br><span class="line">        <span class="keyword">if</span> const.use_batch_norm == <span class="keyword">True</span>:</span><br><span class="line">            <span class="keyword">with</span> tf.control_dependencies(tf.get_collection(tf.GraphKeys.UPDATE_OPS)):</span><br><span class="line">                train_step = tf.train.AdamOptimizer(learning_rate=FLAGS.learning_rate).minimize(cost)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            train_step = tf.train.AdamOptimizer(learning_rate=FLAGS.learning_rate).minimize(cost)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h5 id="不需要使用-bias"><a href="#不需要使用-bias" class="headerlink" title="不需要使用 bias"></a>不需要使用 bias</h5><p>从前面的代码片段可以看到，用了 Batch Normalization 后，就不再需要添加 bias 偏移向量了，<a href="https://stackoverflow.com/questions/46256747/can-not-use-both-bias-and-batch-normalization-in-convolution-layers" target="_blank" rel="noopener">Can not use both bias and batch normalization in convolution layers
</a> 这里有解释原因。</p>
<h5 id="在什么位置添加-Batch-Normalization"><a href="#在什么位置添加-Batch-Normalization" class="headerlink" title="在什么位置添加 Batch Normalization"></a>在什么位置添加 Batch Normalization</h5><p>前面有一个典型的代码片段：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_vgg_conv2d</span><span class="params">(inputs, filters, kernel_size)</span>:</span></span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## call relu after batch normalization</span></span><br><span class="line">                                   use_bias= <span class="keyword">False</span>,</span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">        outputs = tf.nn.relu(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>
<p>这里容易遇到一个陷进，我之前就掉进去过。在看其他代码和资料的时候，也经常看到 convolution + batch_normalization + relu 这种顺序的代码调用，如果理解的不透彻，很有可能会错误的认为在每一个 convolution layer 的后面都应该添加一个 tf.layers.batch_normalization 调用，但是实际上，如果当前 layer 已经是网络结构中最后的 layer 或者已经属于 output layer 了，其实是不应该再使用 Batch Normalization 的。按照定义，是在 layer 的 <strong><em>input</em></strong> 部分添加 Batch Normalization，而代码里看上去像是在 layer 的 output 上调用了一次 Batch Normalization，这只是为了在代码里让 layer 更容易连接起来，而且，如果是第一层 layer，它的输入就是已经归一化处理过的 input label 数据，这也是不需要 Batch Normalization 的，到了最后一层 layer 的时候，理论上来说是需要 Batch Normalization 的，只不过对应到代码上，最后这层 layer 的 Batch Normalization 是添加在倒数第二层 layer 的输出结果上的。所以，在前面 HED 的代码里，_dsn_deconv2d_with_upsample_factor 和 _output_1x1_conv2d 这两种 layer 的封装函数里都是没有 Batch Normalization 的。  </p>
<p>另外，之前展示的代码都是把 batch_normalization 放在了 relu 激活函数的前面，网上的很多代码也是这样写的，其实把 batch_normalization 放在非线性函数的后面也是可以的，而且整体的准确率可能还会有一点点提升，<a href="https://github.com/ducha-aiki/caffenet-benchmark/blob/master/batchnorm.md#bn----before-or-after-relu" target="_blank" rel="noopener">BN – before or after ReLU?</a> 这里有一个简单的数据对比，可以参考。总之，batch_normalization 和激活函数的先后顺序，是可以灵活选择的。</p>
<h5 id="是否还需要使用-Regularizer"><a href="#是否还需要使用-Regularizer" class="headerlink" title="是否还需要使用 Regularizer"></a>是否还需要使用 Regularizer</h5><p>这也是一个容易混淆的地方，其实 Batch Normalization 和 Regularizer 是完全不一样的东西，Batch Normalization 针对的是 layer 的<em>输入数据</em>，而 Regularizer 针对的是 layer 里面的<em>权重矩阵</em>，前者是从数据层面来改善模型的效果，而后者则是通过改善模型自身来提升模型的效果，这两种技术是不冲突的，可以同时使用。</p>
<h3 id="从卷积运算到各种卷积层"><a href="#从卷积运算到各种卷积层" class="headerlink" title="从卷积运算到各种卷积层"></a>从卷积运算到各种卷积层</h3><h5 id="卷积运算"><a href="#卷积运算" class="headerlink" title="卷积运算"></a>卷积运算</h5><p>关于卷积的基本概念，<a href="https://github.com/vdumoulin/conv_arithmetic" target="_blank" rel="noopener">A technical report on convolution arithmetic in the context of deep learning</a> 这里有很直观的动画演示，比如下面这种就是最常见的卷积运算：</p>
<div align="center"><br><img src="/images/same_padding_no_strides_transposed.gif" alt="same padding no strides transposed"><br></div>

<p>其他的学习资料里，通常也是基于一个普通的二维矩阵来描述卷积的运算规则，上图这个例子，就是在一个 shape 为 (height, width) 的矩阵上，使用一个 (3, 3) 的卷积核，然后得到一个 shape 同样为 (height, width) 的矩阵。  </p>
<p>但是在神经网络领域里面，<strong><em>卷积层</em></strong> 的运算规则其实是比上面这种单纯的 <strong><em>卷积运算</em></strong> 稍微更复杂一些的。在神经网络里面，通常会使用一个 shape 为 (batch_size, height, width, channels) 的 Tensor 来表示图像，比如一个 RGBA 的图像，channels 就是 4，经过某种卷积层的运算后，得到一个新的 Tensor，这个新的 Tensor 的 channels 通常又会变成另外一个数值，可见，这个 channel 也是有一定的映射规则的，标准的卷积运算和 channel 结合起来，才构成了神经网络里面的卷积层。</p>
<p>在介绍具体的卷积层之前，先使用下面这种简单的示意图来表示一个卷积运算：</p>
<div align="center"><br><img src="/images/convolution_operation.png" alt="convolution operation"><br></div>

<p>顺着示意图中箭头的方向，左侧是输入矩阵，中间是卷积核，右侧是输出矩阵。</p>
<h5 id="标准卷积层"><a href="#标准卷积层" class="headerlink" title="标准卷积层"></a>标准卷积层</h5><p>TensorFlow 框架里的标准卷积层的定义如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.conv2d(  </span><br><span class="line">    input,  </span><br><span class="line">    filter,</span><br><span class="line">    strides,</span><br><span class="line">    padding,</span><br><span class="line">    use_cudnn_on_gpu=<span class="keyword">True</span>,</span><br><span class="line">    data_format=<span class="string">'NHWC'</span>,</span><br><span class="line">    dilations=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],</span><br><span class="line">    name=<span class="keyword">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>因为这里主要是为了讨论 channel 的映射规则，所以假设采用 ‘SAME’ padding，并且 strides 设置为 1，这样的话，输入的 Tensor 和 输出的 Tensor 中，height 和 width 都是相同的值，输入的 Tensor 的 shape 是 (batch_size, height, width, in_channels)，如果期望的输出 Tensor 的 shape 是 (batch_size, height, width, out_channels)，则作为 filter 的 Tensor 的 shape 应该设置成 (filter_height, filter_width, in_channels, out_channels)，其中的 filter_height 和 filter_width 就对应卷积核的 size，这个函数内部的完整计算过程，可以用下面这个示意图来表示：  </p>
<div align="center"><br><img src="/images/conv2d.png" alt="conv2d"><br></div>

<p>图中的 in_channels 等于 2，out_channels 等于 5，总共有 in_channels*out_channels = 10 个卷积核(同时还有 5 次矩阵加法操作)，仔细看一下这个示意图就会意识到，每一个输出的矩阵都是由两个输入矩阵共同计算出来的，也就是说不同的输入 channel 会一起影响到每一个输出 channel，通道之间是有关联的。</p>
<h5 id="One-By-One-卷积层"><a href="#One-By-One-卷积层" class="headerlink" title="One By One 卷积层"></a>One By One 卷积层</h5><p>这种网络结构和前面介绍的标准卷积层其实是一样的，只不过 filter 的 shape 是 (1, 1, in_channels, out_channels)，也就是说每一个卷积核都只是一个标量值，而非矩阵。表面上看这种结构有点违反『套路』，因为卷积的目的就是要利用周围像素的 <em>加权和</em> 来替代原始位置上的单个像素，或者说卷积每次关注的是一个区域的像素，而非只关注单个像素。</p>
<p>那 1x1 convolution 的目的是什么呢？前面已经提到了，神经网络里面的卷积层，既有卷积运算，也有 channel 之间的运算，所以 1x1 convolution 的重点就在于让不同的 channel 再结合一遍。类似的，也可以用一个简单的示意图表示这种网络结构：</p>
<div align="center"><br><img src="/images/one_by_one_conv2d.png" alt="one_by_one_conv2d"><br></div>

<p>1x1 convolution 的效果，相当于对输入矩阵做了一个简单的标量乘法，它的参数量和计算量都比标准的卷积层少了很多。前面 HED 代码里的 _output_1x1_conv2d 就是一个 1x1 convolution，在后面的讨论中也会遇到多个例子。</p>
<h5 id="Depthwise-卷积层"><a href="#Depthwise-卷积层" class="headerlink" title="Depthwise 卷积层"></a>Depthwise 卷积层</h5><p>标准卷积层运算，不同的输入 channel 会共同参与计算每一个输出 channel，还有另外一种名为 depthwise convolution 的卷积层运算，channel 之间是完全独立的，TensorFlow 里面的定义如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.depthwise_conv2d(</span><br><span class="line">    input,</span><br><span class="line">    filter,</span><br><span class="line">    strides,</span><br><span class="line">    padding,</span><br><span class="line">    rate=<span class="keyword">None</span>,</span><br><span class="line">    name=<span class="keyword">None</span>,</span><br><span class="line">    data_format=<span class="keyword">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>类似的，假设采用 ‘SAME’ padding，并且 strides 设置为 1，最后的三个参数使用默认值，这样的话，输入 Tensor 和 输出 Tensor 的 height 和 width 就会是相同的值，输入的 Tensor 的 shape 是 (batch_size, height, width, in_channels)，filter Tensor 的 shape 是 (filter_height, filter_width, in_channels, channel_multiplier)，则得到的输出 Tensor 的 shape 是 (batch_size, height, width, in_channels * channel_multiplier)，这个函数内部的完整计算过程，可以用下面这个示意图来表示： </p>
<div align="center"><br><img src="/images/depthwise_conv2d.png" alt="depthwise_conv2d"><br></div>

<p>可以看到，输出 Tensor 的 channels 不能是任意值，只能是 in_channels 的整数倍，这也就是参数 channel_multiplier 的含义。</p>
<h5 id="Separable-卷积层"><a href="#Separable-卷积层" class="headerlink" title="Separable 卷积层"></a>Separable 卷积层</h5><p>depthwise convolution 中，channel 之间是完全不会产生互相影响的，这可能也意味着这种方式的模型的复杂度是不够的，所以在实际使用的过程中，separable convolution 是一个更合适的选择，对应的 TensorFlow API 如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tf.nn.separable_conv2d(</span><br><span class="line">    input,</span><br><span class="line">    depthwise_filter,</span><br><span class="line">    pointwise_filter,</span><br><span class="line">    strides,</span><br><span class="line">    padding,</span><br><span class="line">    rate=<span class="keyword">None</span>,</span><br><span class="line">    name=<span class="keyword">None</span>,</span><br><span class="line">    data_format=<span class="keyword">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>同样的，采用 ‘SAME’ padding，并且 strides 设置为 1，最后的三个参数使用默认值，这样的话，输入 Tensor 和 输出 Tensor 的 height 和 width 就会是相同的值。这个 API 的内部首先执行了一次 depthwise convolution，然后执行了一次 1x1 convolution(pointwise convolution)，所以 depthwise_filter 的 shape 应该设置为 (filter_height, filter_width, in_channels, channel_multiplier)，pointwise_filter 的 shape 应该设置为 (1, 1, channel_multiplier * in_channels, out_channels)，示意图如下：</p>
<div align="center"><br><img src="/images/separable_conv2d.png" alt="separable_conv2d"><br></div>

<p>在使用相同的 in_channels 和 out_channels 参数时，tf.nn.separable_conv2d 的运算量会比 tf.nn.conv2d 更小。</p>
<h3 id="Dilated-Convolutions-Atrous-Convolution-扩张卷积-空洞卷积"><a href="#Dilated-Convolutions-Atrous-Convolution-扩张卷积-空洞卷积" class="headerlink" title="Dilated Convolutions / Atrous Convolution / 扩张卷积 / 空洞卷积"></a>Dilated Convolutions / Atrous Convolution / 扩张卷积 / 空洞卷积</h3><p>前面看到的几种不同的卷积层函数里，可能会有一个参数 rate，如果设置了 rate 并且 rate &gt; 1，则内部执行了另外一种名为 Dilated Convolutions 的卷积运算操作，这种卷积运算的动画示意图如下：</p>
<div align="center"><br><img src="/images/dilation.gif" alt="dilation"><br></div>

<p>在做边缘检测任务的时候，并没有用到 Dilated Convolutions，但是这种卷积操作也是很常用的，比如在 <a href="http://hellodfan.com/2018/03/11/%E8%AF%AD%E4%B9%89%E5%88%86%E5%89%B2%E8%AE%BA%E6%96%87-DeepLabv3+/" target="_blank" rel="noopener">DeepLab</a> 网络结构的各个版本中，它都是一个很重要的组件，考虑到这篇文章里已经汇总了多种不同的常用卷积操作，出于完整性的考虑，所以也简单提及一下 Atrous Convolution，有兴趣的同学可以进一步深入了解。</p>
<h3 id="转置卷积-反卷积的初始化"><a href="#转置卷积-反卷积的初始化" class="headerlink" title="转置卷积/反卷积的初始化"></a>转置卷积/反卷积的初始化</h3><p>HED 网络中是会用到转置卷积层的，简单回忆一下，transposed convolution 的动画示意图如下：</p>
<div align="center"><br><img src="/images/no_padding_no_strides_transposed.gif" alt="no_padding_no_strides_transposed"><br></div>

<p>前一篇文章里提到过，当时是使用了双线性放大矩阵(bilinear upsampling kernel)来对反卷积的 kernel 进行的初始化，因为 FCN 要求采用这种初始化方案(HED 的论文中并没有明确的要求使用双线性初始化)。这次重写代码的时候，转置卷积层也统一替换成了 Xavier initialization，仍然能够得到很好的训练效果，同时也严格参照了 HED 的<a href="https://github.com/s9xie/hed/blob/master/examples/hed/train_val.prototxt" target="_blank" rel="noopener">参考代码</a>对转置卷积层的 kernel size 进行设置，具体的参数都在前面的函数 _dsn_deconv2d_with_upsample_factor 里面。</p>
<p>如何初始化 transposed convolution 的卷积核，这个问题其实纠结了很长时间，而且在前一个版本的 HED 的代码中，也尝试过用 tf.truncated_normal 初始化 transposed convolution 的 kernel，当时的确是没有训练出想要的效果，所以有点迷信『双线性初始化』，后来在做 UNet 网络的时候，因为已经接触到 Xavier initialization 方案了，所以也尝试了用 Xavier 对反卷积的 kernel 进行初始化，得到的效果很好，所以才开始慢慢的不再强求于『双线性初始化』。</p>
<p>Google 了很多文章，仍然没有找到关于『双线性初始化』的权威解释，只是找到过一些零星的线索，比如有些模型里，会把 deconvolution 的 kernel 的 learning rate 设置为 0，同时采用双线性插值矩阵对该 kernel 进行初始化，相当于就是通过双线性插值算法对输入矩阵进行上采样(放大)。目前我个人的准则就是，除非论文中有明确的强调要采用某种特殊的初始化方法，否则还是首先使用常规的 Tensor 初始化方案。这篇文章的读者朋友们，如果对这个问题有更清晰的答案，也请指教一下，谢谢~</p>
<p>顺便再举个例子，<a href="https://distill.pub/2016/deconv-checkerboard/" target="_blank" rel="noopener">Deconvolution and Checkerboard Artifacts</a> 这里就是用 resize-convolution 替代了常规的 deconvolution。</p>
<h3 id="从-VGG-到-ResNet、Inception、Xception"><a href="#从-VGG-到-ResNet、Inception、Xception" class="headerlink" title="从 VGG 到 ResNet、Inception、Xception"></a>从 VGG 到 ResNet、Inception、Xception</h3><p>前面着重介绍了几种不同的卷积层运算方式，目的就是为了引出这篇文章 <a href="https://towardsdatascience.com/an-intuitive-guide-to-deep-network-architectures-65fdc477db41" target="_blank" rel="noopener">An Intuitive Guide to Deep Network Architectures</a>。VGG 作为一个经典的分类网络模型，它的结构其实是很简单的，就是标准卷积层串联在一起，如果想进一步提高 VGG 网络的准确率，一个比较直观的想法就是串联更多的标准卷积层(让网络变得更深)、在每一层里增加更多的卷积核，想法看上去是对的，但是实际的效果很不好，因为这种方式增加了大量的参数，训练起来自然就更难，而且网络的深度加深后，还会引起一个 <strong><em><a href="https://www.zhihu.com/question/49812013" target="_blank" rel="noopener">梯度消失</a></em></strong> 的问题，所以简单粗暴并不总是有效的，需要想其他的办法。前面给出链接的这篇文章里介绍的三个重要网络结构，ResNet、Inception 和 Xception，就是为了解决这些问题而发展起来的，这三种网络模型使用的 <strong><em>层结构</em></strong>，已经成为了卷积神经网络领域里面的基础技术手段。</p>
<p>关于 ResNet、Inception、Xception 的详细内容，刚才提到的这篇文章就是一个很好的总结，网上也有一份整理过的中文翻译 <a href="https://www.jiqizhixin.com/articles/2017-08-19-4" target="_blank" rel="noopener">无需数学背景，读懂 ResNet、Inception 和 Xception 三大变革性架构</a>，在文末的参考资料里面还会列出几篇很棒的文章或代码。</p>
<p>如果是我自己对这三种网络结构做一个简单的总结，我觉得主要是下面几点：  </p>
<ul>
<li>ResNet(残差网络) 使得训练更深的网络成为一种可能，既然很深的映射关系 Y = F(X) 不容易训练，那就改成训练 Y = F(X) + X，梯度消失问题就不再是一个障碍。</li>
<li>Inception 架构通过增加每一层网络的宽度(使用不同 size 的卷积核，按照卷积核的大小进行分组)来提高网络的准确性，同时为了控制整体的运算量，借助 1x1 convolution 先对每一层的输入 Tensor 进行一个降维操作，减少 input channel 的数量，然后再进入每一个分组，用不同大小的卷积核进行计算。</li>
<li>残差架构可以和分组策略结合，比如 Inception-ResNet 网络结构。</li>
<li>Inception 里面分组的概念使用到极致，就是让每一个通道成为一个独立的分组，在每个 channel 上先分别进行标准的卷积运算，然后再利用 1x1 convolution 得到最终的输出 channel，就其实就是 separable convolution。</li>
</ul>
<h3 id="从-MobileNet-V1-到-MobileNet-V2"><a href="#从-MobileNet-V1-到-MobileNet-V2" class="headerlink" title="从 MobileNet V1 到 MobileNet V2"></a>从 MobileNet V1 到 MobileNet V2</h3><p>ResNet、Inception、Xception 追求的目标，就是在达到更高的准确率的前提下，尽量在模型大小、模型运算速度、模型训练速度这几个指标之间找一个平衡点，如果在准确性上允许一定的损失，但是追求更小的模型和更快的速度，这就直接催生了 MobileNet 或类似的以手机端或嵌入式端为运行环境的网络结构的出现。</p>
<p><a href="https://arxiv.org/pdf/1704.04861.pdf" target="_blank" rel="noopener">MobileNet V1</a> 和 <a href="https://arxiv.org/pdf/1801.04381.pdf" target="_blank" rel="noopener">MobileNet V2</a> 都是基于 Depthwise Separable Convolution 构建的卷积层(类似 Xception，但是并不是和 Xception 使用的 Separable Convolution 完全一致)，这是它满足体积小、速度快的一个关键因素，另外就是精心设计和试验调优出来的层结构，下面就对照论文给出两个版本的代码实现。</p>
<h5 id="MobileNet-V1"><a href="#MobileNet-V1" class="headerlink" title="MobileNet V1"></a>MobileNet V1</h5><p>MobileNet V1 的整体结构其实并没有特别复杂的地方，和 VGG 类似，层和层之间就是普通的串联型的结构，有区别的地方主要在于 layer 的内部，如下图所示：</p>
<div align="center"><br><img src="/images/mobilenet_v1_layer_block.png" alt="mobilenet_v1_layer_block"><br></div>

<p>这个图中没有用箭头表示数据的传递方向，但是只要对卷积神经网络有初步的经验，就能看出来数据是从上往下传递的，左图是标准的卷积层操作，类似于前面 HED 网络中 _vgg_conv2d 函数的结构(回想一下前面说过的 Batch Normalization 和 relu 先后顺序的话题，虽然 Batch Normalization 可以放到激活函数的后面，但是很多论文里面都还是习惯性的放在激活函数的前面，所以这里的代码也会严格的遵照论文中的方式)，右侧的图相当于 separable convolution，但是在中间是有两次 Batch Normalization 的。</p>
<p>论文中用一张如下的表格来描述了整体结构：</p>
<div align="center"><br><img src="/images/mobilenet_v1_body_architecture.png" alt="mobilenet_v1_body_architecture"><br></div>

<p>下面是一份简单的代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mobilenet_v1</span><span class="params">(inputs, alpha, is_training)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> alpha <span class="keyword">not</span> <span class="keyword">in</span> [<span class="number">0.25</span>, <span class="number">0.50</span>, <span class="number">0.75</span>, <span class="number">1.0</span>]:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">'alpha must be one of'</span></span><br><span class="line">                         <span class="string">'`0.25`, `0.50`, `0.75` or `1.0` only.'</span>)</span><br><span class="line"></span><br><span class="line">    filter_initializer = tf.contrib.layers.xavier_initializer()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_conv2d</span><span class="params">(inputs, filters, kernel_size, stride, scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                    filters, </span><br><span class="line">                                    kernel_size, </span><br><span class="line">                                    strides=(stride, stride),</span><br><span class="line">                                    padding=<span class="string">'same'</span>, </span><br><span class="line">                                    activation=<span class="keyword">None</span>,</span><br><span class="line">                                    use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                    kernel_initializer=filter_initializer)</span><br><span class="line"></span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">            outputs = tf.nn.relu(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_mobilenet_v1_conv2d</span><span class="params">(inputs, </span></span></span><br><span class="line"><span class="function"><span class="params">                          pointwise_conv_filters, </span></span></span><br><span class="line"><span class="function"><span class="params">                          depthwise_conv_kernel_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                          stride, # stride is just for depthwise convolution</span></span></span><br><span class="line"><span class="function"><span class="params">                          scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'depthwise_conv'</span>):</span><br><span class="line">                <span class="string">'''</span></span><br><span class="line"><span class="string">                tf.layers Module 里面有一个 tf.layers.separable_conv2d 函数，</span></span><br><span class="line"><span class="string">                但是它的内部调用流程是 depthwise convolution --&gt; pointwise convolution --&gt; activation func，</span></span><br><span class="line"><span class="string">                而 MobileNet V1 风格的卷积层的内部调用流程应该是</span></span><br><span class="line"><span class="string">                depthwise conv --&gt; batch norm --&gt; relu --&gt; pointwise conv --&gt; batch norm --&gt; relu，</span></span><br><span class="line"><span class="string">                所以需要用其他的手段组装出想要的调用流程，</span></span><br><span class="line"><span class="string">                一种办法是使用 tf.nn.depthwise_conv2d，但是这个 API 比较底层，代码写起来很笨重。</span></span><br><span class="line"><span class="string">                后来找到了另外一种可行的办法，借助 tf.contrib.layers.separable_conv2d 函数，</span></span><br><span class="line"><span class="string">                tf.contrib.layers.separable_conv2d 的第二个参数 num_outputs 如果设置为 None，</span></span><br><span class="line"><span class="string">                则只会调用内部的 depthwise conv2d 部分，而不执行 pointwise conv2d 部分。</span></span><br><span class="line"><span class="string">                这样就可以组装出 MobileNet V1 需要的 layer 结构了。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                TensorFlow 提供了四种 API，都命名为 separable_conv2d，但是又存在各种细微的差别，</span></span><br><span class="line"><span class="string">                有兴趣的读者可以自行阅读相关文档</span></span><br><span class="line"><span class="string">                tf.contrib.layers.separable_conv2d [Aliases tf.contrib.layers.separable_convolution2d]</span></span><br><span class="line"><span class="string">                VS</span></span><br><span class="line"><span class="string">                tf.keras.backend.separable_conv2d</span></span><br><span class="line"><span class="string">                VS</span></span><br><span class="line"><span class="string">                tf.layers.separable_conv2d</span></span><br><span class="line"><span class="string">                VS</span></span><br><span class="line"><span class="string">                tf.nn.separable_conv2d</span></span><br><span class="line"><span class="string">                '''</span></span><br><span class="line">                outputs = tf.contrib.layers.separable_conv2d(</span><br><span class="line">                            inputs,</span><br><span class="line">                            <span class="keyword">None</span>, <span class="comment"># ref https://github.com/tensorflow/models/blob/master/research/slim/nets/mobilenet_v1.py</span></span><br><span class="line">                            depthwise_conv_kernel_size,</span><br><span class="line">                            depth_multiplier=<span class="number">1</span>, <span class="comment"># 按照论文的描述，这里设置成1</span></span><br><span class="line">                            stride=(stride, stride),</span><br><span class="line">                            padding=<span class="string">'SAME'</span>,</span><br><span class="line">                            activation_fn=<span class="keyword">None</span>,</span><br><span class="line">                            weights_initializer=filter_initializer,</span><br><span class="line">                            biases_initializer=<span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">                outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">                outputs = tf.nn.relu(outputs)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'pointwise_conv'</span>):</span><br><span class="line">                <span class="comment"># 论文中 alpha 参数的含义，就是在每一层的 pointwise conv 的位置按比例缩小输出 channels 的数量</span></span><br><span class="line">                pointwise_conv_filters = int(pointwise_conv_filters * alpha)</span><br><span class="line">                outputs = tf.layers.conv2d(outputs,</span><br><span class="line">                                        pointwise_conv_filters,</span><br><span class="line">                                        (<span class="number">1</span>, <span class="number">1</span>), </span><br><span class="line">                                        padding=<span class="string">'same'</span>, </span><br><span class="line">                                        activation=<span class="keyword">None</span>,</span><br><span class="line">                                        use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                        kernel_initializer=filter_initializer)</span><br><span class="line"></span><br><span class="line">                outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">                outputs = tf.nn.relu(outputs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_avg_pool2d</span><span class="params">(inputs, scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        inputs_shape = inputs.get_shape().as_list()</span><br><span class="line">        <span class="keyword">assert</span> len(inputs_shape) == <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        pool_height = inputs_shape[<span class="number">1</span>]</span><br><span class="line">        pool_width = inputs_shape[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            outputs = tf.layers.average_pooling2d(inputs,</span><br><span class="line">                                      [pool_height, pool_width],</span><br><span class="line">                                      strides=(<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">                                      padding=<span class="string">'valid'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    执行分类任务的网络结构，通常还可以作为实现其他任务的网络结构的 base architecture，</span></span><br><span class="line"><span class="string">    为了方便代码复用，这里只需要实现出卷积层构成的主体部分，</span></span><br><span class="line"><span class="string">    外部调用者根据各自的需求使用这里返回的 output 和 end_points。</span></span><br><span class="line"><span class="string">    比如对于分类任务，按照如下方式使用这个函数</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    image_height = 224</span></span><br><span class="line"><span class="string">    image_width = 224</span></span><br><span class="line"><span class="string">    image_channels = 3</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    x = tf.placeholder(tf.float32, [None, image_height, image_width, image_channels])</span></span><br><span class="line"><span class="string">    is_training = tf.placeholder(tf.bool, name='is_training')</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    output, net = mobilenet_v1(x, 1.0, is_training)</span></span><br><span class="line"><span class="string">    print('output shape is: %r' % (output.get_shape().as_list()))</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    output = tf.layers.flatten(output)</span></span><br><span class="line"><span class="string">    output = tf.layers.dense(output,</span></span><br><span class="line"><span class="string">                        units=1024, # 1024 class</span></span><br><span class="line"><span class="string">                        activation=None,</span></span><br><span class="line"><span class="string">                        use_bias=True,</span></span><br><span class="line"><span class="string">                        kernel_initializer=tf.contrib.layers.xavier_initializer())</span></span><br><span class="line"><span class="string">    print('output shape is: %r' % (output.get_shape().as_list()))</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">'mobilenet'</span>, <span class="string">'mobilenet'</span>, [inputs]):</span><br><span class="line">        end_points = &#123;&#125;</span><br><span class="line">        net = inputs </span><br><span class="line"></span><br><span class="line">        net = _conv2d(net, <span class="number">32</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block0'</span>)</span><br><span class="line">        end_points[<span class="string">'block0'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">64</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block1'</span>)</span><br><span class="line">        end_points[<span class="string">'block1'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">128</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block2'</span>)</span><br><span class="line">        end_points[<span class="string">'block2'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">128</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block3'</span>)</span><br><span class="line">        end_points[<span class="string">'block3'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">256</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block4'</span>)</span><br><span class="line">        end_points[<span class="string">'block4'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">256</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block5'</span>)</span><br><span class="line">        end_points[<span class="string">'block5'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block6'</span>)</span><br><span class="line">        end_points[<span class="string">'block6'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block7'</span>)</span><br><span class="line">        end_points[<span class="string">'block7'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block8'</span>)</span><br><span class="line">        end_points[<span class="string">'block8'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block9'</span>)</span><br><span class="line">        end_points[<span class="string">'block9'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block10'</span>)</span><br><span class="line">        end_points[<span class="string">'block10'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">512</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block11'</span>)</span><br><span class="line">        end_points[<span class="string">'block11'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">1024</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block12'</span>)</span><br><span class="line">        end_points[<span class="string">'block12'</span>] = net</span><br><span class="line">        net = _mobilenet_v1_conv2d(net, <span class="number">1024</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block13'</span>)</span><br><span class="line">        end_points[<span class="string">'block13'</span>] = net</span><br><span class="line"></span><br><span class="line">        output = _avg_pool2d(net, scope=<span class="string">'output'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> output, end_points</span><br></pre></td></tr></table></figure>
<h5 id="MobileNet-V2"><a href="#MobileNet-V2" class="headerlink" title="MobileNet V2"></a>MobileNet V2</h5><p>MobileNet V2 的改动就比较大了，首先引入了两种新的 layer 结构，如下图所示：</p>
<div align="center"><br><img src="/images/mobilenet_v2_layer_block.png" alt="mobilenet_v2_layer_block"><br></div>

<p>很明显的一个差异点，就是左边这种层结构引入了残差网络的手段，另外，这两种层结构中，在 depthwise convolution 之前又添加了一个 1x1 convolution 操作，在之前举得几个例子中，1x1 convolution 都是用来降维的，而在 MobileNet V2 里，这个位于 depthwise convolution 之前的 1x1 convolution 其实用来提升维度的，对应论文中 <strong><em>expansion factor</em></strong> 参数的含义，在 depthwise convolution 之后仍然还有一次 1x1 convolution 调用，但是这个 1x1 convolution 并不会跟随一个激活函数，只是一次线性变换，所以这里也不叫做 pointwise convolution，而是对应论文中的 1x1 projection convolution。</p>
<p>网络的整体结构由下面的表格描述：</p>
<div align="center"><br><img src="/images/mobilenet_v2_body_architecture.png" alt="mobilenet_v2_body_architecture"><br></div>

<p>代码实现如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mobilenet_v2_func_blocks</span><span class="params">(is_training)</span>:</span></span><br><span class="line">    filter_initializer = tf.contrib.layers.xavier_initializer()</span><br><span class="line">    activation_func = tf.nn.relu6</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">conv2d</span><span class="params">(inputs, filters, kernel_size, stride, scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            <span class="keyword">with</span> tf.variable_scope(<span class="string">'conv2d'</span>):</span><br><span class="line">                outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                        filters, </span><br><span class="line">                                        kernel_size, </span><br><span class="line">                                        strides=(stride, stride),</span><br><span class="line">                                        padding=<span class="string">'same'</span>, </span><br><span class="line">                                        activation=<span class="keyword">None</span>,</span><br><span class="line">                                        use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                        kernel_initializer=filter_initializer)</span><br><span class="line">                                        </span><br><span class="line">                outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">                outputs = tf.nn.relu(outputs)</span><br><span class="line">            <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_1x1_conv2d</span><span class="params">(inputs, filters, stride)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'1x1_conv2d'</span>):</span><br><span class="line">            outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                    filters, </span><br><span class="line">                                    kernel_size, </span><br><span class="line">                                    strides=(stride, stride),</span><br><span class="line">                                    padding=<span class="string">'same'</span>, </span><br><span class="line">                                    activation=<span class="keyword">None</span>,</span><br><span class="line">                                    use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                    kernel_initializer=filter_initializer)</span><br><span class="line">            </span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">            <span class="comment"># no activation_func</span></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">expansion_conv2d</span><span class="params">(inputs, expansion, stride)</span>:</span></span><br><span class="line">        input_shape = inputs.get_shape().as_list()</span><br><span class="line">        <span class="keyword">assert</span> len(input_shape) == <span class="number">4</span></span><br><span class="line">        filters = input_shape[<span class="number">3</span>] * expansion</span><br><span class="line"></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'expansion_1x1_conv2d'</span>):</span><br><span class="line">            outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                    filters, </span><br><span class="line">                                    kernel_size, </span><br><span class="line">                                    strides=(stride, stride),</span><br><span class="line">                                    padding=<span class="string">'same'</span>, </span><br><span class="line">                                    activation=<span class="keyword">None</span>,</span><br><span class="line">                                    use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                    kernel_initializer=filter_initializer)</span><br><span class="line"></span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">            outputs = activation_func(outputs)</span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">projection_conv2d</span><span class="params">(inputs, filters, stride)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'projection_1x1_conv2d'</span>):</span><br><span class="line">            outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                    filters, </span><br><span class="line">                                    kernel_size, </span><br><span class="line">                                    strides=(stride, stride),</span><br><span class="line">                                    padding=<span class="string">'same'</span>, </span><br><span class="line">                                    activation=<span class="keyword">None</span>,</span><br><span class="line">                                    use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                    kernel_initializer=filter_initializer)</span><br><span class="line"></span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">            <span class="comment"># no activation_func</span></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">depthwise_conv2d</span><span class="params">(inputs, </span></span></span><br><span class="line"><span class="function"><span class="params">                        depthwise_conv_kernel_size,</span></span></span><br><span class="line"><span class="function"><span class="params">                        stride)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'depthwise_conv2d'</span>):</span><br><span class="line">            outputs = tf.contrib.layers.separable_conv2d(</span><br><span class="line">                        inputs,</span><br><span class="line">                        <span class="keyword">None</span>, <span class="comment"># https://github.com/tensorflow/models/blob/master/research/slim/nets/mobilenet_v1.py</span></span><br><span class="line">                        depthwise_conv_kernel_size,</span><br><span class="line">                        depth_multiplier=<span class="number">1</span>,</span><br><span class="line">                        stride=(stride, stride),</span><br><span class="line">                        padding=<span class="string">'SAME'</span>,</span><br><span class="line">                        activation_fn=<span class="keyword">None</span>,</span><br><span class="line">                        weights_initializer=filter_initializer,</span><br><span class="line">                        biases_initializer=<span class="keyword">None</span>) </span><br><span class="line"></span><br><span class="line">            outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">            outputs = activation_func(outputs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">avg_pool2d</span><span class="params">(inputs, scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        inputs_shape = inputs.get_shape().as_list()</span><br><span class="line">        <span class="keyword">assert</span> len(inputs_shape) == <span class="number">4</span></span><br><span class="line"></span><br><span class="line">        pool_height = inputs_shape[<span class="number">1</span>]</span><br><span class="line">        pool_width = inputs_shape[<span class="number">2</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            outputs = tf.layers.average_pooling2d(inputs,</span><br><span class="line">                                            [pool_height, pool_width],</span><br><span class="line">                                            strides=(<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">                                            padding=<span class="string">'valid'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inverted_residual_block</span><span class="params">(inputs, </span></span></span><br><span class="line"><span class="function"><span class="params">                            filters, </span></span></span><br><span class="line"><span class="function"><span class="params">                            stride, </span></span></span><br><span class="line"><span class="function"><span class="params">                            expansion=<span class="number">6</span>, </span></span></span><br><span class="line"><span class="function"><span class="params">                            scope=<span class="string">''</span>)</span>:</span></span><br><span class="line">        <span class="keyword">assert</span> stride == <span class="number">1</span> <span class="keyword">or</span> stride == <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        depthwise_conv_kernel_size = [<span class="number">3</span>, <span class="number">3</span>]</span><br><span class="line">        pointwise_conv_filters = filters</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(scope):</span><br><span class="line">            net = inputs</span><br><span class="line">            net = expansion_conv2d(net, expansion, stride=<span class="number">1</span>)</span><br><span class="line">            net = depthwise_conv2d(net, depthwise_conv_kernel_size, stride=stride)</span><br><span class="line">            net = projection_conv2d(net, pointwise_conv_filters, stride=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> stride == <span class="number">1</span>:</span><br><span class="line">                <span class="comment"># 如果 net.get_shape().as_list()[3] != inputs.get_shape().as_list()[3]</span></span><br><span class="line">                <span class="comment"># 借助一个 1x1 的卷积让他们的 channels 相等，然后才能相加</span></span><br><span class="line">                <span class="keyword">if</span> net.get_shape().as_list()[<span class="number">3</span>] != inputs.get_shape().as_list()[<span class="number">3</span>]:</span><br><span class="line">                    inputs = _1x1_conv2d(inputs, net.get_shape().as_list()[<span class="number">3</span>], stride=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                net = net + inputs</span><br><span class="line">                <span class="keyword">return</span> net</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># stride == 2</span></span><br><span class="line">                <span class="keyword">return</span> net</span><br><span class="line"></span><br><span class="line">    func_blocks = &#123;&#125;</span><br><span class="line">    func_blocks[<span class="string">'conv2d'</span>] = conv2d</span><br><span class="line">    func_blocks[<span class="string">'inverted_residual_block'</span>] = inverted_residual_block</span><br><span class="line">    func_blocks[<span class="string">'avg_pool2d'</span>] = avg_pool2d</span><br><span class="line">    func_blocks[<span class="string">'filter_initializer'</span>] = filter_initializer</span><br><span class="line">    func_blocks[<span class="string">'activation_func'</span>] = activation_func</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> func_blocks</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mobilenet_v2</span><span class="params">(inputs, is_training)</span>:</span></span><br><span class="line">    func_blocks = mobilenet_v2_func_blocks(is_training)</span><br><span class="line">    _conv2d = func_blocks[<span class="string">'conv2d'</span>] </span><br><span class="line">    _inverted_residual_block = func_blocks[<span class="string">'inverted_residual_block'</span>]</span><br><span class="line">    _avg_pool2d = func_blocks[<span class="string">'avg_pool2d'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">'mobilenet_v2'</span>, <span class="string">'mobilenet_v2'</span>, [inputs]):</span><br><span class="line">        end_points = &#123;&#125;</span><br><span class="line">        net = inputs </span><br><span class="line">    </span><br><span class="line">        net = _conv2d(net, <span class="number">32</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block0_0'</span>) <span class="comment"># size/2</span></span><br><span class="line">        end_points[<span class="string">'block0'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">16</span>, stride=<span class="number">1</span>, expansion=<span class="number">1</span>, scope=<span class="string">'block1_0'</span>)</span><br><span class="line">        end_points[<span class="string">'block1'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">24</span>, stride=<span class="number">2</span>, scope=<span class="string">'block2_0'</span>) <span class="comment"># size/4</span></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">24</span>, stride=<span class="number">1</span>, scope=<span class="string">'block2_1'</span>)</span><br><span class="line">        end_points[<span class="string">'block2'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">32</span>, stride=<span class="number">2</span>, scope=<span class="string">'block3_0'</span>) <span class="comment"># size/8</span></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">32</span>, stride=<span class="number">1</span>, scope=<span class="string">'block3_1'</span>) </span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">32</span>, stride=<span class="number">1</span>, scope=<span class="string">'block3_2'</span>)</span><br><span class="line">        end_points[<span class="string">'block3'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">2</span>, scope=<span class="string">'block4_0'</span>) <span class="comment"># size/16</span></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_1'</span>) </span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_2'</span>) </span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_3'</span>) </span><br><span class="line">        end_points[<span class="string">'block4'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">96</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_0'</span>) </span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">96</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_1'</span>)</span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">96</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_2'</span>)</span><br><span class="line">        end_points[<span class="string">'block5'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">160</span>, stride=<span class="number">2</span>, scope=<span class="string">'block6_0'</span>) <span class="comment"># size/32</span></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">160</span>, stride=<span class="number">1</span>, scope=<span class="string">'block6_1'</span>) </span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">160</span>, stride=<span class="number">1</span>, scope=<span class="string">'block6_2'</span>) </span><br><span class="line">        end_points[<span class="string">'block6'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _inverted_residual_block(net, <span class="number">320</span>, stride=<span class="number">1</span>, scope=<span class="string">'block7_0'</span>)</span><br><span class="line">        end_points[<span class="string">'block7'</span>] = net</span><br><span class="line"></span><br><span class="line">        net = _conv2d(net, <span class="number">1280</span>, [<span class="number">1</span>, <span class="number">1</span>], stride=<span class="number">1</span>, scope=<span class="string">'block8_0'</span>) </span><br><span class="line">        end_points[<span class="string">'block8'</span>] = net</span><br><span class="line"></span><br><span class="line">        output = _avg_pool2d(net, scope=<span class="string">'output'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output, end_points</span><br></pre></td></tr></table></figure>
<h3 id="MobileNet-V2-Style-HED"><a href="#MobileNet-V2-Style-HED" class="headerlink" title="MobileNet V2 Style HED"></a>MobileNet V2 Style HED</h3><p>原始的 HED 使用 VGG 作为基础网络结构来得到 <strong><em>feature maps</em></strong>，参照这种思路，可以把基础网络部分替换为 MobileNet V2，代码如下：  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mobilenet_v2_style_hed</span><span class="params">(inputs, batch_size, is_training)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> const.use_kernel_regularizer:</span><br><span class="line">        weights_regularizer = tf.contrib.layers.l2_regularizer(scale=<span class="number">0.0001</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        weights_regularizer = <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">####################################################</span></span><br><span class="line">    func_blocks = mobilenet_v2_func_blocks(is_training)</span><br><span class="line">    <span class="comment"># print('============ func_blocks are: %r' % func_blocks)</span></span><br><span class="line">    _conv2d = func_blocks[<span class="string">'conv2d'</span>] </span><br><span class="line">    _inverted_residual_block = func_blocks[<span class="string">'inverted_residual_block'</span>]</span><br><span class="line">    _avg_pool2d = func_blocks[<span class="string">'avg_pool2d'</span>]</span><br><span class="line">    filter_initializer = func_blocks[<span class="string">'filter_initializer'</span>]</span><br><span class="line">    activation_func = func_blocks[<span class="string">'activation_func'</span>]</span><br><span class="line">    <span class="comment">####################################################</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dsn_1x1_conv2d</span><span class="params">(inputs, filters)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                   use_bias=<span class="keyword">False</span>, </span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        outputs = tf.layers.batch_normalization(outputs, training=is_training)</span><br><span class="line">        <span class="comment">## no activation</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_output_1x1_conv2d</span><span class="params">(inputs, filters)</span>:</span></span><br><span class="line">        kernel_size = [<span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line">        outputs = tf.layers.conv2d(inputs,</span><br><span class="line">                                   filters,</span><br><span class="line">                                   kernel_size, </span><br><span class="line">                                   padding=<span class="string">'same'</span>, </span><br><span class="line">                                   activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                   use_bias=<span class="keyword">True</span>, <span class="comment">## use bias</span></span><br><span class="line">                                   kernel_initializer=filter_initializer,</span><br><span class="line">                                   kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        <span class="comment">## no batch normalization</span></span><br><span class="line">        <span class="comment">## no activation</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_dsn_deconv2d_with_upsample_factor</span><span class="params">(inputs, filters, upsample_factor)</span>:</span></span><br><span class="line">        <span class="comment">## https://github.com/s9xie/hed/blob/master/examples/hed/train_val.prototxt</span></span><br><span class="line">        <span class="comment">## 从这个原版代码里看，是这样计算 kernel_size 的</span></span><br><span class="line">        kernel_size = [<span class="number">2</span> * upsample_factor, <span class="number">2</span> * upsample_factor]</span><br><span class="line">        outputs = tf.layers.conv2d_transpose(inputs,</span><br><span class="line">                                             filters, </span><br><span class="line">                                             kernel_size, </span><br><span class="line">                                             strides=(upsample_factor, upsample_factor), </span><br><span class="line">                                             padding=<span class="string">'same'</span>, </span><br><span class="line">                                             activation=<span class="keyword">None</span>, <span class="comment">## no activation</span></span><br><span class="line">                                             use_bias=<span class="keyword">True</span>, <span class="comment">## use bias</span></span><br><span class="line">                                             kernel_initializer=filter_initializer,</span><br><span class="line">                                             kernel_regularizer=weights_regularizer)</span><br><span class="line"></span><br><span class="line">        <span class="comment">## 概念上来说，deconv2d 已经是最后的输出 layer 了，只不过最后还有一步 1x1 的 conv2d 把 5 个 deconv2d 的输出再融合到一起</span></span><br><span class="line">        <span class="comment">## 所以不需要再使用 batch normalization 了</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">'hed'</span>, <span class="string">'hed'</span>, [inputs]):</span><br><span class="line">        end_points = &#123;&#125;</span><br><span class="line">        net = inputs</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">## mobilenet v2 as base net</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'mobilenet_v2'</span>):</span><br><span class="line">            <span class="comment"># 标准的 mobilenet v2 里面并没有这两层，</span></span><br><span class="line">            <span class="comment"># 这里是为了得到和 input image 相同 size 的 feature map 而增加的层</span></span><br><span class="line">            net = _conv2d(net, <span class="number">3</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block0_0'</span>)</span><br><span class="line">            net = _conv2d(net, <span class="number">6</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">1</span>, scope=<span class="string">'block0_1'</span>)</span><br><span class="line"></span><br><span class="line">            dsn1 = net</span><br><span class="line">            net = _conv2d(net, <span class="number">12</span>, [<span class="number">3</span>, <span class="number">3</span>], stride=<span class="number">2</span>, scope=<span class="string">'block0_2'</span>) <span class="comment"># size/2</span></span><br><span class="line"></span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">6</span>, stride=<span class="number">1</span>, expansion=<span class="number">1</span>, scope=<span class="string">'block1_0'</span>)</span><br><span class="line"></span><br><span class="line">            dsn2 = net</span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">12</span>, stride=<span class="number">2</span>, scope=<span class="string">'block2_0'</span>) <span class="comment"># size/4</span></span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">12</span>, stride=<span class="number">1</span>, scope=<span class="string">'block2_1'</span>)</span><br><span class="line"></span><br><span class="line">            dsn3 = net</span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">24</span>, stride=<span class="number">2</span>, scope=<span class="string">'block3_0'</span>) <span class="comment"># size/8</span></span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">24</span>, stride=<span class="number">1</span>, scope=<span class="string">'block3_1'</span>) </span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">24</span>, stride=<span class="number">1</span>, scope=<span class="string">'block3_2'</span>)</span><br><span class="line"></span><br><span class="line">            dsn4 = net</span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">48</span>, stride=<span class="number">2</span>, scope=<span class="string">'block4_0'</span>) <span class="comment"># size/16</span></span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">48</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_1'</span>) </span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">48</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_2'</span>) </span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">48</span>, stride=<span class="number">1</span>, scope=<span class="string">'block4_3'</span>) </span><br><span class="line"></span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_0'</span>) </span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_1'</span>)</span><br><span class="line">            net = _inverted_residual_block(net, <span class="number">64</span>, stride=<span class="number">1</span>, scope=<span class="string">'block5_2'</span>)</span><br><span class="line"></span><br><span class="line">            dsn5 = net</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">## dsn layers</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn1'</span>):</span><br><span class="line">            dsn1 = _dsn_1x1_conv2d(dsn1, <span class="number">1</span>)</span><br><span class="line">            <span class="comment">## no need deconv2d</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn2'</span>):</span><br><span class="line">            dsn2 = _dsn_1x1_conv2d(dsn2, <span class="number">1</span>)</span><br><span class="line">            dsn2 = _dsn_deconv2d_with_upsample_factor(dsn2, <span class="number">1</span>, upsample_factor = <span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn3'</span>):</span><br><span class="line">            dsn3 = _dsn_1x1_conv2d(dsn3, <span class="number">1</span>)</span><br><span class="line">            dsn3 = _dsn_deconv2d_with_upsample_factor(dsn3, <span class="number">1</span>, upsample_factor = <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn4'</span>):</span><br><span class="line">            dsn4 = _dsn_1x1_conv2d(dsn4, <span class="number">1</span>)</span><br><span class="line">            dsn4 = _dsn_deconv2d_with_upsample_factor(dsn4, <span class="number">1</span>, upsample_factor = <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn5'</span>):</span><br><span class="line">            dsn5 = _dsn_1x1_conv2d(dsn5, <span class="number">1</span>)</span><br><span class="line">            dsn5 = _dsn_deconv2d_with_upsample_factor(dsn5, <span class="number">1</span>, upsample_factor = <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># dsn fuse</span></span><br><span class="line">        <span class="keyword">with</span> tf.variable_scope(<span class="string">'dsn_fuse'</span>):</span><br><span class="line">            dsn_fuse = tf.concat([dsn1, dsn2, dsn3, dsn4, dsn5], <span class="number">3</span>)</span><br><span class="line">            dsn_fuse = _output_1x1_conv2d(dsn_fuse, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dsn_fuse, dsn1, dsn2, dsn3, dsn4, dsn5</span><br></pre></td></tr></table></figure>
<p>这个 MobileNet V2 风格的 HED 网络，整体结构和 VGG 风格的 HED 并没有区别，只是把 VGG 里面用到的卷积层操作替换成了 MobileNet V2 对应的卷积层，另外，因为 MobileNet V2 的第一个卷积层就设置了 stride=2，并不匹配 dsn1 层的 size，所以额外添加了两个 stride=1 的普通卷积层，把它们的输出作为 dsn1 层。</p>
<h3 id="MobileNet-V2-As-Base-Net"><a href="#MobileNet-V2-As-Base-Net" class="headerlink" title="MobileNet V2 As Base Net"></a>MobileNet V2 As Base Net</h3><p>MobileNet 只是针对手机运行环境设计出来的执行 <em>分类任务</em> 的网络结构，但是，和同样执行分类任务的 ResNet、Inception、Xception 这一类网络结构类似，都可以作为执行其他任务的网络结构的 base net，提取输入 image 的 feature maps，我尝试过 mobilenet_v2_style_unet、mobilenet_v2_style_deeplab_v3plus、mobilenet_v2_style_ssd，都是可以看到效果的。</p>
<h3 id="Android-性能瓶颈"><a href="#Android-性能瓶颈" class="headerlink" title="Android 性能瓶颈"></a>Android 性能瓶颈</h3><p>作为一个参考值，在 iPhone 7 Plus 上运行这个 mobilenet_v2_style_hed 网络并且执行后续的找点算法，FPS 可以跑到12，基本满足实时性的需求。但是当尝试在 Android 上部署的时候，即便是在高价位高配置的机型上，FPS 也很低，卡顿现象很明显。</p>
<p>经过排查，找到了一些线索。在 iPhone 7 Plus 上，计算量的分布如下图所示：</p>
<div align="center"><br><img src="/images/mobilenet_v2_hed_node_summary_ios.png" alt="mobilenet_v2_hed_node_summary_ios"><br></div>

<p>红框中的三种操作占据了大部分的 CPU 时间，用这几个数值做一个粗略估算，1.0 / (32 + 30 + 10 + 6) = 12.8，这和检测到的 FPS 是比较吻合的，说明大量的计算时间都用在神经网络上了，OpenCV 实现的找点算法的耗时是很短的。</p>
<p>但是在 Android 上，情况则完全不一样了，如下图所示：</p>
<div align="center"><br><img src="/images/mobilenet_v2_hed_node_summary_android_32.png" alt="mobilenet_v2_hed_node_summary_android_32"><br></div>

<p>用红框里的数值计算一下，FPS = 1.0 / (232 + 76 + 29 + 16) = 2.8，达不到实时的要求。从上图还可以看出，在 Android 上，Batch Normalization 消耗了大量的计算时间，而且和 Conv2D 消耗的 CPU 时间相比，不在一个数量级上了，这就和 iOS 平台上完全不是同一种分布规律了。进一步 debug 后发现，我们 Android 平台的 app，由于一些历史原因被限定住了只能使用 <em>32bit</em> 的 .so 动态库，换成 <em>64bit</em> 的 TensorFlow 动态库在独立的 demo app 里面重新测量，mobilenet_v2_style_hed 在 Android 上的运行情况就和 iOS 的接近了，虽然还是比 iOS 慢，但是 CPU 耗时的统计数据是同一种分布规律了。</p>
<p>所以，性能瓶颈就在于 Batch Normalization 在 <em>32bit</em> 的 ARM CPU 环境中执行效率不高，尝试过使用一些编译器优化选项重新编译 <em>32bit</em> 的 TensorFlow 库，但是并没有明显的改善。最后的解决方案是退而求其次，使用 vgg_style_hed，并且不使用 Batch Normalization，经过这样的调整后，Android 上的统计数据如下图：</p>
<div align="center"><br><img src="/images/vgg_hed_node_summary_android_32.png" alt="vgg_hed_node_summary_android_32"><br></div>

<h3 id="关于-TensorFlow-Lite"><a href="#关于-TensorFlow-Lite" class="headerlink" title="关于 TensorFlow Lite"></a>关于 TensorFlow Lite</h3><p>在使用 TensorFlow 1.7 部署模型的时候，TensorFlow Lite 还未支持 transposed convolution，所以没有使用 TF Lite (目前 github 上已经看到有 Lite 版本的 <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/contrib/lite/kernels/transpose_conv.cc" target="_blank" rel="noopener">transpose_conv.cc</a> 了)。TensorFlow Lite 目前发展的很快，以后在选择部署方案的时候，TensorFlow Lite 是优先于 TensorFlow Mobile 的。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><h5 id="xavier-init"><a href="#xavier-init" class="headerlink" title="xavier init"></a>xavier init</h5><p><a href="https://stackoverflow.com/questions/33640581/how-to-do-xavier-initialization-on-tensorflow/36784797" target="_blank" rel="noopener">How to do Xavier initialization on TensorFlow
</a><br><a href="https://zhuanlan.zhihu.com/p/25110150" target="_blank" rel="noopener">聊一聊深度学习的weight initialization</a></p>
<h5 id="Batch-Normalization-1"><a href="#Batch-Normalization-1" class="headerlink" title="Batch Normalization"></a>Batch Normalization</h5><p><a href="https://kratzert.github.io/2016/02/12/understanding-the-gradient-flow-through-the-batch-normalization-layer.html" target="_blank" rel="noopener">Understanding the backward pass through Batch Normalization Layer</a><br><a href="https://zhuanlan.zhihu.com/p/29974820" target="_blank" rel="noopener">机器学习里的黑色艺术：normalization, standardization, regularization</a><br><a href="https://stackoverflow.com/questions/33949786/how-could-i-use-batch-normalization-in-tensorflow" target="_blank" rel="noopener">How could I use Batch Normalization in TensorFlow?
</a><br><a href="https://github.com/keras-team/keras/issues/5465" target="_blank" rel="noopener">add Batch Normalization immediately before non-linearity or after in Keras?</a>  </p>
<h5 id="1x1-Convolution"><a href="#1x1-Convolution" class="headerlink" title="1x1 Convolution"></a>1x1 Convolution</h5><p><a href="https://stats.stackexchange.com/questions/194142/what-does-1x1-convolution-mean-in-a-neural-network." target="_blank" rel="noopener">What does 1x1 convolution mean in a neural network?</a><br><a href="https://datascience.stackexchange.com/questions/12830/how-are-1x1-convolutions-the-same-as-a-fully-connected-layer" target="_blank" rel="noopener">How are 1x1 convolutions the same as a fully connected layer?</a><br><a href="https://iamaaditya.github.io/2016/03/one-by-one-convolution/" target="_blank" rel="noopener">One by One [ 1 x 1 ] Convolution - counter-intuitively useful</a>  </p>
<h5 id="Upsampling-amp-amp-Transposed-Convolution"><a href="#Upsampling-amp-amp-Transposed-Convolution" class="headerlink" title="Upsampling &amp;&amp; Transposed Convolution"></a>Upsampling &amp;&amp; Transposed Convolution</h5><p><a href="http://warmspringwinds.github.io/tensorflow/tf-slim/2016/11/22/upsampling-and-image-segmentation-with-tensorflow-and-tf-slim/" target="_blank" rel="noopener">Upsampling and Image Segmentation with Tensorflow and TF-Slim</a><br><a href="http://cv-tricks.com/image-segmentation/transpose-convolution-in-tensorflow/" target="_blank" rel="noopener">Image Segmentation using deconvolution layer in Tensorflow</a>  </p>
<h5 id="ResNet-amp-amp-Inception-amp-amp-Xception"><a href="#ResNet-amp-amp-Inception-amp-amp-Xception" class="headerlink" title="ResNet &amp;&amp; Inception &amp;&amp; Xception"></a>ResNet &amp;&amp; Inception &amp;&amp; Xception</h5><p><a href="http://teleported.in/posts/network-in-network/" target="_blank" rel="noopener">Network In Network architecture: The beginning of Inception</a><br><a href="https://chatbotslife.com/resnets-highwaynets-and-densenets-oh-my-9bb15918ee32" target="_blank" rel="noopener">ResNets, HighwayNets, and DenseNets, Oh My!</a><br><a href="https://hacktilldawn.com/2016/09/25/inception-modules-explained-and-implemented/" target="_blank" rel="noopener">Inception modules: explained and implemented</a><br><a href="https://github.com/kwotsin/TensorFlow-Xception" target="_blank" rel="noopener">TensorFlow implementation of the Xception Model by François Chollet</a>  </p>
<h5 id="TensorFlow-Lite"><a href="#TensorFlow-Lite" class="headerlink" title="TensorFlow Lite"></a>TensorFlow Lite</h5><p><a href="http://developers.googleblog.cn/2018/06/tensorflow-lite-overview.html" target="_blank" rel="noopener">TensorFlow Lite 深度解析</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/08/Document-Scanning-With-TensorFlow-And-OpenCV/" itemprop="url">
                  手机端运行卷积神经网络的一次实践 -- 基于 TensorFlow 和 OpenCV 实现文档检测功能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-05-08T16:21:55+08:00" content="2017-05-08">
              2017-05-08
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/05/08/Document-Scanning-With-TensorFlow-And-OpenCV/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/05/08/Document-Scanning-With-TensorFlow-And-OpenCV/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="2018-06-02-update"><a href="#2018-06-02-update" class="headerlink" title="2018-06-02 update:"></a>2018-06-02 update:</h5><ul>
<li><em><em>这篇博客有一个后续更新版本，请看 <a href="http://fengjian0106.github.io/2018/06/02/Document-Scanning-With-TensorFlow-And-OpenCV-Part-Two/">手机端运行卷积神经网络实现文档检测功能(二) – 从 VGG 到 MobileNetV2 知识梳理</a></em></em>  </li>
<li><em><em>另外，代码也已开源放在 github 上，<a href="https://github.com/fengjian0106/hed-tutorial-for-document-scanning" target="_blank" rel="noopener">https://github.com/fengjian0106/hed-tutorial-for-document-scanning</a></em></em></li>
</ul>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><ul>
<li>本文不是神经网络或机器学习的入门教学，而是通过一个真实的产品案例，展示了在手机客户端上运行一个神经网络的关键技术点</li>
<li>在卷积神经网络适用的领域里，已经出现了一些很经典的图像分类网络，比如 VGG16/VGG19，Inception v1-v4 Net，ResNet 等，这些分类网络通常又都可以作为其他算法中的基础网络结构，尤其是 VGG 网络，被很多其他的算法借鉴，本文也会使用 VGG16 的基础网络结构，但是不会对 VGG 网络做详细的入门教学</li>
<li>虽然本文不是神经网络技术的入门教程，但是仍然会给出一系列的相关入门教程和技术文档的链接，有助于进一步理解本文的内容</li>
<li>具体使用到的神经网络算法，只是本文的一个组成部分，除此之外，本文还介绍了如何裁剪 TensorFlow 静态库以便于在手机端运行，如何准备训练样本图片，以及训练神经网络时的各种技巧等等</li>
</ul>
<h3 id="需求是什么"><a href="#需求是什么" class="headerlink" title="需求是什么"></a>需求是什么</h3><p><img src="/images/image_to_point.png" alt="image to point"></p>
<p>需求很容易描述清楚，如上图，就是在一张图里，把矩形形状的文档的四个顶点的坐标找出来。</p>
<h3 id="传统的技术方案"><a href="#传统的技术方案" class="headerlink" title="传统的技术方案"></a>传统的技术方案</h3><p>Google 搜索 opencv scan document，是可以找到好几篇相关的教程的，这些教程里面的技术手段，也都大同小异，关键步骤就是调用 OpenCV 里面的两个函数，cv2.Canny() 和 cv2.findContours()。</p>
<p><img src="/images/demo_method.png" alt="demo method"></p>
<p>看上去很容易就能实现出来，但是真实情况是，这些教程，仅仅是个 demo 演示而已，用来演示的图片，都是最理想的简单情况，真实的场景图片会比这个复杂的多，会有各种干扰因素，调用 canny 函数得到的边缘检测结果，也会比 demo 中的情况凌乱的多，比如会检测出很多各种长短的线段，或者是文档的边缘线被截断成了好几条短的线段，线段之间还存在距离不等的空隙。另外，findContours 函数也只能检测闭合的多边形的顶点，但是并不能确保这个多边形就是一个合理的矩形。因此在我们的第一版技术方案中，对这两个关键步骤，进行了大量的改进和调优，概括起来就是：</p>
<ul>
<li>改进 canny 算法的效果，增加额外的步骤，得到效果更好的边缘检测图</li>
<li>针对 canny 步骤得到的边缘图，建立一套数学算法，从边缘图中寻找出一个合理的矩形区域</li>
</ul>
<h3 id="传统技术方案的难度和局限性"><a href="#传统技术方案的难度和局限性" class="headerlink" title="传统技术方案的难度和局限性"></a>传统技术方案的难度和局限性</h3><ul>
<li>canny 算法的检测效果，依赖于几个阈值参数，这些阈值参数的选择，通常都是人为设置的经验值，在改进的过程中，引入额外的步骤后，通常又会引入一些新的阈值参数，同样，也是依赖于调试结果设置的经验值。整体来看，这些阈值参数的个数，不能特别的多，因为一旦太多了，就很难依赖经验值进行设置，另外，虽然有这些阈值参数，但是最终的参数只是一组或少数几组固定的组合，所以算法的鲁棒性又会打折扣，很容易遇到边缘检测效果不理想的场景</li>
<li>在边缘图上建立的数学模型很复杂，代码实现难度大，而且也会遇到算法无能为力的场景</li>
</ul>
<p>下面这张图表，能够很好的说明上面列出的这两个问题：</p>
<p><img src="/images/hed_vs_canny.png" alt="hed vs canny"></p>
<p>这张图表的第一列是输入的 image，最后的三列(先不用看这张图表的第二列)，是用三组不同阈值参数调用 canny 函数和额外的函数后得到的输出 image，可以看到，边缘检测的效果，并不总是很理想的，有些场景中，矩形的边，出现了很严重的断裂，有些边，甚至被完全擦除掉了，而另一些场景中，又会检测出很多干扰性质的长短边。可想而知，想用一个数学模型，适应这么不规则的边缘图，会是多么困难的一件事情。</p>
<h3 id="思考如何改善"><a href="#思考如何改善" class="headerlink" title="思考如何改善"></a>思考如何改善</h3><p>在第一版的技术方案中，负责的同学花费了大量的精力进行各种调优，终于取得了还不错的效果，但是，就像前面描述的那样，还是会遇到检测不出来的场景。在第一版技术方案中，遇到这种情况的时候，采用的做法是针对这些不能检测的场景，人工进行分析和调试，调整已有的一组阈值参数和算法，可能还需要加入一些其他的算法流程(可能还会引入新的一些阈值参数)，然后再整合到原有的代码逻辑中。经过若干轮这样的调整后，我们发现，已经进入一个瓶颈，按照这种手段，很难进一步提高检测效果了。</p>
<p>既然传统的算法手段已经到极限了，那不如试试机器学习/神经网络。</p>
<h3 id="无效的神经网络算法"><a href="#无效的神经网络算法" class="headerlink" title="无效的神经网络算法"></a>无效的神经网络算法</h3><h4 id="end-to-end-直接拟合"><a href="#end-to-end-直接拟合" class="headerlink" title="end-to-end 直接拟合"></a>end-to-end 直接拟合</h4><p>首先想到的，就是仿照人脸对齐(face alignment)的思路，构建一个端到端(end-to-end)的网络，直接回归拟合，也就是让这个神经网络直接输出 4 个顶点的坐标，但是，经过尝试后发现，根本拟合不出来。后来仔细琢磨了一下，觉得不能直接拟合也是对的，因为：</p>
<ul>
<li>除了分类(classification)问题之外，所有的需求看上去都像是一个回归(regression)问题，如果回归是万能的，学术界为啥还要去搞其他各种各样的网络模型</li>
<li>face alignment 之所以可以用回归网络得到很好的拟合效果，是因为在输入 image 上先做了 bounding box 检测，缩小了人脸图像范围后，才做的 regression</li>
<li>人脸上的关键特征点，具有特别明显的统计学特征，所以 regression 可以发挥作用</li>
<li>在需要更高检测精度的场景中，其实也是用到了更复杂的网络模型来解决 face alignment 问题的</li>
</ul>
<h4 id="YOLO-amp-amp-FCN"><a href="#YOLO-amp-amp-FCN" class="headerlink" title="YOLO &amp;&amp; FCN"></a>YOLO &amp;&amp; FCN</h4><p>后来还尝试过用 YOLO 网络做 Object Detection，用 FCN 网络做像素级的 Semantic Segmentation，但是结果都很不理想，比如：</p>
<ul>
<li>达不到文档检测功能想要的精确度</li>
<li>网络结构复杂，运算量大，在手机上无法做到实时检测</li>
</ul>
<h3 id="有效的神经网络算法"><a href="#有效的神经网络算法" class="headerlink" title="有效的神经网络算法"></a>有效的神经网络算法</h3><p>前面尝试的几种神经网络算法，都不能得到想要的效果，后来换了一种思路，既然传统的技术手段里包含了两个关键的步骤，那能不能用神经网络来分别改善这两个步骤呢，经过分析发现，可以尝试用神经网络来替换 canny 算法，也就是用神经网络来对图像中的矩形区域进行边缘检测，只要这个边缘检测能够去除更多的干扰因素，那第二个步骤里面的算法也就可以变得更简单了。</p>
<h4 id="神经网络的输入和输出"><a href="#神经网络的输入和输出" class="headerlink" title="神经网络的输入和输出"></a>神经网络的输入和输出</h4><p><img src="/images/image_to_edge.png" alt="image to edge"></p>
<p>按照这种思路，对于神经网络部分，现在的需求变成了上图所示的样子。</p>
<h4 id="HED-Holistically-Nested-Edge-Detection-网络"><a href="#HED-Holistically-Nested-Edge-Detection-网络" class="headerlink" title="HED(Holistically-Nested Edge Detection) 网络"></a>HED(Holistically-Nested Edge Detection) 网络</h4><p>边缘检测这种需求，在图像处理领域里面，通常叫做 Edge Detection 或 Contour Detection，按照这个思路，找到了 Holistically-Nested Edge Detection 网络模型。</p>
<p>HED 网络模型是在 VGG16 网络结构的基础上设计出来的，所以有必要先看看 VGG16。</p>
<p><img src="/images/vgg_detail.png" alt="vgg detail"></p>
<p>上图是 VGG16 的原理图，为了方便从 VGG16 过渡到 HED，我们先把 VGG16 变成下面这种示意图：</p>
<p><img src="/images/vgg_to_hed_1.png" alt="vgg to hed 1"></p>
<p>在上面这个示意图里，用不同的颜色区分了 VGG16 的不同组成部分。</p>
<p><img src="/images/vgg_to_hed_2.png" alt="vgg to hed 2"></p>
<p>从示意图上可以看到，绿色代表的卷积层和红色代表的池化层，可以很明显的划分出五组，上图用紫色线条框出来的就是其中的第三组。</p>
<p><img src="/images/vgg_to_hed_3.png" alt="vgg to hed 3"></p>
<p>HED 网络要使用的就是 VGG16 网络里面的这五组，后面部分的 fully connected 层和 softmax 层，都是不需要的，另外，第五组的池化层(红色)也是不需要的。</p>
<p><img src="/images/vgg_to_hed_4.png" alt="vgg to hed 4"></p>
<p>去掉不需要的部分后，就得到上图这样的网络结构，因为有池化层的作用，从第二组开始，每一组的输入 image 的长宽值，都是前一组的输入 image 的长宽值的一半。</p>
<p><img src="/images/vgg_to_hed_5.png" alt="vgg to hed 5"></p>
<p>HED 网络是一种多尺度多融合(multi-scale and multi-level feature learning)的网络结构，所谓的多尺度，就是如上图所示，把 VGG16 的每一组的最后一个卷积层(绿色部分)的输出取出来，因为每一组得到的 image 的长宽尺寸是不一样的，所以这里还需要用转置卷积(transposed convolution)/反卷积(deconv)对每一组得到的 image 再做一遍运算，从效果上看，相当于把第二至五组得到的 image 的长宽尺寸分别扩大 2 至 16 倍，这样在每个尺度(VGG16 的每一组就是一个尺度)上得到的 image，都是相同的大小了。</p>
<p><img src="/images/vgg_to_hed_6.png" alt="vgg to hed 6"></p>
<p>把每一个尺度上得到的相同大小的 image，再融合到一起，这样就得到了最终的输出 image，也就是具有边缘检测效果的 image。</p>
<p>基于 TensorFlow 编写的 HED 网络结构代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hed_net</span><span class="params">(inputs, batch_size)</span>:</span></span><br><span class="line">    <span class="comment"># ref https://github.com/s9xie/hed/blob/master/examples/hed/train_val.prototxt</span></span><br><span class="line">    <span class="keyword">with</span> tf.variable_scope(<span class="string">'hed'</span>, <span class="string">'hed'</span>, [inputs]):</span><br><span class="line">        <span class="keyword">with</span> slim.arg_scope([slim.conv2d, slim.fully_connected],</span><br><span class="line">                        activation_fn=tf.nn.relu,</span><br><span class="line">                        weights_initializer=tf.truncated_normal_initializer(<span class="number">0.0</span>, <span class="number">0.01</span>),</span><br><span class="line">                        weights_regularizer=slim.l2_regularizer(<span class="number">0.0005</span>)):</span><br><span class="line">            <span class="comment"># vgg16 conv &amp;&amp; max_pool layers</span></span><br><span class="line">            net = slim.repeat(inputs, <span class="number">2</span>, slim.conv2d, <span class="number">12</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv1'</span>)</span><br><span class="line">            dsn1 = net</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>], scope=<span class="string">'pool1'</span>)</span><br><span class="line"></span><br><span class="line">            net = slim.repeat(net, <span class="number">2</span>, slim.conv2d, <span class="number">24</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv2'</span>)</span><br><span class="line">            dsn2 = net</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>], scope=<span class="string">'pool2'</span>)</span><br><span class="line"></span><br><span class="line">            net = slim.repeat(net, <span class="number">3</span>, slim.conv2d, <span class="number">48</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv3'</span>)</span><br><span class="line">            dsn3 = net</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>], scope=<span class="string">'pool3'</span>)</span><br><span class="line"></span><br><span class="line">            net = slim.repeat(net, <span class="number">3</span>, slim.conv2d, <span class="number">96</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv4'</span>)</span><br><span class="line">            dsn4 = net</span><br><span class="line">            net = slim.max_pool2d(net, [<span class="number">2</span>, <span class="number">2</span>], scope=<span class="string">'pool4'</span>)</span><br><span class="line"></span><br><span class="line">            net = slim.repeat(net, <span class="number">3</span>, slim.conv2d, <span class="number">192</span>, [<span class="number">3</span>, <span class="number">3</span>], scope=<span class="string">'conv5'</span>)</span><br><span class="line">            dsn5 = net</span><br><span class="line">            <span class="comment"># net = slim.max_pool2d(net, [2, 2], scope='pool5') # no need this pool layer</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># dsn layers</span></span><br><span class="line">            dsn1 = slim.conv2d(dsn1, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn1'</span>)</span><br><span class="line">            <span class="comment"># no need deconv for dsn1</span></span><br><span class="line"></span><br><span class="line">            dsn2 = slim.conv2d(dsn2, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn2'</span>)</span><br><span class="line">            deconv_shape = tf.pack([batch_size, const.image_height, const.image_width, <span class="number">1</span>])</span><br><span class="line">            dsn2 = deconv_mobile_version(dsn2, <span class="number">2</span>, deconv_shape) <span class="comment"># deconv_mobile_version can work on mobile</span></span><br><span class="line"></span><br><span class="line">            dsn3 = slim.conv2d(dsn3, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn3'</span>)</span><br><span class="line">            deconv_shape = tf.pack([batch_size, const.image_height, const.image_width, <span class="number">1</span>])</span><br><span class="line">            dsn3 = deconv_mobile_version(dsn3, <span class="number">4</span>, deconv_shape)</span><br><span class="line"></span><br><span class="line">            dsn4 = slim.conv2d(dsn4, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn4'</span>)</span><br><span class="line">            deconv_shape = tf.pack([batch_size, const.image_height, const.image_width, <span class="number">1</span>])</span><br><span class="line">            dsn4 = deconv_mobile_version(dsn4, <span class="number">8</span>, deconv_shape)</span><br><span class="line"></span><br><span class="line">            dsn5 = slim.conv2d(dsn5, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn5'</span>)</span><br><span class="line">            deconv_shape = tf.pack([batch_size, const.image_height, const.image_width, <span class="number">1</span>])</span><br><span class="line">            dsn5 = deconv_mobile_version(dsn5, <span class="number">16</span>, deconv_shape)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># dsn fuse</span></span><br><span class="line">            dsn_fuse = tf.concat(<span class="number">3</span>, [dsn1, dsn2, dsn3, dsn4, dsn5])</span><br><span class="line">            dsn_fuse = tf.reshape(dsn_fuse, [batch_size, const.image_height, const.image_width, <span class="number">5</span>]) <span class="comment">#without this, will get error: ValueError: Number of in_channels must be known.</span></span><br><span class="line"></span><br><span class="line">            dsn_fuse = slim.conv2d(dsn_fuse, <span class="number">1</span>, [<span class="number">1</span>, <span class="number">1</span>], scope=<span class="string">'dsn_fuse'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dsn_fuse, dsn1, dsn2, dsn3, dsn4, dsn5</span><br></pre></td></tr></table></figure>
<h3 id="训练网络"><a href="#训练网络" class="headerlink" title="训练网络"></a>训练网络</h3><h4 id="cost-函数"><a href="#cost-函数" class="headerlink" title="cost 函数"></a>cost 函数</h4><p>论文给出的 HED 网络是一个通用的边缘检测网络，按照论文的描述，每一个尺度上得到的 image，都需要参与 cost 的计算，这部分的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">input_queue_for_train = tf.train.string_input_producer([FLAGS.csv_path])</span><br><span class="line">image_tensor, annotation_tensor = input_image_pipeline(dataset_root_dir_string, input_queue_for_train, FLAGS.batch_size)</span><br><span class="line"></span><br><span class="line">dsn_fuse, dsn1, dsn2, dsn3, dsn4, dsn5 = hed_net(image_tensor, FLAGS.batch_size)</span><br><span class="line"></span><br><span class="line">cost = class_balanced_sigmoid_cross_entropy(dsn_fuse, annotation_tensor) + \</span><br><span class="line">       class_balanced_sigmoid_cross_entropy(dsn1, annotation_tensor) + \</span><br><span class="line">       class_balanced_sigmoid_cross_entropy(dsn2, annotation_tensor) + \</span><br><span class="line">       class_balanced_sigmoid_cross_entropy(dsn3, annotation_tensor) + \</span><br><span class="line">       class_balanced_sigmoid_cross_entropy(dsn4, annotation_tensor) + \</span><br><span class="line">       class_balanced_sigmoid_cross_entropy(dsn5, annotation_tensor)</span><br></pre></td></tr></table></figure>
<p>按照这种方式训练出来的网络，检测到的边缘线是有一点粗的，为了得到更细的边缘线，通过多次试验找到了一种优化方案，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">input_queue_for_train = tf.train.string_input_producer([FLAGS.csv_path])</span><br><span class="line">image_tensor, annotation_tensor = input_image_pipeline(dataset_root_dir_string, input_queue_for_train, FLAGS.batch_size)</span><br><span class="line"></span><br><span class="line">dsn_fuse, _, _, _, _, _ = hed_net(image_tensor, FLAGS.batch_size)</span><br><span class="line"></span><br><span class="line">cost = class_balanced_sigmoid_cross_entropy(dsn_fuse, annotation_tensor)</span><br></pre></td></tr></table></figure>
<p>也就是不再让每个尺度上得到的 image 都参与 cost 的计算，只使用融合后得到的最终 image 来进行计算。</p>
<p>两种 cost 函数的效果对比如下图所示，右侧是优化过后的效果：</p>
<p><img src="/images/edge_thickness.png" alt="edge thickness"></p>
<p>另外还有一点，按照 HED 论文里的要求，计算 cost 的时候，不能使用常见的方差 cost，而应该使用 cost-sensitive loss function，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_balanced_sigmoid_cross_entropy</span><span class="params">(logits, label, name=<span class="string">'cross_entropy_loss'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    The class-balanced cross entropy loss,</span></span><br><span class="line"><span class="string">    as in `Holistically-Nested Edge Detection</span></span><br><span class="line"><span class="string">    &lt;http://arxiv.org/abs/1504.06375&gt;`_.</span></span><br><span class="line"><span class="string">    This is more numerically stable than class_balanced_cross_entropy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param logits: size: the logits.</span></span><br><span class="line"><span class="string">    :param label: size: the ground truth in &#123;0,1&#125;, of the same shape as logits.</span></span><br><span class="line"><span class="string">    :returns: a scalar. class-balanced cross entropy loss</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    y = tf.cast(label, tf.float32)</span><br><span class="line"></span><br><span class="line">    count_neg = tf.reduce_sum(<span class="number">1.</span> - y) <span class="comment"># the number of 0 in y</span></span><br><span class="line">    count_pos = tf.reduce_sum(y) <span class="comment"># the number of 1 in y (less than count_neg)</span></span><br><span class="line">    beta = count_neg / (count_neg + count_pos)</span><br><span class="line"></span><br><span class="line">    pos_weight = beta / (<span class="number">1</span> - beta)</span><br><span class="line">    cost = tf.nn.weighted_cross_entropy_with_logits(logits, y, pos_weight)</span><br><span class="line">    cost = tf.reduce_mean(cost * (<span class="number">1</span> - beta), name=name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cost</span><br></pre></td></tr></table></figure>
<h4 id="转置卷积层的双线性初始化"><a href="#转置卷积层的双线性初始化" class="headerlink" title="转置卷积层的双线性初始化"></a>转置卷积层的双线性初始化</h4><p>在尝试 FCN 网络的时候，就被这个问题卡住过很长一段时间，按照 FCN 的要求，在使用转置卷积(transposed convolution)/反卷积(deconv)的时候，要把卷积核的值初始化成双线性放大矩阵(bilinear upsampling kernel)，而不是常用的正态分布随机初始化，同时还要使用很小的学习率，这样才更容易让模型收敛。</p>
<p>HED 的论文中，并没有明确的要求也要采用这种方式初始化转置卷积层，但是，在训练过程中发现，采用这种方式进行初始化，模型才更容易收敛。</p>
<p>这部分的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_kernel_size</span><span class="params">(factor)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Find the kernel size given the desired factor of upsampling.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span> * factor - factor % <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upsample_filt</span><span class="params">(size)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Make a 2D bilinear kernel suitable for upsampling of the given (h, w) size.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    factor = (size + <span class="number">1</span>) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> size % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        center = factor - <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        center = factor - <span class="number">0.5</span></span><br><span class="line">    og = np.ogrid[:size, :size]</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> - abs(og[<span class="number">0</span>] - center) / factor) * (<span class="number">1</span> - abs(og[<span class="number">1</span>] - center) / factor)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bilinear_upsample_weights</span><span class="params">(factor, number_of_classes)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Create weights matrix for transposed convolution with bilinear filter</span></span><br><span class="line"><span class="string">    initialization.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    filter_size = get_kernel_size(factor)</span><br><span class="line">    </span><br><span class="line">    weights = np.zeros((filter_size,</span><br><span class="line">                        filter_size,</span><br><span class="line">                        number_of_classes,</span><br><span class="line">                        number_of_classes), dtype=np.float32)</span><br><span class="line">    </span><br><span class="line">    upsample_kernel = upsample_filt(filter_size)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(number_of_classes):</span><br><span class="line">        weights[:, :, i, i] = upsample_kernel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> weights</span><br></pre></td></tr></table></figure>
<h4 id="训练过程冷启动"><a href="#训练过程冷启动" class="headerlink" title="训练过程冷启动"></a>训练过程冷启动</h4><p>HED 网络不像 VGG 网络那样很容易就进入收敛状态，也不太容易进入期望的理想状态，主要是两方面的原因：</p>
<ul>
<li>前面提到的转置卷积层的双线性初始化，就是一个重要因素，因为在 4 个尺度上，都需要反卷积，如果反卷积层不能收敛，那整个 HED 都不会进入期望的理想状态</li>
<li>另外一个原因，是由 HED 的多尺度引起的，既然是多尺度了，那每个尺度上得到的 image 都应该对模型的最终输出 image 产生贡献，在训练的过程中发现，如果输入 image 的尺寸是 224*224，还是很容易就训练成功的，但是当把输入 image 的尺寸调整为 256*256 后，很容易出现一种状况，就是 5 个尺度上得到的 image，会有 1 ~ 2 个 image 是无效的(全部是黑色)</li>
</ul>
<p>为了解决这里遇到的问题，采用的办法就是先使用少量样本图片(比如 2000 张)训练网络，在很短的训练时间(比如迭代 1000 次)内，如果 HED 网络不能表现出收敛的趋势，或者不能达到 5 个尺度的 image 全部有效的状态，那就直接放弃这轮的训练结果，重新开启下一轮训练，直到满意为止，然后才使用完整的训练样本集合继续训练网络。</p>
<h3 id="训练数据集-大量合成数据-少量真实数据"><a href="#训练数据集-大量合成数据-少量真实数据" class="headerlink" title="训练数据集(大量合成数据 + 少量真实数据)"></a>训练数据集(大量合成数据 + 少量真实数据)</h3><p>HED 论文里使用的训练数据集，是针对通用的边缘检测目的的，什么形状的边缘都有，比如下面这种：</p>
<p><img src="/images/hed_training_dataset_1.png" alt="hed training dataset 1"></p>
<p>用这份数据训练出来的模型，在做文档扫描的时候，检测出来的边缘效果并不理想，而且这份训练数据集的样本数量也很小，只有一百多张图片(因为这种图片的人工标注成本太高了)，这也会影响模型的质量。</p>
<p>现在的需求里，要检测的是具有一定透视和旋转变换效果的矩形区域，所以可以大胆的猜测，如果准备一批针对性更强的训练样本，应该是可以得到更好的边缘检测效果的。</p>
<p>借助第一版技术方案收集回来的真实场景图片，我们开发了一套简单的标注工具，人工标注了 1200 张图片(标注这 1200 张图片的时间成本也很高)，但是这 1200 多张图片仍然有很多问题，比如对于神经网络来说，1200 个训练样本其实还是不够的，另外，这些图片覆盖的场景其实也比较少，有些图片的相似度比较高，这样的数据放到神经网络里训练，泛化的效果并不好。</p>
<p>所以，还采用技术手段，合成了80000多张训练样本图片。</p>
<p><img src="/images/hed_training_dataset_2.png" alt="hed training dataset 2"></p>
<p>如上图所示，一张背景图和一张前景图，可以合成出一对训练样本数据。在合成图片的过程中，用到了下面这些技术和技巧：</p>
<ul>
<li>在前景图上添加旋转、平移、透视变换</li>
<li>对背景图进行了随机的裁剪</li>
<li>通过试验对比，生成合适宽度的边缘线</li>
<li>OpenCV 不支持透明图层之间的旋转和透视变换操作，只能使用最低精度的插值算法，为了改善这一点，后续改成了使用 iOS 模拟器，通过 CALayer 上的操作来合成图片</li>
<li>在不断改进训练样本的过程中，还根据真实样本图片的统计情况和各种途径的反馈信息，刻意模拟了一些更复杂的样本场景，比如凌乱的背景环境、直线边缘干扰等等</li>
</ul>
<p>经过不断的调整和优化，最终才训练出一个满意的模型，可以再次通过下面这张图表中的第二列看一下神经网络模型的边缘检测效果：</p>
<p><img src="/images/hed_vs_canny.png" alt="hed vs canny"></p>
<h3 id="在手机设备上运行-TensorFlow"><a href="#在手机设备上运行-TensorFlow" class="headerlink" title="在手机设备上运行 TensorFlow"></a>在手机设备上运行 TensorFlow</h3><h4 id="在手机上使用-TensorFlow-库"><a href="#在手机上使用-TensorFlow-库" class="headerlink" title="在手机上使用 TensorFlow 库"></a>在手机上使用 TensorFlow 库</h4><p>TensorFlow 官方是支持 iOS 和 Android 的，而且有清晰的文档，照着做就行。但是因为 TensorFlow 是依赖于 protobuf 3 的，所以有可能会遇到一些其他的问题，比如下面这两种，就是我们在两个不同的 iOS APP 中遇到的问题和解决办法，可以作为一个参考：</p>
<ul>
<li>A 产品使用的是 protobuf 2，同时由于各种历史原因，使用并且停留在了很旧的某个版本的 Base 库上，而 protobuf 3 的内部也使用了 Base 库，当 A 产品升级到 protobuf 3 后，protobuf 3 的 Base 库和 A 源码中的 Base 库产生了一些奇怪的冲突，最后的解决办法是手动修改了 A 源码中的 Base 库，避免编译时的冲突</li>
<li>B 产品也是使用的 protobuf 2，而且 B 产品使用到的多个第三方模块(没有源码，只有二进制文件)也是依赖于 protobuf 2，直接升级 B 产品使用的 protobuf 库就行不通了，最后采用的方法是修改 TensorFlow 和 TensorFlow 中使用的 protobuf 3 的源代码，把 protobuf 3 换了一个命名空间，这样两个不同版本的 protobuf 库就可以共存了</li>
</ul>
<p>Android 上因为本身是可以使用动态库的，所以即便 app 必须使用 protobuf 2 也没有关系，不同的模块使用 dlopen 的方式加载各自需要的特定版本的库就可以了。</p>
<h4 id="在手机上使用训练得到的模型文件"><a href="#在手机上使用训练得到的模型文件" class="headerlink" title="在手机上使用训练得到的模型文件"></a>在手机上使用训练得到的模型文件</h4><p>模型通常都是在 PC 端训练的，对于大部分使用者，都是用 Python 编写的代码，得到 ckpt 格式的模型文件。在使用模型文件的时候，一种做法就是用代码重新构建出完整的神经网络，然后加载这个 ckpt 格式的模型文件，如果是在 PC 上使用模型文件，用这个方法其实也是可以接受的，复制粘贴一下 Python 代码就可以重新构建整个神经网络。但是，在手机上只能使用 TensorFlow 提供的 C++ 接口，如果还是用同样的思路，就需要用 C++ API 重新构建一遍神经网络，这个工作量就有点大了，而且 C++ API 使用起来比 Python API 复杂的多，所以，在 PC 上训练完网络后，还需要把 ckpt 格式的模型文件转换成 pb 格式的模型文件，这个 pb 格式的模型文件，是用 protobuf 序列化得到的二进制文件，里面包含了神经网络的具体结构以及每个矩阵的数值，使用这个 pb 文件的时候，不需要再用代码构建完整的神经网络结构，只需要反序列化一下就可以了，这样的话，用 C++ API 编写的代码就会简单很多，其实这也是 TensorFlow 推荐的使用方法，在 PC 上使用模型的时候，也应该使用这种 pb 文件(训练过程中使用 ckpt 文件)。</p>
<h3 id="HED-网络在手机上遇到的奇怪-crash"><a href="#HED-网络在手机上遇到的奇怪-crash" class="headerlink" title="HED 网络在手机上遇到的奇怪 crash"></a>HED 网络在手机上遇到的奇怪 crash</h3><p>在手机上加载 pb 模型文件并且运行的时候，遇到过一个诡异的错误，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Invalid argument: No OpKernel was registered to support Op &apos;Mul&apos; with these attrs.  Registered devices: [CPU], Registered kernels:</span><br><span class="line">  device=&apos;CPU&apos;; T in [DT_FLOAT]</span><br><span class="line"></span><br><span class="line">	 [[Node: hed/mul_1 = Mul[T=DT_INT32](hed/strided_slice_2, hed/mul_1/y)]]</span><br></pre></td></tr></table></figure>
<p>之所以诡异，是因为从字面上看，这个错误的含义是缺少乘法操作(Mul)，但是我用其他的神经网络模型做过对比，乘法操作模块是可以正常工作的。</p>
<p>Google 搜索后发现很多人遇到过类似的情况，但是错误信息又并不相同，后来在 TensorFlow 的 github issues 里终于找到了线索，综合起来解释，是因为 TensorFlow 是基于操作(Operation)来模块化设计和编码的，每一个数学计算模块就是一个 Operation，由于各种原因，比如内存占用大小、GPU 独占操作等等，mobile 版的 TensorFlow，并没有包含所有的 Operation，mobile 版的 TensorFlow 支持的 Operation 只是 PC 完整版 TensorFlow 的一个子集，我遇到的这个错误，就是因为使用到的某个 Operation 并不支持 mobile 版。</p>
<p>按照这个线索，在 Python 代码中逐个排查，后来定位到了出问题的代码，修改前后的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deconv</span><span class="params">(inputs, upsample_factor)</span>:</span></span><br><span class="line">    input_shape = tf.shape(inputs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calculate the ouput size of the upsampled tensor</span></span><br><span class="line">    upsampled_shape = tf.pack([input_shape[<span class="number">0</span>],</span><br><span class="line">                               input_shape[<span class="number">1</span>] * upsample_factor,</span><br><span class="line">                               input_shape[<span class="number">2</span>] * upsample_factor,</span><br><span class="line">                               <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    upsample_filter_np = bilinear_upsample_weights(upsample_factor, <span class="number">1</span>)</span><br><span class="line">    upsample_filter_tensor = tf.constant(upsample_filter_np)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perform the upsampling</span></span><br><span class="line">    upsampled_inputs = tf.nn.conv2d_transpose(inputs, upsample_filter_tensor,</span><br><span class="line">                                              output_shape=upsampled_shape,</span><br><span class="line">                                              strides=[<span class="number">1</span>, upsample_factor, upsample_factor, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> upsampled_inputs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deconv_mobile_version</span><span class="params">(inputs, upsample_factor, upsampled_shape)</span>:</span></span><br><span class="line">    upsample_filter_np = bilinear_upsample_weights(upsample_factor, <span class="number">1</span>)</span><br><span class="line">    upsample_filter_tensor = tf.constant(upsample_filter_np)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perform the upsampling</span></span><br><span class="line">    upsampled_inputs = tf.nn.conv2d_transpose(inputs, upsample_filter_tensor,</span><br><span class="line">                                              output_shape=upsampled_shape,</span><br><span class="line">                                              strides=[<span class="number">1</span>, upsample_factor, upsample_factor, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> upsampled_inputs</span><br></pre></td></tr></table></figure>
<p>问题就是由 deconv 函数中的 tf.shape 和 tf.pack 这两个操作引起的，在 PC 版代码中，为了简洁，是基于这两个操作，自动计算出 upsampled_shape，修改过后，则是要求调用者用 hard coding 的方式设置对应的 upsampled_shape。</p>
<h3 id="裁剪-TensorFlow"><a href="#裁剪-TensorFlow" class="headerlink" title="裁剪 TensorFlow"></a>裁剪 TensorFlow</h3><p>TensorFlow 是一个很庞大的框架，对于手机来说，它占用的体积是比较大的，所以需要尽量的缩减 TensorFlow 库占用的体积。</p>
<p>其实在解决前面遇到的那个 crash 问题的时候，已经指明了一种裁剪的思路，既然 mobile 版的 TensorFlow 本来就是 PC 版的一个子集，那就意味着可以根据具体的需求，让这个子集变得更小，这也就达到了裁剪的目的。具体来说，就是修改 TensorFlow 源码中的 tensorflow/tensorflow/contrib/makefile/tf_op_files.txt 文件，只保留使用到了的模块。针对 HED 网络，原有的 200 多个模块裁剪到只剩 46 个，裁剪过后的 tf_op_files.txt 文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">tensorflow/core/kernels/xent_op.cc</span><br><span class="line">tensorflow/core/kernels/where_op.cc</span><br><span class="line">tensorflow/core/kernels/unpack_op.cc</span><br><span class="line">tensorflow/core/kernels/transpose_op.cc</span><br><span class="line">tensorflow/core/kernels/transpose_functor_cpu.cc</span><br><span class="line">tensorflow/core/kernels/tensor_array_ops.cc</span><br><span class="line">tensorflow/core/kernels/tensor_array.cc</span><br><span class="line">tensorflow/core/kernels/split_op.cc</span><br><span class="line">tensorflow/core/kernels/split_v_op.cc</span><br><span class="line">tensorflow/core/kernels/split_lib_cpu.cc</span><br><span class="line">tensorflow/core/kernels/shape_ops.cc</span><br><span class="line">tensorflow/core/kernels/session_ops.cc</span><br><span class="line">tensorflow/core/kernels/sendrecv_ops.cc</span><br><span class="line">tensorflow/core/kernels/reverse_op.cc</span><br><span class="line">tensorflow/core/kernels/reshape_op.cc</span><br><span class="line">tensorflow/core/kernels/relu_op.cc</span><br><span class="line">tensorflow/core/kernels/pooling_ops_common.cc</span><br><span class="line">tensorflow/core/kernels/pack_op.cc</span><br><span class="line">tensorflow/core/kernels/ops_util.cc</span><br><span class="line">tensorflow/core/kernels/no_op.cc</span><br><span class="line">tensorflow/core/kernels/maxpooling_op.cc</span><br><span class="line">tensorflow/core/kernels/matmul_op.cc</span><br><span class="line">tensorflow/core/kernels/immutable_constant_op.cc</span><br><span class="line">tensorflow/core/kernels/identity_op.cc</span><br><span class="line">tensorflow/core/kernels/gather_op.cc</span><br><span class="line">tensorflow/core/kernels/gather_functor.cc</span><br><span class="line">tensorflow/core/kernels/fill_functor.cc</span><br><span class="line">tensorflow/core/kernels/dense_update_ops.cc</span><br><span class="line">tensorflow/core/kernels/deep_conv2d.cc</span><br><span class="line">tensorflow/core/kernels/xsmm_conv2d.cc</span><br><span class="line">tensorflow/core/kernels/conv_ops_using_gemm.cc</span><br><span class="line">tensorflow/core/kernels/conv_ops_fused.cc</span><br><span class="line">tensorflow/core/kernels/conv_ops.cc</span><br><span class="line">tensorflow/core/kernels/conv_grad_filter_ops.cc</span><br><span class="line">tensorflow/core/kernels/conv_grad_input_ops.cc</span><br><span class="line">tensorflow/core/kernels/conv_grad_ops.cc</span><br><span class="line">tensorflow/core/kernels/constant_op.cc</span><br><span class="line">tensorflow/core/kernels/concat_op.cc</span><br><span class="line">tensorflow/core/kernels/concat_lib_cpu.cc</span><br><span class="line">tensorflow/core/kernels/bias_op.cc</span><br><span class="line">tensorflow/core/ops/sendrecv_ops.cc</span><br><span class="line">tensorflow/core/ops/no_op.cc</span><br><span class="line">tensorflow/core/ops/nn_ops.cc</span><br><span class="line">tensorflow/core/ops/nn_grad.cc</span><br><span class="line">tensorflow/core/ops/array_ops.cc</span><br><span class="line">tensorflow/core/ops/array_grad.cc</span><br></pre></td></tr></table></figure>
<p>需要强调的一点是，这种操作思路，是针对不同的神经网络结构有不同的裁剪方式，原则就是用到什么模块就保留什么模块。当然，因为有些模块之间还存在隐含的依赖关系，所以裁剪的时候也是要反复尝试多次才能成功的。</p>
<p>除此之外，还有下面这些通用手段也可以实现裁剪的目的：</p>
<ul>
<li>编译器级别的 strip 操作，在链接的时候会自动的把没有调用到的函数去除掉(集成开发环境里通常已经自动将这些参数设置成了最佳组合)</li>
<li>借助一些高级技巧和工具，对二进制文件进行瘦身</li>
</ul>
<p>借助所有这些裁剪手段，最终我们的 ipa 安装包的大小只增加了 3M。如果不做手动裁剪这一步，那 ipa 的增量，则是 30M 左右。</p>
<h3 id="裁剪-HED-网络"><a href="#裁剪-HED-网络" class="headerlink" title="裁剪 HED 网络"></a>裁剪 HED 网络</h3><p>按照 HED 论文给出的参考信息，得到的模型文件的大小是 56M，对于手机来说也是比较大的，而且模型越大也意味着计算量越大，所以需要考虑能否把 HED 网络也裁剪一下。</p>
<p>HED 网络是用 VGG16 作为基础网络结构，而 VGG 又是一个得到广泛验证的基础网络结构，因此修改 HED 的整体结构肯定不是一个明智的选择，至少不是首选的方案。</p>
<p>考虑到现在的需求，只是检测矩形区域的边缘，而并不是检测通用场景下的广义的边缘，可以认为前者的复杂度比后者更低，所以一种可行的思路，就是保留 HED 的整体结构，修改 VGG 每一组卷积层里面的卷积核的数量，让 HED 网络变的更『瘦』。</p>
<p>按照这种思路，经过多次调整和尝试，最终得到了一组合适的卷积核的数量参数，对应的模型文件只有 4.2M，在 iPhone 7P 上，处理每帧图片的时间消耗是 0.1 秒左右，满足实时性的要求。</p>
<p>神经网络的裁剪，目前在学术界也是一个很热门的领域，有好几种不同的理论来实现不同目的的裁剪，但是，也并不是说每一种网络结构都有裁剪的空间，通常来说，应该结合实际情况，使用合适的技术手段，选择一个合适大小的模型文件。</p>
<h3 id="TensorFlow-API-的选择"><a href="#TensorFlow-API-的选择" class="headerlink" title="TensorFlow API 的选择"></a>TensorFlow API 的选择</h3><p>TensorFlow 的 API 是很灵活的，也比较底层，在学习过程中发现，每个人写出来的代码，风格差异很大，而且很多工程师又采用了各种各样的技巧来简化代码，但是这其实反而在无形中又增加了代码的阅读难度，也不利于代码的复用。</p>
<p>第三方社区和 TensorFlow 官方，都意识到了这个问题，所以更好的做法是，使用封装度更高但又保持灵活性的 API 来进行开发。本文中的代码，就是使用 TensorFlow-Slim 编写的。</p>
<h3 id="OpenCV-算法"><a href="#OpenCV-算法" class="headerlink" title="OpenCV 算法"></a>OpenCV 算法</h3><p>虽然用神经网络技术，已经得到了一个比 canny 算法更好的边缘检测效果，但是，神经网络也并不是万能的，干扰是仍然存在的，所以，第二个步骤中的数学模型算法，仍然是需要的，只不过因为第一个步骤中的边缘检测有了大幅度改善，所以第二个步骤中的算法，得到了适当的简化，而且算法整体的适应性也更强了。</p>
<p>这部分的算法如下图所示：</p>
<p><img src="/images/find_rect_1.png" alt="find rect 1"></p>
<p>按照编号顺序，几个关键步骤做了下面这些事情：</p>
<ol>
<li>用 HED 网络检测边缘，可以看到，这里得到的边缘线还是存在一些干扰的</li>
<li>在前一步得到的图像上，使用 HoughLinesP 函数检测线段(蓝色线段)</li>
<li>把前一步得到的线段延长成直线(绿色直线)</li>
<li>在第二步中检测到的线段，有一些是很接近的，或者有些短线段是可以连接成一条更长的线段的，所以可以采用一些策略把它们合并到一起，这个时候，就要借助第三步中得到的直线。定义一种策略判断两条直线是否相等，当遇到相等的两条直线时，把这两条直线各自对应的线段再合并或连接成一条线段。这一步完成后，后面的步骤就只需要蓝色的线段而不需要绿色的直线了</li>
<li>根据第四步得到的线段，计算它们之间的交叉点，临近的交叉点也可以合并，同时，把每一个交叉点和产生这个交叉点的线段也要关联在一起(每一个蓝色的点，都有一组红色的线段和它关联)</li>
<li>对于第五步得到的所有交叉点，每次取出其中的 4 个，判断这 4 个点组成的四边形是否是一个合理的矩形(有透视变换效果的矩形)，除了常规的判断策略，比如角度、边长的比值之外，还有一个判断条件就是每条边是否可以和第五步中得到的对应的点的关联线段重合，如果不能重合，则这个四边形就不太可能是我们期望检测出来的矩形</li>
<li>经过第六步的过滤后，如果得到了多个四边形，可以再使用一个简单的过滤策略，比如排序找出周长或面积最大的矩形</li>
</ol>
<p>对于上面这个例子，第一版技术方案中检测出来的边缘线如下图所示：</p>
<p><img src="/images/find_rect_2.png" alt="find rect 2"></p>
<p>有兴趣的读者也可以考虑一下，在这种边缘图中，如何设计算法才能找出我们期望的那个矩形。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><h4 id="算法角度"><a href="#算法角度" class="headerlink" title="算法角度"></a>算法角度</h4><ul>
<li>神经网络的参数/超参数的调优，通常只能基于经验来设置，有 magic trick 的成分</li>
<li>神经网络/机器学习是一门试验科学</li>
<li>对于监督学习，数据的标注成本很高，这一步很容易出现瓶颈</li>
<li>论文、参考代码和自己的代码，这三者之间不完全一致也是正常现象</li>
<li>对于某些需求，可以在模型的准确度、大小和运行速度之间找一个平衡点</li>
</ul>
<h4 id="工程角度"><a href="#工程角度" class="headerlink" title="工程角度"></a>工程角度</h4><ul>
<li>end-to-end 网络无效的时候，可以用 pipeline 的思路考虑问题、拆分业务，针对性的使用神经网络技术</li>
<li>至少要熟练掌握一种神经网络的开发框架，而且要追求代码的工程质量</li>
<li>要掌握神经网络技术中的一些基本套路，举一反三</li>
<li>要在学术界和工业界中间找平衡点，尽可能多的学习一些不同问题领域的神经网络模型，作为技术储备</li>
</ul>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p><a href="http://karpathy.github.io/neuralnets/" target="_blank" rel="noopener">Hacker’s guide to Neural Networks</a><br><a href="http://www.open-open.com/lib/view/open1452752687042.html" target="_blank" rel="noopener">神经网络浅讲：从神经元到深度学习</a><br><a href="https://www.zhihu.com/question/21329754" target="_blank" rel="noopener">分类与回归区别是什么？</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650718943&amp;idx=1&amp;sn=258117d392ca1bfc37d6496992da5eae&amp;scene=0#rd" target="_blank" rel="noopener">神经网络架构演进史：全面回顾从LeNet5到ENet十余种架构</a></p>
<p><a href="http://coolshell.cn/articles/10192.html" target="_blank" rel="noopener">数据的游戏：冰与火</a><br><a href="http://dataunion.org/20441.html" target="_blank" rel="noopener">为什么“高大上”的算法工程师变成了数据民工？</a><br><a href="http://www.infoq.com/cn/news/2015/07/deep-learning-limit" target="_blank" rel="noopener">Facebook人工智能负责人Yann LeCun谈深度学习的局限性</a>  </p>
<p><a href="https://medium.com/technologymadeeasy/the-best-explanation-of-convolutional-neural-networks-on-the-internet-fbb8b1ad5df8#.15uipz5fp" target="_blank" rel="noopener">The best explanation of Convolutional Neural Networks on the Internet!</a><br><a href="http://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650717691&amp;idx=2&amp;sn=3f0b66aa9706aae1a30b01309aa0214c" target="_blank" rel="noopener">从入门到精通：卷积神经网络初学者指南</a><br><a href="http://buptldy.github.io/2016/10/29/2016-10-29-deconv/" target="_blank" rel="noopener">Transposed Convolution, Fractionally Strided Convolution or Deconvolution</a><br><a href="https://github.com/vdumoulin/conv_arithmetic" target="_blank" rel="noopener">A technical report on convolution arithmetic in the context of deep learning</a> </p>
<p><a href="http://cs231n.github.io/understanding-cnn/" target="_blank" rel="noopener">Visualizing what ConvNets learn</a><br><a href="http://kvfrans.com/visualizing-features-from-a-convolutional-neural-network/" target="_blank" rel="noopener">Visualizing Features from a Convolutional Neural Network</a>       </p>
<p><a href="https://datascience.stackexchange.com/questions/9850/neural-networks-which-cost-function-to-use" target="_blank" rel="noopener">Neural networks: which cost function to use?</a><br><a href="http://stackoverflow.com/questions/34240703/difference-between-tensorflow-tf-nn-softmax-and-tf-nn-softmax-cross-entropy-with" target="_blank" rel="noopener">difference between tensorflow tf.nn.softmax and tf.nn.softmax_cross_entropy_with_logits</a><br><a href="https://jamesmccaffrey.wordpress.com/2013/11/05/why-you-should-use-cross-entropy-error-instead-of-classification-error-or-mean-squared-error-for-neural-network-classifier-training/" target="_blank" rel="noopener">Why You Should Use Cross-Entropy Error Instead Of Classification Error Or Mean Squared Error For Neural Network Classifier Training</a></p>
<p><a href="https://gab41.lab41.org/tensorflow-3-ways-46a46bef895d" target="_blank" rel="noopener">Tensorflow 3 Ways</a><br><a href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/contrib/slim" target="_blank" rel="noopener">TensorFlow-Slim</a><br><a href="https://github.com/tensorflow/models/tree/master/slim" target="_blank" rel="noopener">TensorFlow-Slim image classification library</a></p>
<p><a href="https://github.com/s9xie/hed" target="_blank" rel="noopener">Holistically-Nested Edge Detection</a><br><a href="https://zhuanlan.zhihu.com/p/22045213" target="_blank" rel="noopener">深度卷积神经网络在目标检测中的进展</a><br><a href="https://zhuanlan.zhihu.com/p/20872103" target="_blank" rel="noopener">全卷积网络：从图像级理解到像素级理解</a><br><a href="https://zhuanlan.zhihu.com/p/22308032" target="_blank" rel="noopener">图像语义分割之FCN和CRF</a> </p>
<p><a href="http://warmspringwinds.github.io/tensorflow/tf-slim/2016/10/30/image-classification-and-segmentation-using-tensorflow-and-tf-slim/" target="_blank" rel="noopener">Image Classification and Segmentation with Tensorflow and TF-Slim</a><br><a href="http://warmspringwinds.github.io/tensorflow/tf-slim/2016/11/22/upsampling-and-image-segmentation-with-tensorflow-and-tf-slim/" target="_blank" rel="noopener">Upsampling and Image Segmentation with Tensorflow and TF-Slim</a><br><a href="http://warmspringwinds.github.io/tensorflow/tf-slim/2016/12/18/image-segmentation-with-tensorflow-using-cnns-and-conditional-random-fields/" target="_blank" rel="noopener">Image Segmentation with Tensorflow using CNNs and Conditional Random Fields</a>  </p>
<p><a href="http://www.pyimagesearch.com/2014/09/01/build-kick-ass-mobile-document-scanner-just-5-minutes/" target="_blank" rel="noopener">How to Build a Kick-Ass Mobile Document Scanner in Just 5 Minutes</a><br><a href="http://www.nitish-dwivedi.com/2016/05/make-document-scanner-using-python-and.html" target="_blank" rel="noopener">MAKE DOCUMENT SCANNER USING PYTHON AND OPENCV</a><br><a href="https://blogs.dropbox.com/tech/2016/08/fast-and-accurate-document-detection-for-scanning/" target="_blank" rel="noopener">Fast and Accurate Document Detection for Scanning</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/25/The-Power-Of-Composition-In-FRP-Part-5/" itemprop="url">
                  用 ReactiveCocoa 事半功倍的写代码（五）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-25T16:40:42+08:00" content="2016-07-25">
              2016-07-25
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/25/The-Power-Of-Composition-In-FRP-Part-5/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/25/The-Power-Of-Composition-In-FRP-Part-5/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="体会-Composition-的含义"><a href="#体会-Composition-的含义" class="headerlink" title="体会 Composition 的含义"></a>体会 Composition 的含义</h3><p>有些读者可能会注意到一点，这个系列教程的英文标题是 The Power Of Composition In FRP，看上去并不像是中文标题的直接翻译，其实这也是纠结过后的一个妥协的选择，其实我个人更喜欢这个英文标题，因为 Composition 这个词，更能体现出 FRP 的一个精髓理念，如果要用一个中文词语来表示，我觉得『组装』这个词更准确一些。</p>
<p>先看下面这段代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)fetchNecessaryDataForAccounts:(<span class="built_in">NSArray</span>&lt;FMAccount *&gt; *)accounts &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(accounts != <span class="literal">nil</span>);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(accounts.count &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    [[[[[accounts.rac_sequence signal] <span class="comment">//1</span></span><br><span class="line">        map:^<span class="keyword">id</span>(FMAccount *account) &#123;</span><br><span class="line">            <span class="comment">//2</span></span><br><span class="line">            <span class="keyword">return</span> [[[QHOldAccountMigration fetchInitialDataForAccount:account]</span><br><span class="line">                     map:^<span class="keyword">id</span>(FMAccount *account) &#123;</span><br><span class="line">                         <span class="comment">//3</span></span><br><span class="line">                         <span class="keyword">return</span> RACTuplePack(account, <span class="literal">nil</span>);</span><br><span class="line">                     &#125;]</span><br><span class="line">                    catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                        <span class="comment">//3</span></span><br><span class="line">                        <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:RACTuplePack(account, error)];</span><br><span class="line">                    &#125;];</span><br><span class="line">        &#125;]</span><br><span class="line">       collect] <span class="comment">//4</span></span><br><span class="line">      flattenMap:^RACStream *(<span class="built_in">NSArray</span> *arrayOfSignal) &#123;</span><br><span class="line">          <span class="keyword">return</span> [[RACSignal zip:arrayOfSignal] <span class="comment">//4</span></span><br><span class="line">                  map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                      <span class="built_in">NSMutableArray</span> *successAccounts = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">                      <span class="built_in">NSMutableArray</span> *failAccounts = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">                      </span><br><span class="line">                      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tuple.count; i++) &#123;</span><br><span class="line">                          RACTuple *t = [tuple objectAtIndex:i];</span><br><span class="line">                          FMAccount *account = t.first;</span><br><span class="line">                          <span class="built_in">NSError</span> *error = t.second;</span><br><span class="line">                          </span><br><span class="line">                          <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                              [failAccounts addObject:account];</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              [successAccounts addObject:account];</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      </span><br><span class="line">                      <span class="keyword">return</span> RACTuplePack([successAccounts <span class="keyword">copy</span>], [failAccounts <span class="keyword">copy</span>]);</span><br><span class="line">                  &#125;];</span><br><span class="line">      &#125;]</span><br><span class="line">     subscribeNext:^(RACTuple *tuple) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="built_in">NSArray</span> *successAccounts = tuple.first;</span><br><span class="line">         <span class="built_in">NSArray</span> *failAccounts = tuple.second;</span><br><span class="line">         <span class="comment">//5</span></span><br><span class="line">         </span><br><span class="line">         <span class="keyword">if</span> (failAccounts.count == <span class="number">0</span>) &#123;</span><br><span class="line">             [<span class="keyword">self</span> jumpToOriginalLogic];</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="built_in">NSMutableString</span> *title;</span><br><span class="line">             <span class="keyword">if</span> (successAccounts.count == <span class="number">0</span>) &#123;</span><br><span class="line">                 title = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"所有账号迁移失败，请重新登录"</span>];</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 title = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"邮箱账号"</span>];</span><br><span class="line">                 <span class="keyword">for</span> (FMAccount *account <span class="keyword">in</span> failAccounts) &#123;</span><br><span class="line">                     [title appendFormat:<span class="string">@"%@, "</span>, account.profile.mailAddress];</span><br><span class="line">                 &#125;</span><br><span class="line">                 </span><br><span class="line">                 title = [[title substringToIndex:title.length - <span class="number">2</span>] mutableCopy];</span><br><span class="line">                 [title appendString:<span class="string">@"迁移失败，需要重新登录"</span>];</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="built_in">UIAlertController</span> *alertController = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:title message:<span class="literal">nil</span> preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">             [alertController addAction:[<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"确定"</span> style:<span class="built_in">UIAlertActionStyleDefault</span> handler:^(<span class="built_in">UIAlertAction</span> * _Nonnull action) &#123;</span><br><span class="line">                 @strongify(<span class="keyword">self</span>);</span><br><span class="line">                 <span class="keyword">for</span> (FMAccount *account <span class="keyword">in</span> failAccounts) &#123;</span><br><span class="line">                     FMMigrationFailAccount *failAccount = [FMMigrationFailAccount convertAccountToMigrationFailAccount:account];</span><br><span class="line">                     [failAccount save];</span><br><span class="line">                     </span><br><span class="line">                     [[FMManager shareInstance] deleteAccount:account.accountId];</span><br><span class="line">                 &#125;</span><br><span class="line">                 [<span class="keyword">self</span> jumpToOriginalLogic];</span><br><span class="line">             &#125;]];</span><br><span class="line">             </span><br><span class="line">             <span class="built_in">UIViewController</span> *viewController = [<span class="built_in">UIApplication</span> sharedApplication].keyWindow.rootViewController;</span><br><span class="line">             [viewController presentViewController:alertController animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">             &#125;];</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">         </span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         </span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 pipeline 其实用的就是 <a href="http://fengjian0106.github.io/2016/04/28/The-Power-Of-Composition-In-FRP-Part-3/">collect + combineLatest 或者 zip</a> 这种管道模型，只不过管道内部具体的业务不一样，这里的业务就是针对每一个 FMAccount 帐号，下载一些必要的初始数据，然后等每个下载都完成后，再执行后续的业务，主要就是下面几个点：</p>
<ol>
<li>把包含有 FMAccount 的数组，先变换成 signal。</li>
<li>[QHOldAccountMigration fetchInitialDataForAccount:account] 里面执行的是下载初始数据的具体业务逻辑，其实它的内部就是一个用多个 map 操作串联起来的 pipeline，对应下载初始数据过程中的多个步骤。</li>
<li>如果 fetchInitialDataForAccount 失败，则把 error 转换成 next 事件，用 tuple 的形式继续向 pipeline 的后续环节传递，等所有的下载都结束后，会统一对 error 进行处理。</li>
<li>套用 collect + zip 这种 pipeline 模型。</li>
<li>当所有的下载都结束后，才会运行到这里，successAccounts 和 failAccounts 分别对应成功下载初始数据的所有帐号和下载数据失败了的所有帐号，至于后面 if 分支里的代码，只是后续的一些业务逻辑功能，读者可以不用在意，我们的重点还是在于这个 pipeline 的外形。</li>
</ol>
<p>在编写程序的时候，通常我们都会提到『复用』这个概念，最简单的场景就是函数复用，这里的 pipeline 也是一种复用，只不过 pipeline 不像普通函数那样通过抽象出输入参数和返回结果来实现复用，pipeline 的复用体现在管道的形状上，这里所谓的形状，就是把 FRP 中对 signal 的各种操作组装起来后 pipeline 的形状。多个 map 串联是一种形状，collect + zip 是一种形状，之前的教程中提到的那些案例，都可以理解为一种形状(甚至还可以看成是多个不同形状的 pipeline 的进一步组装)，每一种形状的管道，有输入的数据，有输出的数据，同时，还存在各种各样的中间处理环节，每次复用 pipeline 的时候，输入数据、输出数据以及中间处理环节，都是可以根据具体的业务需求灵活的进行填充的。</p>
<p>回到前面这个例子，accounts 是 pipeline 的输入，successAccounts 和 failAccounts 是 pipeline 的输出，其他的操作都可以看成是中间处理环节。这个 pipeline 仅仅是完成了下载数据的功能，在真实的产品需求中，为了更好的照顾用户体验，还希望能够显示出下载进度信息，也就是说，对于 accounts 这个输入，还需要另外一种形式的输出信息，可以体现出下载进度情况。这里还有一个约束条件，[QHOldAccountMigration fetchInitialDataForAccount:account] 这个操作本身是无法表现出下载数据时的进度信息的，因为并不是下载一个文件(在编程惯例中，通常只在上传和下载文件的时候或类似的场景中，才会设计出能体现进度信息的 API)，所以这里还需要想办法模拟出一种进度信息用来在 UI 上进行显示，主要代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)fetchNecessaryDataForAccounts:(<span class="built_in">NSArray</span>&lt;FMAccount *&gt; *)accounts &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(accounts != <span class="literal">nil</span>);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(accounts.count &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">//1</span></span><br><span class="line">    RACSignal *fetchAllInitialData = [[[[accounts.rac_sequence signal]</span><br><span class="line">                                        map:^<span class="keyword">id</span>(FMAccount *account) &#123;</span><br><span class="line">                                            <span class="keyword">return</span> [[[[[QHOldAccountMigration fetchInitialDataForAccount:account]</span><br><span class="line">                                                       map:^<span class="keyword">id</span>(FMAccount *account) &#123;</span><br><span class="line">                                                           <span class="keyword">return</span> RACTuplePack(account, <span class="literal">nil</span>);</span><br><span class="line">                                                       &#125;]</span><br><span class="line">                                                      catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                                                          <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:RACTuplePack(account, error)];</span><br><span class="line">                                                      &#125;]</span><br><span class="line">                                                     multicast:[RACReplaySubject subject]] <span class="comment">//3</span></span><br><span class="line">                                                    autoconnect];</span><br><span class="line">                                        &#125;]</span><br><span class="line">                                       multicast:[RACReplaySubject subject]] <span class="comment">//2</span></span><br><span class="line">                                      autoconnect];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4</span></span><br><span class="line">    RACSignal *businessLogicSignal = [[fetchAllInitialData collect]</span><br><span class="line">                                      flattenMap:^RACStream *(<span class="built_in">NSArray</span> *arrayOfSignal) &#123;</span><br><span class="line">                                          <span class="keyword">return</span> [[RACSignal zip:arrayOfSignal]</span><br><span class="line">                                                  map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                                                      <span class="built_in">NSMutableArray</span> *successAccounts = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">                                                      <span class="built_in">NSMutableArray</span> *failAccounts = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">                                                      </span><br><span class="line">                                                      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tuple.count; i++) &#123;</span><br><span class="line">                                                          RACTuple *t = [tuple objectAtIndex:i];</span><br><span class="line">                                                          FMAccount *account = t.first;</span><br><span class="line">                                                          <span class="built_in">NSError</span> *error = t.second;</span><br><span class="line">                                                          </span><br><span class="line">                                                          <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                                                              [failAccounts addObject:account];</span><br><span class="line">                                                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                                              [successAccounts addObject:account];</span><br><span class="line">                                                          &#125;</span><br><span class="line">                                                      &#125;</span><br><span class="line">                                                      </span><br><span class="line">                                                      <span class="keyword">return</span> RACTuplePack([successAccounts <span class="keyword">copy</span>], [failAccounts <span class="keyword">copy</span>]);</span><br><span class="line">                                                  &#125;];</span><br><span class="line">                                      &#125;];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [businessLogicSignal</span><br><span class="line">     subscribeNext:^(RACTuple *tuple) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="built_in">NSArray</span> *successAccounts = tuple.first;</span><br><span class="line">         <span class="built_in">NSArray</span> *failAccounts = tuple.second;</span><br><span class="line">         <span class="comment">//5</span></span><br><span class="line">         <span class="keyword">if</span> (failAccounts.count == <span class="number">0</span>) &#123;</span><br><span class="line">             [<span class="keyword">self</span> jumpToOriginalLogic];</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="built_in">NSMutableString</span> *title;</span><br><span class="line">             <span class="keyword">if</span> (successAccounts.count == <span class="number">0</span>) &#123;</span><br><span class="line">                 title = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"所有账号迁移失败，请重新登录"</span>];</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 title = [[<span class="built_in">NSMutableString</span> alloc] initWithString:<span class="string">@"邮箱账号"</span>];</span><br><span class="line">                 <span class="keyword">for</span> (FMAccount *account <span class="keyword">in</span> failAccounts) &#123;</span><br><span class="line">                     [title appendFormat:<span class="string">@"%@, "</span>, account.profile.mailAddress];</span><br><span class="line">                 &#125;</span><br><span class="line">                 </span><br><span class="line">                 title = [[title substringToIndex:title.length - <span class="number">2</span>] mutableCopy];</span><br><span class="line">                 [title appendString:<span class="string">@"迁移失败，需要重新登录"</span>];</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="built_in">UIAlertController</span> *alertController = [<span class="built_in">UIAlertController</span> alertControllerWithTitle:title message:<span class="literal">nil</span> preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">             [alertController addAction:[<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"确定"</span> style:<span class="built_in">UIAlertActionStyleDefault</span> handler:^(<span class="built_in">UIAlertAction</span> * _Nonnull action) &#123;</span><br><span class="line">                 @strongify(<span class="keyword">self</span>);</span><br><span class="line">                 <span class="keyword">for</span> (FMAccount *account <span class="keyword">in</span> failAccounts) &#123;</span><br><span class="line">                     FMMigrationFailAccount *failAccount = [FMMigrationFailAccount convertAccountToMigrationFailAccount:account];</span><br><span class="line">                     [failAccount save];</span><br><span class="line">                     </span><br><span class="line">                     [[FMManager shareInstance] deleteAccount:account.accountId];</span><br><span class="line">                 &#125;</span><br><span class="line">                 [<span class="keyword">self</span> jumpToOriginalLogic];</span><br><span class="line">             &#125;]];</span><br><span class="line">             </span><br><span class="line">             <span class="built_in">UIViewController</span> *viewController = [<span class="built_in">UIApplication</span> sharedApplication].keyWindow.rootViewController;</span><br><span class="line">             [viewController presentViewController:alertController animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">             &#125;];</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">         </span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         </span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//11</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">CGFloat</span> tickCount = <span class="number">60</span> / <span class="number">0.5</span>;</span><br><span class="line">    RACSignal *timer = [[RACSignal interval:<span class="number">0.5</span> onScheduler:[RACScheduler mainThreadScheduler]]</span><br><span class="line">                        map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">                        &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *numbers = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; tickCount; i++) &#123;</span><br><span class="line">        [numbers addObject:@(i)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    RACSignal *counter = [[[[[numbers.rac_sequence signal]</span><br><span class="line">                             zipWith:timer]</span><br><span class="line">                            map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                                <span class="built_in">NSNumber</span> *n = tuple.first;</span><br><span class="line">                                <span class="keyword">return</span> RACTuplePack(n, @(tickCount), <span class="literal">nil</span>);<span class="comment">//12</span></span><br><span class="line">                            &#125;]</span><br><span class="line">                           takeUntil:businessLogicSignal]</span><br><span class="line">                          logCompleted];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *sequence = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; accounts.count; i++) &#123;</span><br><span class="line">        [sequence addObject:@(i + <span class="number">1</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSInteger</span> progressValue = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    [[[[[[[fetchAllInitialData</span><br><span class="line">           flatten]<span class="comment">//6</span></span><br><span class="line">          map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">              <span class="comment">//7</span></span><br><span class="line">              <span class="keyword">return</span> tuple.first;</span><br><span class="line">          &#125;]</span><br><span class="line">         zipWith:[sequence.rac_sequence signal]]<span class="comment">//8</span></span><br><span class="line">        combineLatestWith:[RACSignal <span class="keyword">return</span>:@(accounts.count)]]<span class="comment">//8</span></span><br><span class="line">       map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">           <span class="comment">//9</span></span><br><span class="line">           RACTuple *nestedTuple = tuple.first;</span><br><span class="line">           <span class="built_in">NSNumber</span> *accountsCount = tuple.second;</span><br><span class="line">           </span><br><span class="line">           FMAccount *account = nestedTuple.first;</span><br><span class="line">           <span class="built_in">NSNumber</span> *order = nestedTuple.second;</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//10</span></span><br><span class="line">           <span class="keyword">return</span> RACTuplePack(order, accountsCount, account);</span><br><span class="line">       &#125;]</span><br><span class="line">      merge:counter]<span class="comment">//11</span></span><br><span class="line">     subscribeNext:^(RACTuple *tuple) &#123;</span><br><span class="line">         <span class="built_in">NSNumber</span> *order = tuple.first;</span><br><span class="line">         <span class="built_in">NSNumber</span> *accountsCount = tuple.second;</span><br><span class="line">         FMAccount *account = tuple.third;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//13</span></span><br><span class="line">         <span class="keyword">if</span> (account) &#123;</span><br><span class="line">             <span class="built_in">NSLog</span>(<span class="string">@"fetch initial data finished, order is: [%@, %@], account is: %@"</span>, order, accountsCount, account.profile.mailAddress);</span><br><span class="line">             </span><br><span class="line">             <span class="built_in">NSInteger</span> nextValue = order.integerValue * <span class="number">100</span> / accountsCount.integerValue;</span><br><span class="line">             <span class="keyword">if</span> (order.integerValue == accountsCount.integerValue) &#123;</span><br><span class="line">                 nextValue = <span class="number">100</span>;</span><br><span class="line">                 progressValue = <span class="number">100</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             </span><br><span class="line">             <span class="keyword">if</span> (nextValue &gt; progressValue) &#123;</span><br><span class="line">                 progressValue = nextValue;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="built_in">NSLog</span>(<span class="string">@"counter info, [%@, %@]"</span>, order, accountsCount);</span><br><span class="line">             progressValue = progressValue + <span class="number">1.0</span>;</span><br><span class="line">             </span><br><span class="line">             <span class="comment">//14</span></span><br><span class="line">             <span class="keyword">if</span> (progressValue &gt; <span class="number">95</span>) &#123;</span><br><span class="line">                 progressValue = <span class="number">95.0</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         </span><br><span class="line">         <span class="comment">//14</span></span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"======== progressValue is: %ld"</span>, (<span class="keyword">long</span>)progressValue);</span><br><span class="line">         </span><br><span class="line">     &#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面看看这个 pipeline 是如何组装出来的：</p>
<ol>
<li>需求越复杂，通常 pipeline 也就会越复杂，现在我们遇到了新的需求，但是之前那个 pipeline 做的业务仍然是需要保留的，这种时候，通常可以考虑先把 pipeline 的代码拆分一下，然后对拆出来的 signal 或者 pipeline 重新进行组装。首先就可以把 [QHOldAccountMigration fetchInitialDataForAccount:account] 动作拆分出来，注意一点，这里还没有调用 collect 操作。</li>
<li>因为后续多个业务逻辑都要用到前面第一步得到的 signal，根据业务的需求，对于每个 FMAccount 只需要下载一次数据，所以这里应该让 signal 变成广播的形式。</li>
<li>内层嵌套的 signal 才是真正的 fetchInitialDataForAccount 动作，同理，也需要变成广播(其实在刚开始设计 pipeline 的时候，可能还意识不到需要广播，这种时候，可以先组装业务流程，当遇到问题后，再考虑是否需要使用广播 signal)。如果暂时看不明白为什么 2 和 3 两处需要使用广播，没有关系，先接着往后看，把整个 pipeline 看明白后，再倒回来想想为什么需要广播。</li>
<li>这个中间环节也拆分出来，以备后用。</li>
<li>这里是对 successAccounts 和 failAccounts 的处理逻辑，和前一个版本的 pipeline 没有区别。</li>
<li>现在开始考虑如何显示进度信息，虽然每次 [QHOldAccountMigration fetchInitialDataForAccount:account] 调用是没有进度信息的，但是当有多次调用的时候，是可以计算出一种形式的进度信息的，比如总共有 5 个 FMAccount，当第一个 FMAccount 下载完数据(或者失败)的时候，整体进度就是 1/5，当第二个 FMAccount 下载完数据(或者失败)的时候，整体进度就是 2/5，依次类推。</li>
<li>回忆一下 fetchAllInitialData 里面的内容，因为现在是计算进度信息，并不关心具体的 error，所以这里的 map 操作只需要返回 tuple.first，也就是只需要继续传递 FMAccount。</li>
<li>这里连续调用 zip 和 combineLatest，如果觉得这里很难理解，没有关系，先分别回忆一下 zip 和 combineLatest 的效果，想象一下这里应该得到什么样的结果。</li>
<li>前面的 zip 操作会得到一个 tuple，然后这个 tuple 又和 [RACSignal return:@(accounts.count)] 进行一次 combineLatest，所以这里会得到一个嵌套的 tuple。</li>
<li>8 和 9 的操作，最终就是为了组装出这样的一个 tuple，然后继续在 pipeline 中传递。比如总共有 5 个 FMAccount，当第一个 FMAccount 下载完数据(或者失败)的时候，这个 tuple 的值是 (1, 5, 第一个 FMAccount 对象的指针)，当第二个 FMAccount 下载完数据(或者失败)的时候，返回的 tuple 的值是 (2, 5, 第二个 FMAccount 对象的指针)，依次类推，后续还会返回 3 个 tuple。</li>
<li>前面已经组装出进度信息了，但是对于 UI 来说，这种进度信息还是太粗糙了，为了让 UI 上的进度条能够更平滑的进行动画过渡，还应该插入一些更细粒度的进度信息。这里借助 RAC 的定时器来构造出一种和 10 里面的 tuple 具有相同格式的 tuple 数据。关于这部分定时器的 pipeline，和 <a href="http://fengjian0106.github.io/2016/04/17/The-Power-Of-Composition-In-FRP-Part-1/#发送验证码的倒计时按钮">发送验证码的倒计时按钮</a> 里面的 pipeline 是相似的形状的，可以看看之前的介绍。</li>
<li>为了和 10 里面返回的 tuple 具有同样的格式，这里需要这样组装数据，按照顺序，这里返回的 tuple 依次将会是 (1, 120, nil)、(2, 120, nil)、(3, 120, nil)，依次类推，直到 (120, 120, nil)。</li>
<li>终于到了 pipeline 的最终输出了，把 tuple 里面的数据先分别取出来，如果 account 不为 nil，则是通过 fetchAllInitialData 计算出来的进度信息，如果 account 为 nil，则对应通过定时器模拟出来的进度信息。假设最终的进度值会达到 100，这里还需要采用适当的手段将两种不同的进度值融合在一起，现在就是用最简单的办法进行的处理。</li>
<li>如果定时器返回的 tuple 已经达到 (120, 120, nil)，而 fetchAllInitialData 还没有执行结束，这种情况下，不应该让进度值达到 100，必须得等所有的 fetchAllInitialData 都结束后进度值才能是 100，所以这里做一个约束，定时器模拟出的进度值，最大只能达到 95。</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/03/The-Power-Of-Composition-In-FRP-Part-4/" itemprop="url">
                  用 ReactiveCocoa 事半功倍的写代码（四）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-03T14:42:56+08:00" content="2016-05-03">
              2016-05-03
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/03/The-Power-Of-Composition-In-FRP-Part-4/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/03/The-Power-Of-Composition-In-FRP-Part-4/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="监听系统截屏操作的复杂管道"><a href="#监听系统截屏操作的复杂管道" class="headerlink" title="监听系统截屏操作的复杂管道"></a>监听系统截屏操作的复杂管道</h3><p>这是一个很复杂的 Pipeline，因为要做的业务比较繁琐，如下图：</p>
<p><img src="/images/monitor_screenshot.png" alt="monitor screenshot"></p>
<p>需求大致可以描述为：</p>
<ol>
<li>当 app 停留在读信页面的时候，要实时的监听用户是否有截屏操作。</li>
<li>在 1 的基础上，只有 app 前台运行的时候，才实时监听用户是否有截屏操作，如果是后台状态，则不监听。</li>
<li>如果用户有截图动作，则将截图内容显示在一个预览视图内(如上图中红框区域)。</li>
<li>如果用户点击了预览视图，则进入后续的业务流程，对截图进行涂鸦编辑等等。</li>
<li>如果点击了预览视图的外部区域，则隐藏预览视图。</li>
<li>如果 10 秒钟之内没有任何操作，也自动隐藏预览视图。</li>
</ol>
<p>主要的代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//13</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    [<span class="keyword">self</span> initPipeline];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initPipeline &#123;</span><br><span class="line">    <span class="comment">//1</span></span><br><span class="line">    RACSignal *isNotActive = [[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationWillResignActiveNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">                              map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">                                  <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                              &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *isActive = [[[[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationDidBecomeActiveNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">                             map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">                                 <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                             &#125;]</span><br><span class="line">                            startWith:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]]</span><br><span class="line">                           merge:isNotActive];</span><br><span class="line">    </span><br><span class="line">    RACSignal *isNotInBackground = [[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationDidEnterBackgroundNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">                                    map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                                    &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *isInForeground = [[[[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationWillEnterForegroundNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">                                   map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">                                       <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                   &#125;]</span><br><span class="line">                                  startWith:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]]</span><br><span class="line">                                 merge:isNotInBackground];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2</span></span><br><span class="line">    RACSignal *didTakeScreenshot = [<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationUserDidTakeScreenshotNotification</span> object:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    RACSignal *imageSignal = [[[[[[[RACSignal <span class="keyword">if</span>:[RACSignal merge:@[isInForeground, isActive]] then:didTakeScreenshot <span class="keyword">else</span>:[RACSignal never]] <span class="comment">//3</span></span><br><span class="line">                                   takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal]</span><br><span class="line">                                  filter:^<span class="built_in">BOOL</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                      <span class="comment">//4</span></span><br><span class="line">                                      @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                      <span class="keyword">return</span> [<span class="keyword">self</span> filterScreenshotNotification];</span><br><span class="line">                                  &#125;]</span><br><span class="line">                                 filter:^<span class="built_in">BOOL</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                     <span class="comment">//5</span></span><br><span class="line">                                     @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                     <span class="keyword">return</span> <span class="keyword">self</span>.previewShotView == <span class="literal">nil</span>;</span><br><span class="line">                                 &#125;]</span><br><span class="line">                                map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">                                    <span class="comment">//6</span></span><br><span class="line">                                    @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                    <span class="keyword">return</span> [<span class="keyword">self</span> takeCurrentScreenshotOfWebview];</span><br><span class="line">                                &#125;]</span><br><span class="line">                               multicast:[RACReplaySubject subject]]</span><br><span class="line">                              autoconnect];<span class="comment">//7</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//8</span></span><br><span class="line">    RACSignal *hotSignalForPreview = [[[imageSignal</span><br><span class="line">                                        map:^<span class="keyword">id</span>(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">                                            @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                            <span class="keyword">return</span> [<span class="keyword">self</span> showScreenshotPreviewView:image];</span><br><span class="line">                                        &#125;]</span><br><span class="line">                                       multicast:[RACReplaySubject subject]]</span><br><span class="line">                                      autoconnect];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//9</span></span><br><span class="line">    RACSignal *cancel = [[hotSignalForPreview</span><br><span class="line">                          map:^<span class="keyword">id</span>(FMScreenshotPreviewView *previewView) &#123;</span><br><span class="line">                              <span class="keyword">return</span> [previewView.cancelSignal</span><br><span class="line">                                      map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                          <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">                                      &#125;];</span><br><span class="line">                          &#125;]</span><br><span class="line">                         switchToLatest];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//10</span></span><br><span class="line">    RACSignal *editImage = [[hotSignalForPreview</span><br><span class="line">                             map:^<span class="keyword">id</span>(FMScreenshotPreviewView *previewView) &#123;</span><br><span class="line">                                 <span class="keyword">return</span> [previewView.editImage</span><br><span class="line">                                         map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                             <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">                                         &#125;];</span><br><span class="line">                             &#125;]</span><br><span class="line">                            switchToLatest];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//11</span></span><br><span class="line">    RACSignal *otherActionForHidePreview = [[hotSignalForPreview</span><br><span class="line">                                             map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                                 RACSignal *willResignActive = [[[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIApplicationWillResignActiveNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">                                                                                 take:<span class="number">1</span>]</span><br><span class="line">                                                                                takeUntil:[RACSignal merge:@[cancel, editImage]]];</span><br><span class="line">                                                 </span><br><span class="line">                                                 RACSignal *timeout = [[[RACSignal <span class="keyword">return</span>:<span class="literal">nil</span>]</span><br><span class="line">                                                                        delay:<span class="number">10.0</span>]</span><br><span class="line">                                                                       takeUntil:[RACSignal merge:@[cancel, editImage, willResignActive]]];</span><br><span class="line">                                                 </span><br><span class="line">                                                 </span><br><span class="line">                                                 <span class="keyword">return</span> [[RACSignal merge:@[timeout, willResignActive]]</span><br><span class="line">                                                         take:<span class="number">1</span>];</span><br><span class="line">                                             &#125;]</span><br><span class="line">                                            switchToLatest];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//12</span></span><br><span class="line">    RACSignal *shouldHidePreviewView = [RACSignal merge:@[cancel, editImage, otherActionForHidePreview]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//13</span></span><br><span class="line">    RACSignal *viewWillDisappear = [<span class="keyword">self</span> rac_signalForSelector:<span class="keyword">@selector</span>(viewWillDisappear:)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//14</span></span><br><span class="line">    [[[shouldHidePreviewView</span><br><span class="line">       zipWith:hotSignalForPreview]</span><br><span class="line">      takeUntil:viewWillDisappear]<span class="comment">//13</span></span><br><span class="line">     subscribeNext:^(RACTuple *tuple) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         [<span class="keyword">self</span> hideScreenshotPreviewView:tuple];</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//15</span></span><br><span class="line">    [[[imageSignal sample:editImage]</span><br><span class="line">      takeUntil:viewWillDisappear]</span><br><span class="line">     subscribeNext:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         [<span class="keyword">self</span> showDrawViewController:image];</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码有点长，而且里面的 signal 也比较多，主要是下面这些点：</p>
<ol>
<li>把 app 的 avtive、background、foreground 状态用 signal 的形式表达出来，使用 merge 操作把互为相反状态的 signal 合并在了一起，注意，还使用了 startWith 操作提供初始值。</li>
<li>这个 signal 是真正的截屏操作，它仅仅是整个 Pipeline 中的一个小环节。</li>
<li>因为只有 app 前台运行的时候才需要监听截屏事件，所以这里用 if/else 操作做第一层过滤。</li>
<li>这里是第二层过滤，因为这个 ViewController 里面有很多功能，可能会出现一些页面层叠的情况，比如显示了一个 UIActionSheet 或自定义的菜单选项等等，这个时候，也是不需要监听截屏事件的。</li>
<li>self.previewShotView 就是显示预览图的 view，当已经有一个预览图正在显示的时候，也不需要监听截屏事件。</li>
<li>终于过滤完了，按照产品的需求，并不是从系统相册里把用户刚才的截图找出来，而是在 app 中自行截图一遍(只截取有效区域，不截取导航栏和工具栏区域)，takeCurrentScreenshotOfWebview 方法返回的就是截图得到的 UIImage。</li>
<li>Pipeline 的后续部分，不止一处会用到前面得到的 UIImage，所以需要 hot signal。</li>
<li>显示预览 view，同时在 Pipeline 中传递这个 view，这个也是 hot signal。</li>
<li>点击预览 view 外部区域的时候，会发送 cancelSignal signal，因为形成了 signal 的嵌套，所以要通过 switchToLatest 取出来。</li>
<li>类似的，点击预览 view 的时候，会发送 editImage signal，也是通过 switchToLatest 取出来。</li>
<li>当已经显示了一个预览 view 的时候，如果超过10秒没有任何操作，或者 app 进入了不活跃状态，也是需要隐藏预览 view 的，这里组装出对应的 signal。注意这里是如何通过 takeUntil 控制 willResignActive 和 timeout 的生命期的。</li>
<li>用 merge 操作组装出最终用来隐藏预览 view 的 signal。</li>
<li>把这个 ViewController 的 viewWillDisappear 转换成 signal 的形式。根据需求，只有这个 ViewController 可见的时候，才监听截图事件，所以，在 viewDidAppear 的时候构造 Pipeline，在 viewWillDisappear 的时候释放 Pipeline。</li>
<li>这里是隐藏预览 view 的具体逻辑。</li>
<li>当点击了预览 view 的时候，通过 showDrawViewController 方法进入后续的业务逻辑，这里使用了 <a href="http://rxmarbles.com/#sample" target="_blank" rel="noopener">sample</a> 操作。</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/28/The-Power-Of-Composition-In-FRP-Part-3/" itemprop="url">
                  用 ReactiveCocoa 事半功倍的写代码（三）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-28T11:31:36+08:00" content="2016-04-28">
              2016-04-28
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/28/The-Power-Of-Composition-In-FRP-Part-3/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/28/The-Power-Of-Composition-In-FRP-Part-3/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="collect-combineLatest-或者-zip"><a href="#collect-combineLatest-或者-zip" class="headerlink" title="collect + combineLatest 或者 zip"></a>collect + combineLatest 或者 zip</h3><p>RAC 里面的 <a href="http://reactivex.io/documentation/operators/to.html" target="_blank" rel="noopener">collect</a> 是一个比较容易理解的操作，它的强大之处，在于和其他的操作进行组合之后，可以完成很复杂的业务逻辑。在看真实业务代码之前，先通过下面的代码初步了解一下这种 Pipeline 的行为模式。<code>collect 相当于 Rx 中的 ToArray 操作</code></p>
<h4 id="版本-1"><a href="#版本-1" class="headerlink" title="版本 1"></a>版本 1</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCollectSignalsAndCombineLatestOrZip &#123;</span><br><span class="line">    <span class="comment">//1</span></span><br><span class="line">    RACSignal *numbers = @[@(<span class="number">0</span>), @(<span class="number">1</span>), @(<span class="number">2</span>)].rac_sequence.signal;</span><br><span class="line">    </span><br><span class="line">    RACSignal *letters1 = @[<span class="string">@"A"</span>, <span class="string">@"B"</span>, <span class="string">@"C"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters2 = @[<span class="string">@"X"</span>, <span class="string">@"Y"</span>, <span class="string">@"Z"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters3 = @[<span class="string">@"M"</span>, <span class="string">@"N"</span>].rac_sequence.signal;</span><br><span class="line">    <span class="built_in">NSArray</span> *arrayOfSignal = @[letters1, letters2, letters3]; <span class="comment">//2</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [[[numbers</span><br><span class="line">       map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *n) &#123;</span><br><span class="line">           <span class="comment">//3</span></span><br><span class="line">           <span class="keyword">return</span> arrayOfSignal[n.integerValue];</span><br><span class="line">       &#125;]</span><br><span class="line">      collect]  <span class="comment">//4</span></span><br><span class="line">     subscribeNext:^(<span class="built_in">NSArray</span> *array) &#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"%@, %@"</span>, [array <span class="keyword">class</span>], array);</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"completed"</span>);</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码纯粹只是为了演示 collect 的行为模式：</p>
<ol>
<li>构造一个 NSNumber 的数组，包含数字 0、1、2，并且转换成 signal。</li>
<li>用同样的方法，构造 3 个字符串的数组，并转换成 signal，再把得到的 3 个 signal 放到数组 arrayOfSignal 中。</li>
<li>这里形成了一个 signal 的嵌套，但是和以前的处理方式不一样，并不会直接在后续环节中使用 flatten 操作，而是先使用 collect。</li>
<li>collect 操作会把 Pipeline 中所有的 next 发送的数据收集到一个 NSArray 中，然后一次性通过 next 发送给后续的环节。</li>
</ol>
<p>这段代码的执行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2016-04-28 17:45:38:034 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] __NSArrayM, (</span><br><span class="line">    &quot;&lt;RACDynamicSignal: 0x7ffee1c9dc10&gt; name: &quot;,</span><br><span class="line">    &quot;&lt;RACDynamicSignal: 0x7ffee1c9dda0&gt; name: &quot;,</span><br><span class="line">    &quot;&lt;RACDynamicSignal: 0x7ffee1c9df20&gt; name: &quot;</span><br><span class="line">)</span><br><span class="line">2016-04-28 17:45:38:034 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] completed</span><br></pre></td></tr></table></figure>
<p>可以看到，array 里面包含的是 3 个 signal。另外，因为 signal 已经形成嵌套了，所以迟早是要 flatten 的，那么如何 flatten 呢？</p>
<h4 id="版本-2"><a href="#版本-2" class="headerlink" title="版本 2"></a>版本 2</h4><p>因为 array 里面有 3 个 signal，所以可以构造一种 Pipeline，把这 3 个 signal 合并成一个 signal，然后对合并后的 signal 再做 flatten 操作。合并的时候，可以有不同的策略，先看下面这段代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCollectSignalsAndCombineLatestOrZip &#123;</span><br><span class="line">    RACSignal *numbers = @[@(<span class="number">0</span>), @(<span class="number">1</span>), @(<span class="number">2</span>)].rac_sequence.signal;</span><br><span class="line">    </span><br><span class="line">    RACSignal *letters1 = @[<span class="string">@"A"</span>, <span class="string">@"B"</span>, <span class="string">@"C"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters2 = @[<span class="string">@"X"</span>, <span class="string">@"Y"</span>, <span class="string">@"Z"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters3 = @[<span class="string">@"M"</span>, <span class="string">@"M"</span>].rac_sequence.signal;</span><br><span class="line">    <span class="built_in">NSArray</span> *arrayOfSignal = @[letters1, letters2, letters3];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [[[[numbers</span><br><span class="line">        map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *n) &#123;</span><br><span class="line">            <span class="keyword">return</span> arrayOfSignal[n.integerValue];</span><br><span class="line">        &#125;]</span><br><span class="line">       collect]</span><br><span class="line">      flattenMap:^RACStream *(<span class="built_in">NSArray</span> *arrayOfSignal) &#123;</span><br><span class="line">          <span class="comment">//1</span></span><br><span class="line">          <span class="keyword">return</span> [RACSignal combineLatest:arrayOfSignal</span><br><span class="line">                                   reduce:^(<span class="built_in">NSString</span> *first, <span class="built_in">NSString</span> *second, <span class="built_in">NSString</span> *third) &#123;</span><br><span class="line">                                       <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@-%@-%@"</span>, first, second, third];</span><br><span class="line">                                   &#125;];</span><br><span class="line">      &#125;]</span><br><span class="line">     subscribeNext:^(<span class="built_in">NSString</span> *x) &#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"%@, %@"</span>, [x <span class="keyword">class</span>], x);</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"completed"</span>);</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码在接收到 collect 发送的 array 之后，对这个数组里面的 signal 进行了一个 <a href="http://rxmarbles.com/#combineLatest" target="_blank" rel="noopener">combineLatest</a> 操作，这个时候，原本的 3 个 signal 被 reduce 成了一个 signal，这个 signal 继续被 flatten 一次，然后最终被 Pipeline 的订阅者接收到。</p>
<p>这段代码的执行结果如下(也可能和下面的结果完全不一样，这是正常的，combineLatest 操作就是这样)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2016-04-28 18:48:14:453 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] NSTaggedPointerString, A-Z-N</span><br><span class="line">2016-04-28 18:48:14:453 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] NSTaggedPointerString, B-Z-N</span><br><span class="line">2016-04-28 18:48:14:454 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] NSTaggedPointerString, C-Z-N</span><br><span class="line">2016-04-28 18:48:14:455 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] completed</span><br></pre></td></tr></table></figure>
<h4 id="版本-3"><a href="#版本-3" class="headerlink" title="版本 3"></a>版本 3</h4><p>除了 combineLatest，<a href="http://rxmarbles.com/#zip" target="_blank" rel="noopener">zip</a> 操作也可以把多个 signal reduce 成一个，但是 zip 的策略是不一样的。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)testCollectSignalsAndCombineLatestOrZip &#123;</span><br><span class="line">    RACSignal *numbers = @[@(<span class="number">0</span>), @(<span class="number">1</span>), @(<span class="number">2</span>)].rac_sequence.signal;</span><br><span class="line">    </span><br><span class="line">    RACSignal *letters1 = @[<span class="string">@"A"</span>, <span class="string">@"B"</span>, <span class="string">@"C"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters2 = @[<span class="string">@"X"</span>, <span class="string">@"Y"</span>, <span class="string">@"Z"</span>].rac_sequence.signal;</span><br><span class="line">    RACSignal *letters3 = @[<span class="string">@"M"</span>, <span class="string">@"M"</span>].rac_sequence.signal;</span><br><span class="line">    <span class="built_in">NSArray</span> *arrayOfSignal = @[letters1, letters2, letters3];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    [[[[numbers</span><br><span class="line">        map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *n) &#123;</span><br><span class="line">            <span class="keyword">return</span> arrayOfSignal[n.integerValue];<span class="comment">//!! this is Signal, but just use map NOT flatMap</span></span><br><span class="line">        &#125;]</span><br><span class="line">       collect]</span><br><span class="line">      flattenMap:^RACStream *(<span class="built_in">NSArray</span> *arrayOfSignal) &#123;</span><br><span class="line">          <span class="comment">//1</span></span><br><span class="line">          <span class="keyword">return</span> [RACSignal zip:arrayOfSignal</span><br><span class="line">                         reduce:^(<span class="built_in">NSString</span> *first, <span class="built_in">NSString</span> *second, <span class="built_in">NSString</span> *third) &#123;</span><br><span class="line">                             <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@-%@-%@"</span>, first, second, third];</span><br><span class="line">                             </span><br><span class="line">                         &#125;];</span><br><span class="line">      &#125;]</span><br><span class="line">     subscribeNext:^(<span class="built_in">NSString</span> *x) &#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"%@, %@"</span>, [x <span class="keyword">class</span>], x);</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         DDLogVerbose(<span class="string">@"completed"</span>);</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的执行结果是下面这个样子，不像前面的 combineLatest，zip 操作的结果，只能出现下面这种唯一的情况：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2016-04-28 18:55:01:208 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] NSTaggedPointerString, A-X-M</span><br><span class="line">2016-04-28 18:55:01:209 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] NSTaggedPointerString, B-Y-N</span><br><span class="line">2016-04-28 18:55:01:209 [com.ReactiveCocoa.RACScheduler.backgroundScheduler] completed</span><br></pre></td></tr></table></figure>
<h3 id="保存联系人的头像"><a href="#保存联系人的头像" class="headerlink" title="保存联系人的头像"></a>保存联系人的头像</h3><p>前面的代码很抽象，在业务中，能用上这种 Pipeline 吗？当然是可以的，比如下面这段代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- (RACSignal *)savaAvatar:(<span class="built_in">UIImage</span> *)image withContact:(FMContact *)contact &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(image != <span class="literal">nil</span>);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(contact.contactItems.count &gt; <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1</span></span><br><span class="line">    RACSignal *addrs = [[contact.contactItems.rac_sequence</span><br><span class="line">                         map:^(FMContactItem *contactItem) &#123;</span><br><span class="line">                             <span class="keyword">return</span> contactItem.email;</span><br><span class="line">                         &#125;]</span><br><span class="line">                        signal];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [[[[addrs</span><br><span class="line">               map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *emailAddr) &#123;</span><br><span class="line">                   <span class="keyword">return</span> [[[[FMAvatarManager shareInstance] rac_setAvatar:emailAddr image:image] <span class="comment">//2</span></span><br><span class="line">                            map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                                <span class="comment">//4</span></span><br><span class="line">                                <span class="keyword">return</span> RACTuplePack(value, <span class="literal">nil</span>);</span><br><span class="line">                            &#125;]</span><br><span class="line">                           catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                               <span class="comment">//3</span></span><br><span class="line">                               <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:RACTuplePack(<span class="literal">nil</span>, error)];</span><br><span class="line">                           &#125;];</span><br><span class="line">               &#125;]</span><br><span class="line">              collect]  <span class="comment">//5</span></span><br><span class="line">             flattenMap:^RACStream *(<span class="built_in">NSArray</span>&lt;RACSignal *&gt; *arrayOfSignal) &#123;             </span><br><span class="line">                 <span class="keyword">return</span> [[RACSignal zip:arrayOfSignal]  <span class="comment">//6</span></span><br><span class="line">                         map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;     <span class="comment">//7</span></span><br><span class="line">                             <span class="comment">//8</span></span><br><span class="line">                             <span class="keyword">return</span> [tuple allObjects];</span><br><span class="line">                         &#125;];</span><br><span class="line">             &#125;]</span><br><span class="line">            map:^<span class="keyword">id</span>(<span class="built_in">NSArray</span>&lt;RACTuple *&gt; *value) &#123;</span><br><span class="line">                <span class="comment">//9</span></span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码稍微有点复杂，做的事情是让 FMContact 里面的所有 email 地址，和一个 image 关联在一起，并且保存在服务器端，关键是下面这几个点：</p>
<ol>
<li>把 contact.contactItems 里面所有的 email 转换成 signal 的形式发送出来。</li>
<li>每次 map 的时候，得到一个 email 地址，调用 [[FMAvatarManager shareInstance] rac_setAvatar:emailAddr image:image] 让 email 地址和 image 关联在一起，这个接口也是返回一个 signal，当成功的时候，next 里面发送一个 value (业务中并不关心这个 value 的具体值，只关心是否成功)，如果失败，则会发送一个 error。如果不对 error 做特殊处理，当遇到一次 error 的时候，会使整个 Pipeline error，有些业务需要这种处理 error 的默认方式 (n 个小任务中，任何一个出现 error，整个 Pipeline 都要 error)，但是我们这里的业务，并不想要这种效果，如果一个 email 上的操作失败了，不希望整个 Pipeline 因为这个 error 而结束，而是要其余的 email 地址继续执行各自的小任务，等所有的 email 都处理完毕后，再由 Pipeline 的订阅者一起处理所有的 error，这个时候，就需要用到 catch 操作了。<code>这里有一个槽点，rac_setAvatar 每次都需要传入 image 和 email 地址，然后调用服务器接口进行保存操作，这种方式的接口，不够优雅，对于每一个 email 地址，都要重新发送一遍 image，也有点浪费流量，这是一个历史原因造成的问题。更好的方案是，先把 image 上传到服务器端，然后得到这个 image 对应的一个唯一值，比如 id，然后在这里，只需要让这个 image 的 id 和 email 能够关联起来就行了。不过这并不影响这里 Pipeline 的设计，不管是 image 还是 id，Pipeline 的形状是没有区别的。</code></li>
<li>在 catch 里面，用新的 signal 替换原有的 signal。因为需要把 error 暂存下来，放到最后再做处理，所以，用 RACTuple 把 error 包装起来并且发送出去。</li>
<li>虽然目前的业务，并不关心 [[FMAvatarManager shareInstance] rac_setAvatar:emailAddr image:image] 发送的 next 数据，但是，把 next 发送的数据和 error 一起用 RACTuple 包装起来，也是一个合理的设计(万一以后需要用到这个值了呢)，当接收到 next 的时候，error 就是 nil，当发生 error 的时候，相当于 next 就是 nil，所以在这里，返回的是 RACTuplePack(value, nil)，而在前面 3 中，返回的是 RACTuplePack(nil, error)。</li>
<li>使用 collect 操作。注意，前面 map 操作返回的是一个 signal，signal 的 next 发送的是一个 RACTuple，而 collect 发送的 next 是 NSArray&lt;RACSignal *&gt;。</li>
<li>前面的 map 已经形成了 signal 的嵌套，而且还通过 collect 把嵌套的 signal 放到了数组里面，所以这里需要先把数组里的 signal 合并成一个，然后再 flatten 出来。zip 操作符合我们的需求。</li>
<li>这里不像前面的代码演示那样使用 + (instancetype)zip:(id&lt;NSFastEnumeration&gt;)streams reduce:(id (^)())reduceBlock 接口，而是先使用 + (instancetype)zip:(id&lt;NSFastEnumeration&gt;)streams，然后 map，因为前一种 zip，输入参数 streams(数组) 中包含的元素的数量是已知的，所以可以直接在 reduce(变参数方法) 中把所有的参数都罗列出来，我们这里的 Pipeline，arrayOfSignal 里面的元素个数是不固定的，所以只能用原始的 zip 接口，然后在 map 中再进一步处理 zip 发送的 RACTuple。</li>
<li>在这个 map 里面得到的 RACTuple 是 zip 操作返回的，这个 tuple 里面包含的每一个数据，是前面 4 里面返回的 RACTuple，这里的 RACTuple 里面又包含了 RACTuple，千万不要搞晕了。如果没搞清楚这里的数据到底是怎么来的，可以再倒回去看看前面的步骤。为了方便后续的处理，可以把外层 RACTuple 里面的数据放到一个 NSArray 里面，然后再返回给下一个环节。[tuple allObjects] 就是做的这个动作(其实 RACTuple 的内部，就是用 NSArray 存储的数据)。</li>
<li>直接把 value 返回，让 Pipeline 的订阅者得到最终的结果。这里没有做任何额外的动作，仅仅是为了说明现在得到的数据是一个 NSArray&lt;RACTuple *&gt;。可以在这里加一些日志，方便调试。不执行这一次 map 操作也是可以的。</li>
</ol>
<h3 id="表单页面"><a href="#表单页面" class="headerlink" title="表单页面"></a>表单页面</h3><p>再看另外一个真实业务，如下图：</p>
<p><img src="/images/edit_contact.png" alt="edit contact"></p>
<p>这是一个编辑联系人的页面，整体是用 UITableView 实现的，可以动态的增加、删减字段，其中有一个需求，只有当至少有一个字段有数据的时候，右上角的『保存』按钮才可以使用。如果这个页面，不需要动态的增加、删减字段，那这个需求是很容易实现的，如果不使用 UITableView，就算要动态的增加、删减字段，这个需求实现起来也还好，不会很困难。但是现在的问题在于，要在 UITableView 的基础上实现，这就有点复杂了，UITableViewCell 是在复用的，所以不能直接依赖 UITableViewCell 里面的 UITextField 来判断『保存』按钮是否可用，必须严格的使用 MVC 的思路，先把 UI 上所有的操作(增加、删减字段，编辑字段内容)都映射到 model 上，通过 model 再来计算『保存』按钮是否可用。UITableView 的代码，是传统代码和 RAC 混合编写的，RAC 做的事情并不多，主要是把 UITextField 的内容用 signal 发送出来，因为并不复杂(但是也挺繁琐的，产品还提了很多很细节的体验要求)，所以这里不详细讨论，主要还是看一下基于 model 构造的 Pipeline：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)initPipline &#123;</span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="comment">//1</span></span><br><span class="line">    RACSignal *emailsIsNil = [[RACObserve(<span class="keyword">self</span>.contact, contactItems) <span class="comment">//2</span></span><br><span class="line">                               flattenMap:^<span class="keyword">id</span>(<span class="built_in">NSMutableArray</span> *items) &#123;</span><br><span class="line">                                   <span class="keyword">if</span> (items.count == <span class="number">0</span>) &#123; <span class="comment">//3</span></span><br><span class="line">                                       <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]];</span><br><span class="line">                                   &#125;</span><br><span class="line">                                   </span><br><span class="line">                                   <span class="comment">//4</span></span><br><span class="line">                                   <span class="keyword">return</span> [[[items.rac_sequence.signal</span><br><span class="line">                                             map:^<span class="keyword">id</span>(FMContactItem *item) &#123;</span><br><span class="line">                                                 <span class="keyword">return</span> [[RACObserve(item, email)  <span class="comment">//5</span></span><br><span class="line">                                                          distinctUntilChanged]    <span class="comment">//6</span></span><br><span class="line">                                                         map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *email) &#123;</span><br><span class="line">                                                             <span class="comment">//7</span></span><br><span class="line">                                                             <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:(email.length == <span class="number">0</span>)];</span><br><span class="line">                                                         &#125;];</span><br><span class="line">                                             &#125;]</span><br><span class="line">                                            collect]  <span class="comment">//8</span></span><br><span class="line">                                           flattenMap:^<span class="keyword">id</span>(<span class="built_in">NSArray</span> *arrayOfBoolSignal) &#123;</span><br><span class="line">                                               <span class="keyword">return</span> [[[RACSignal combineLatest:arrayOfBoolSignal]  <span class="comment">//9</span></span><br><span class="line">                                                        map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                                                            <span class="comment">//10</span></span><br><span class="line">                                                            <span class="built_in">BOOL</span> b = <span class="literal">YES</span>;</span><br><span class="line">                                                            <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; tuple.count; i++) &#123;</span><br><span class="line">                                                                <span class="built_in">NSNumber</span> *n = [tuple objectAtIndex:i];</span><br><span class="line">                                                                b = b &amp;&amp; n.boolValue;</span><br><span class="line">                                                            &#125;</span><br><span class="line">                                                            <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:b];</span><br><span class="line">                                                        &#125;]</span><br><span class="line">                                                       distinctUntilChanged];  <span class="comment">//11</span></span><br><span class="line">                                           &#125;];</span><br><span class="line">                               &#125;]</span><br><span class="line">                              distinctUntilChanged];  <span class="comment">//11</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//12</span></span><br><span class="line">    RACSignal *phonesIsNil = [[RACObserve(<span class="keyword">self</span>.contact, telephone)</span><br><span class="line">                               map:^<span class="keyword">id</span>(<span class="built_in">NSMutableArray</span> *phones) &#123;</span><br><span class="line">                                   <span class="keyword">if</span> (phones.count == <span class="number">0</span>) &#123;</span><br><span class="line">                                       <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                   &#125;</span><br><span class="line">                                   </span><br><span class="line">                                   <span class="keyword">for</span> (<span class="built_in">NSString</span> *phone <span class="keyword">in</span> phones) &#123;</span><br><span class="line">                                       <span class="keyword">if</span> (phone.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                           <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125;</span><br><span class="line">                                   </span><br><span class="line">                                   <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                               &#125;]</span><br><span class="line">                              distinctUntilChanged];</span><br><span class="line">    </span><br><span class="line">    RACSignal *addressIsNil = [[RACObserve(<span class="keyword">self</span>.contact, familyAddress)</span><br><span class="line">                                map:^<span class="keyword">id</span>(<span class="built_in">NSMutableArray</span> *addrs) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (addrs.count == <span class="number">0</span>) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="keyword">for</span> (<span class="built_in">NSString</span> *addr <span class="keyword">in</span> addrs) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (addr.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                            <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    </span><br><span class="line">                                    <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                &#125;]</span><br><span class="line">                               distinctUntilChanged];</span><br><span class="line">    </span><br><span class="line">    RACSignal *customInfosIsNil = [[RACObserve(<span class="keyword">self</span>.contact, customInformations)</span><br><span class="line">                                    flattenMap:^<span class="keyword">id</span>(<span class="built_in">NSMutableArray</span> *infos) &#123;</span><br><span class="line">                                        <span class="keyword">if</span> (infos.count == <span class="number">0</span>) &#123;</span><br><span class="line">                                            <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]];</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        </span><br><span class="line">                                        <span class="keyword">return</span> [[[infos.rac_sequence.signal</span><br><span class="line">                                                  map:^<span class="keyword">id</span>(FMCustomInformation *info) &#123;</span><br><span class="line">                                                      RACSignal *nameSignal = [[RACObserve(info, name)</span><br><span class="line">                                                                                distinctUntilChanged]</span><br><span class="line">                                                                               map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *name) &#123;</span><br><span class="line">                                                                                   <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:(name.length == <span class="number">0</span>)];</span><br><span class="line">                                                                               &#125;];</span><br><span class="line">                                                      </span><br><span class="line">                                                      RACSignal *infoSignal = [[RACObserve(info, information)</span><br><span class="line">                                                                                distinctUntilChanged]</span><br><span class="line">                                                                               map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *i) &#123;</span><br><span class="line">                                                                                   <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:(i.length == <span class="number">0</span>)];</span><br><span class="line">                                                                               &#125;];</span><br><span class="line">                                                      </span><br><span class="line">                                                      <span class="keyword">return</span> [RACSignal combineLatest:@[nameSignal, infoSignal]</span><br><span class="line">                                                                               reduce:(<span class="keyword">id</span>)^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *name, <span class="built_in">NSNumber</span> *info)&#123;</span><br><span class="line">                                                                                   <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:(name.boolValue &amp;&amp; info.boolValue)];</span><br><span class="line">                                                                               &#125;];</span><br><span class="line">                                                      </span><br><span class="line">                                                  &#125;]</span><br><span class="line">                                                 collect]</span><br><span class="line">                                                flattenMap:^<span class="keyword">id</span>(<span class="built_in">NSArray</span> *arrayOfBoolSignal) &#123;</span><br><span class="line">                                                    <span class="keyword">return</span> [[[RACSignal combineLatest:arrayOfBoolSignal]</span><br><span class="line">                                                             map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                                                                 <span class="built_in">BOOL</span> b = <span class="literal">YES</span>;</span><br><span class="line">                                                                 <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; tuple.count; i++) &#123;</span><br><span class="line">                                                                     <span class="built_in">NSNumber</span> *n = [tuple objectAtIndex:i];</span><br><span class="line">                                                                     b = b &amp;&amp; n.boolValue;</span><br><span class="line">                                                                 &#125;</span><br><span class="line">                                                                 <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:b];</span><br><span class="line">                                                             &#125;]</span><br><span class="line">                                                            distinctUntilChanged];</span><br><span class="line">                                                &#125;];</span><br><span class="line">                                    &#125;]</span><br><span class="line">                                   distinctUntilChanged];</span><br><span class="line">    </span><br><span class="line">    RACSignal *nickIsNil = [[RACObserve(<span class="keyword">self</span>.contact, nick)</span><br><span class="line">                             map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *nick) &#123;</span><br><span class="line">                                 @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                 <span class="keyword">if</span> (<span class="keyword">self</span>.contact.nick == <span class="literal">nil</span> || [<span class="keyword">self</span>.contact.nick isEqualToString:<span class="string">@""</span>] == <span class="literal">YES</span>) &#123;</span><br><span class="line">                                     <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                 &#125;</span><br><span class="line">                                 <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                             &#125;]</span><br><span class="line">                            distinctUntilChanged];</span><br><span class="line">    </span><br><span class="line">    RACSignal *markIsNil = [RACObserve(<span class="keyword">self</span>.contact, mark)</span><br><span class="line">                            map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *mark) &#123;</span><br><span class="line">                                @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">self</span>.contact.mark == <span class="literal">nil</span> || [<span class="keyword">self</span>.contact.mark isEqualToString:<span class="string">@""</span>] == <span class="literal">YES</span>) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                            &#125;];</span><br><span class="line">    </span><br><span class="line">    RACSignal *birthdayIsNil = [RACObserve(<span class="keyword">self</span>.contact, birthday)</span><br><span class="line">                                map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *birthday) &#123;</span><br><span class="line">                                    @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="keyword">self</span>.contact.birthday == <span class="literal">nil</span> || [<span class="keyword">self</span>.contact.birthday isEqualToString:<span class="string">@""</span>] == <span class="literal">YES</span>) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>];</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>];</span><br><span class="line">                                &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//13</span></span><br><span class="line">    <span class="built_in">NSArray</span> *allSignal = @[nickIsNil, emailsIsNil, markIsNil, phonesIsNil, addressIsNil, birthdayIsNil, customInfosIsNil];</span><br><span class="line">    <span class="keyword">self</span>.contactHasNoPros = [[[[RACSignal combineLatest:allSignal]  <span class="comment">//13</span></span><br><span class="line">                               map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                                   <span class="comment">//14</span></span><br><span class="line">                                   <span class="built_in">BOOL</span> b = <span class="literal">YES</span>;</span><br><span class="line">                                   <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = <span class="number">0</span>; i &lt; tuple.count; i++) &#123;</span><br><span class="line">                                       <span class="built_in">NSNumber</span> *n = [tuple objectAtIndex:i];</span><br><span class="line">                                       b = b &amp;&amp; n.boolValue;</span><br><span class="line">                                   &#125;</span><br><span class="line">                                   <span class="keyword">return</span> [<span class="built_in">NSNumber</span> numberWithBool:b];</span><br><span class="line">                               &#125;]</span><br><span class="line">                              distinctUntilChanged]</span><br><span class="line">                             deliverOnMainThread];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这部分代码有点长，不过不用恐惧，中间有很大一部分代码都是做的类似事情，只需要看其中的一个就行，以 email 字段为例子：</p>
<p><img src="/images/edit_email.png" alt="edit contact"></p>
<ol>
<li>联系人的字段，被划分为了好几个部分，比如 email 数组、电话号码数组、备注信息字段等等，每一部分的处理逻辑都是类似的，主要看一下 email 相关的部分。</li>
<li>当添加或删除 email 的时候，UITableView 部分的代码，已经在 FMContact.contactItems 数组上做了对应的动作，这里通过 RACObserve 对这个 model 进行 KVO，就可以获取到 FMContactItem 的数组。</li>
<li>如果用户删除了所有的 email 地址(FMContactItem 数组的元素个数为 0)，emailsIsNil 就应该为 YES，说明当前输入的 email 是没有值的。</li>
<li>如果 FMContactItem 数组的元素个数不为 0，则把这个数组里面的 FMContactItem 转换成 signal 的形式发送出去。</li>
<li>UI 模块会实时的更新 FMContactItem.email 字段，所以这里也是使用 RACObserve 监听 email 字段的值。</li>
<li><a href="http://rxmarbles.com/#distinctUntilChanged" target="_blank" rel="noopener">distinctUntilChanged</a> 操作相当于一种过滤，只有当这一次 next 发送的数据和前一次 next 发送的数据不一样的时候，才会把这次 next 发送的数据继续往后续环节传递。</li>
<li>拿到一个 email 地址的时候，只要这个 email 的长度大于 0，就认为这个字段是有值的(并没有进行 email 有效性检查，即便输入的 email 不合理，『保存』按钮仍然可用，只有点击『保存』按钮的时候，才会检查 email 是否合理有效，产品需求是设计成这样的)。</li>
<li>使用 collect。注意前面 5 所在的 map 操作，返回的是 signal，所以这里形成了 signal 的嵌套，然后 collect 又会把这些 signal 全部放到一个数组里面。</li>
<li>拿到 signal 的数组后，要把这些 signal 合并成一个，combineLatest 满足这里的需求。</li>
<li>这里实现具体的产品需求，比如现在有 n 个 email 的输入框，当所有的输入框都没有输入内容的时候，才认为 email 是没有值的，只要有任何一个 email 输入框有内容，都认为 email 是有值的。</li>
<li>这几个地方使用 distinctUntilChanged，都是为了避免不必要的 signal 数据传递。</li>
<li>这里好几个 signal，都是类似的思考思路和实现方式。</li>
<li>把不同的 *IsNil signal 放到一个数组里，用 combineLatest 把它们合并成一个。</li>
<li>和 10 类似，实现产品约定好的需求，当所有输入框都没有内容的时候，这个联系人就是没有值的(通过 self.contactHasNoPros 这个 signal 来传递这个 Bool 值)。</li>
</ol>
<p>上面这段代码，最终实现出了一个 signal，就是 contactHasNoPros，这个 signal 的订阅者，根据 next 发送的 Bool 值，设置 button 的状态就可以了，代码片段如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[<span class="keyword">self</span>.contactEditView.contactHasNoPros</span><br><span class="line">      not] <span class="comment">//1</span></span><br><span class="line">     subscribeNext:^(<span class="built_in">NSNumber</span> *x) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="keyword">self</span>.navigationItem.rightBarButtonItem.enabled = x.boolValue;</span><br><span class="line">     &#125;];</span><br></pre></td></tr></table></figure>
<p>因为 contactHasNoPros 发送 YES 的时候，表达的含义是联系人所有的字段都没有值，没有值的时候，『保存』按钮应该是不可用状态，所以这里用 not 操作先做一个 Bool 值的取反，然后再设置 button 的 enabled 状态。</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/26/The-Power-Of-Composition-In-FRP-Part-2/" itemprop="url">
                  用 ReactiveCocoa 事半功倍的写代码（二）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-26T10:38:03+08:00" content="2016-04-26">
              2016-04-26
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/26/The-Power-Of-Composition-In-FRP-Part-2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/26/The-Power-Of-Composition-In-FRP-Part-2/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="利用-map-组装顺序执行的业务"><a href="#利用-map-组装顺序执行的业务" class="headerlink" title="利用 map 组装顺序执行的业务"></a>利用 map 组装顺序执行的业务</h3><p>这其实应该是最常见的使用场景，有一类业务，是可以抽象成一组按顺序执行的串行任务的，比如下面这段代码</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ColdSignal&lt;NSString, NSError&gt;</span></span><br><span class="line"><span class="comment"> Completion: decode success;</span></span><br><span class="line"><span class="comment"> Error: FMBarCodeServiceErrorDomain || NSURLErrorDomain || RACSignalErrorDomain with RACSignalErrorTimedOut  //4</span></span><br><span class="line"><span class="comment"> Scheduler: specified;</span></span><br><span class="line"><span class="comment"> Multicast: NO;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (RACSignal *)decodeBarWithURLString: (<span class="built_in">NSString</span> *)urlString &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(urlString != <span class="literal">nil</span>);</span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">return</span> [[[<span class="keyword">self</span> getUIImageWithURLString:urlString]  <span class="comment">//1</span></span><br><span class="line">             flattenMap:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">                 @strongify(<span class="keyword">self</span>);</span><br><span class="line">                 <span class="keyword">return</span> [<span class="keyword">self</span> decodeBarWithUIImage:image];  <span class="comment">//2</span></span><br><span class="line">             &#125;]</span><br><span class="line">            timeout:<span class="number">1.5</span> onScheduler:[RACScheduler schedulerWithPriority:RACSchedulerPriorityDefault]];  <span class="comment">//3</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码做的事情并不复杂，就是传入一个图片的 url 地址，然后下载对应的图片，然后尝试对这张图片进行二维码解码：</p>
<ol>
<li>getUIImageWithURLString 里面完成的小任务，就是下载 UIImage。当下载失败的时候，会发出一个 NSURLErrorDomain 的 NSError。</li>
<li>这里的小任务，就是对前一步得到的 UIImage 进行二维码解码。当解码失败的时候，会发出一个 FMBarCodeServiceErrorDomain 的 NSError(自己的业务代码中定义的 error domain)。</li>
<li>这里的业务需求，是当用户长按一张图片的时候，弹出一个选项菜单，让用户可以选择合适的操作，比如『保存图片』，『转发图片』等等，同时，如果这张图片中能够识别出二维码，在弹出的选项菜单中，还要包含一项『识别图中二维码』。二维码解析是需要消耗一定的时间的，下载图片也是需要时间的，有些情况下，即便图片本身的确是一个二维码，但是二维码可能很复杂，解析的时间就会比较长，为了保证最佳的用户体验，这里需要做一个超时逻辑，如果 1.5 秒内都还没有解析出一个有效的二维码，则放弃当前的解析动作。<a href="http://reactivex.io/documentation/operators/timeout.html" target="_blank" rel="noopener">timeout</a> 操作就是针对这种场景的，当到达设定的超时时间时，如果还没有发送 Next 事件，则会在 Pipeline 中发送一个 RACSignalErrorDomain 的 NSError，error code 是 RACSignalErrorTimedOut。</li>
<li>这个 Pipeline 是由好几个小任务组合出来的，每一个环节都有可能发送 error，所以对于这个 Pipeline 的订阅者，捕获到的 NSError 会是好几个不同 Domain 的其中之一。</li>
</ol>
<p>这个 Pipeline 的订阅者的代码会是下面这种样子：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)jsCallImageClick:(<span class="built_in">NSString</span> *)imageUrl imageClickName:(<span class="built_in">NSString</span> *)imgClickName &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *components = [<span class="built_in">NSMutableArray</span> arrayWithArray:[imageUrl componentsSeparatedByString:<span class="string">@"&amp;qmSrc:"</span>]];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *temp = [<span class="built_in">NSMutableArray</span> arrayWithArray:[(<span class="built_in">NSString</span>*)[components firstObject] componentsSeparatedByString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"&amp;%@:"</span>,imgClickName]]];</span><br><span class="line">    [<span class="keyword">self</span> filterJsArray:temp];</span><br><span class="line">    <span class="built_in">NSString</span> *imageUrlString = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,(<span class="built_in">NSString</span> *)[temp firstObject]];</span><br><span class="line">    </span><br><span class="line">    RACSignal *barCodeStringSignal = [<span class="keyword">self</span>.barCodeService decodeBarWithURLString:imageUrlString];</span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    [[barCodeStringSignal</span><br><span class="line">      deliverOn:[RACScheduler mainThreadScheduler]]  <span class="comment">//1</span></span><br><span class="line">     subscribeNext:^(<span class="built_in">NSString</span> *barCodeString) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         [<span class="keyword">self</span> showImageSaveSheetWithImageUrl:imageUrl withImageClickName:imgClickName withBarCode:barCodeString];</span><br><span class="line">     &#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">         </span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         [<span class="keyword">self</span> showImageSaveSheetWithImageUrl:imageUrl withImageClickName:imgClickName withBarCode:<span class="literal">nil</span>];</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 decodeBarWithURLString 的内部在使用 timeout 的时候，已经通过 RACScheduler 切换到了后台线程，所以在订阅者(UI)这里还要切换回 [RACScheduler mainThreadScheduler]。</p>
<h3 id="捕获并且替换-error"><a href="#捕获并且替换-error" class="headerlink" title="捕获并且替换 error"></a>捕获并且替换 error</h3><p>下面也是一个真实业务场景中的代码片段，有适当的删减，需求大致可以描述为：FMContact.contactItems 数组里包含的是一个联系人的所有的 email 地址(至少有一个)，在用 FMContactCreateAvatarCell 显示这个联系人的头像的时候，要通过其中的一个 email 地址，构造出一个 url 地址，然后下载对应的头像，最后把头像 image 设置到 UIButton 上。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ColdSignal&lt;UIImage?, NoError&gt;</span></span><br><span class="line"><span class="comment"> Completion: download image finished;</span></span><br><span class="line"><span class="comment"> Error: </span></span><br><span class="line"><span class="comment"> Scheduler: specified;</span></span><br><span class="line"><span class="comment"> Multicast: NO;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (RACSignal *)getAvatarWithContact: (FMContact *)contact &#123;</span><br><span class="line">    RACSignal *addrs = [[contact.contactItems.rac_sequence</span><br><span class="line">                         map:^(FMContactItem *contactItem) &#123;</span><br><span class="line">                             <span class="keyword">return</span> contactItem.email;</span><br><span class="line">                         &#125;]</span><br><span class="line">                        signal];<span class="comment">//4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [[[[addrs take:<span class="number">1</span>]  <span class="comment">//5</span></span><br><span class="line">              map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *emailAddr) &#123;</span><br><span class="line">                  <span class="keyword">return</span> [[[FMAvatarManager shareInstance] rac_asyncGetAvatar:emailAddr]</span><br><span class="line">                          retry:<span class="number">3</span>];  <span class="comment">//6</span></span><br><span class="line">              &#125;]</span><br><span class="line">             flatten]</span><br><span class="line">            catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                <span class="comment">//7</span></span><br><span class="line">                <span class="keyword">return</span> [RACSignal <span class="keyword">return</span>:<span class="literal">nil</span>]; <span class="comment">//8</span></span><br><span class="line">            &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initPipelineWithCell:(FMContactCreateAvatarCell *)cell &#123;</span><br><span class="line">    @weakify(cell);</span><br><span class="line">    [[[[<span class="keyword">self</span> getAvatarWithContact:<span class="keyword">self</span>.contact] <span class="comment">//1</span></span><br><span class="line">       deliverOnMainThread]</span><br><span class="line">      takeUntil:cell.rac_prepareForReuseSignal]</span><br><span class="line">     subscribeNext:^(<span class="built_in">UIImage</span> *image) &#123;</span><br><span class="line">         @strongify(cell);</span><br><span class="line">         <span class="keyword">if</span> (image) &#123; <span class="comment">//2</span></span><br><span class="line">             [cell.avatarButton setImage:image forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">         <span class="comment">//3</span></span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个业务需求看上去也没有太大的难度，大家肯定都可以用传统的代码写出来，但是如果用 FRP，则可以用声明式(declarative)的代码把逻辑写的更清晰：</p>
<ol>
<li>getAvatarWithContact 定义了一个 Signal，通过输入参数 FMContact，获取一个对应的头像，如果头像下载成功，则通过 next 把 image 发送给 Pipeline 的订阅者，如果下载图片失败，并不会发送 error，而是在 next 里面发送一个 nil。</li>
<li>这个 Pipeline 只会有一次 next 事件，按照 Signal 的定义，可能为 nil，所以需要检查。</li>
<li>这个 Pipeline 是不会产生 error 的，所以这里不需要做任何事情。但是真正的下载图片的操作，也就是 [[FMAvatarManager shareInstance] rac_asyncGetAvatar:emailAddr] 这一句代码产生的 signal，是有 error 事件的，有意思的地方就是如何对这里可能出现的 error 进行处理，请接着往下看。</li>
<li>把 FMContact.contactItems 数组里面的 email 地址，用 signal 的形式发送出来。</li>
<li>FMContact 至少有一个 email 地址，因为只需要显示一个头像，所以直接用最简单的办法，通过 <a href="http://rxmarbles.com/#take" target="_blank" rel="noopener">take</a> 操作取出其中的第一个 email 地址。</li>
<li>从模块设计的角度来看，应该遵循一个基本原则，如果一个小任务可能出现失败的情况，就应该通过 error 把错误信息发送出去。[[FMAvatarManager shareInstance] rac_asyncGetAvatar:emailAddr] 是在下载头像图片，肯定是存在下载失败的可能性，所以这个小任务应该遵循这个基本原则。但是，为了更好的用户体验，可以在 Pipeline 中增加一个环节，添加一个策略，就是遇到下载失败的时候，自动重新下载一遍，总共尝试 3 次，这个需求可以用 <a href="http://reactivex.io/documentation/operators/retry.html" target="_blank" rel="noopener">retry</a> 操作方便的实现出来。</li>
<li>如果运气真的不好，3 次下载都失败了，那 Pipeline 里还是会发送 error 的，但是 getAvatarWithContact 这个 signal 的设计要求是不要 error，这个时候就该用到 <a href="http://reactivex.io/documentation/operators/catch.html" target="_blank" rel="noopener">catch</a> 操作了。catch 做的事情，就是当 Pipeline 里出现 error 的时候，把这个 error 『吃掉』，然后用另外的一个 signal 来替换原来的 signal，让整个 Pipeline 可以继续发送 next 数据。</li>
<li>[RACSignal return:nil] 就是用来替换的 signal，这个 signal 会在 next 里面发送一次 nil，然后立刻就 complete。(如果业务需求变化，这里也可以通过 [RACSignal return:defaultAvatarImage] 发送一个默认的头像图片，Pipeline 是很方便的，可以灵活的组装)。</li>
</ol>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/17/The-Power-Of-Composition-In-FRP-Part-1/" itemprop="url">
                  用 ReactiveCocoa 事半功倍的写代码（一）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-17T21:25:59+08:00" content="2016-04-17">
              2016-04-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/17/The-Power-Of-Composition-In-FRP-Part-1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/17/The-Power-Of-Composition-In-FRP-Part-1/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><a href="https://en.wikipedia.org/wiki/Functional_reactive_programming" target="_blank" rel="noopener">FRP</a> 是一门学习曲线比较陡峭的技术，回想自己以前的学习过程，也是反反复复好几次，而且总是挫败感很强。不过还好坚持了下来，现在也算是用着比较顺手了。</p>
<p>关于 FRP， 最容易被吐槽的地方就是没有好的学习资料和文档。一开始我也是这种感觉，后来在反复尝试的过程中，发现其实真的不是文档的问题。先说我的结论 —- 不要指望脱离代码能够把 FRP 的原理讲清楚，这是 FRP 和其他编程技术的一个明显差异，这就类似于很难用一段文字把一个数学公式描述清楚一样。而且，即便是开始看用 FRP 编写的各种代码了，还是会觉得太抽象了，仍然需要大量的时间体会代码，或者说，『悟』出其中的一些基本门道。</p>
<p>关于入门学习，没有捷径，最好的办法就是通过代码来学习，下面是我觉得比较好的一些入门学习资料</p>
<ul>
<li><a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754" target="_blank" rel="noopener">The introduction to Reactive Programming you’ve been missing</a></li>
<li><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/tree/master/Documentation" target="_blank" rel="noopener">ReactiveCocoa Documentation</a> <em>我本人主要是做 iOS 开发，目前使用的是 RAC 这个库，所以它的官方文档也是一个学习途径。另外，本文中的代码也是使用 RAC 进行编写</em></li>
<li><a href="https://www.raywenderlich.com/62699/reactivecocoa-tutorial-pt1" target="_blank" rel="noopener">ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2</a></li>
<li><a href="https://www.raywenderlich.com/62796/reactivecocoa-tutorial-pt2" target="_blank" rel="noopener">ReactiveCocoa Tutorial – The Definitive Introduction: Part 2/2</a></li>
<li><a href="http://rxmarbles.com/" target="_blank" rel="noopener">Interactive diagrams of Rx Observables</a> <em>这个是一组动态效果图，用可视化的效果演示了一些 FRP 里常用操作(当然，其实还是很抽象的)</em></li>
</ul>
<p>之所以说 FRP 的学习曲线很陡峭，不仅仅是指它的入门学习比较耗时费脑，当入了门或者稍微找到一些感觉之后，紧接着就会面对第二个问题：FRP 里面提供的都是一些比较抽象的函数操作，怎样才能用这些基本函数来解决各种各样的业务问题？尤其是那些很抽象的操作，怎样才能用起来？</p>
<p>这个系列的文章，主要就是针对后面这第二个问题，做的一些 demo 演示。</p>
<p>可以把 FRP 看成是一种更高级的 <a href="http://www.dossier-andreas.net/software_architecture/pipe_and_filter.html" target="_blank" rel="noopener">Pipeline</a> 编程范式，Pipeline 的一个精髓，就是可以灵活的组合，虽然 FRP 里常用的操作也就那么几十个，但是一旦像搭积木那样对它们进行了组装之后，FRP 的强大之处一下子就展现了出来。</p>
<p>FRP 通常是以库或框架的形式提供给使用者，目前已经有很多常见编程语言的具体实现。在这个系列文章中，将使用 RAC 2 (ReactiveCocoa 的 Objective-C 版本) 进行编写。但是 FRP 本质上是一种编程范式，从 Pipeline 的角度来看，它的侧重点在于如何组装出不同形状的 Pipeline，而不太在乎 Pipeline 的具体构成材料(编程语言)，从框架的角度来看，虽然有不同语言版本的实现，但是每个版本里，提供的诸如 map、flattenMap、reduce 等基础操作，在概念上和行为模式上，又都是一样的。所以，FRP 也是一门 “Learn once, write anywhere” 的技术。</p>
<p>FRP 有几个明显的好处，比如可以减少中间状态变量的使用，可以编写紧凑的代码，可以用同步风格编写异步运行的代码，在本系列文章中，也会尽量体现出这些特点。</p>
<h3 id="处理键盘的弹出和隐藏"><a href="#处理键盘的弹出和隐藏" class="headerlink" title="处理键盘的弹出和隐藏"></a>处理键盘的弹出和隐藏</h3><p>这个业务其实是非常简单的，就是在某个 UIViewController 里面，当检测到键盘弹出的时候，为了避免键盘遮挡住某个 UIView，需要根据键盘的高度重新对 view 进行 layout，用 RAC 写出来的代码是下面这个样子：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line">- (<span class="keyword">void</span>)initPipeline &#123;</span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    RACSignal *keyboardWillShowNotification =</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIKeyboardWillShowNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">     map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">         <span class="comment">//2</span></span><br><span class="line">         <span class="built_in">NSDictionary</span>* userInfo = [notification userInfo];</span><br><span class="line">         <span class="built_in">NSValue</span>* aValue = [userInfo objectForKey:<span class="built_in">UIKeyboardFrameEndUserInfoKey</span>];</span><br><span class="line">         <span class="keyword">return</span> aValue;</span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    [[[[[<span class="built_in">NSNotificationCenter</span>.defaultCenter rac_addObserverForName:<span class="built_in">UIKeyboardWillHideNotification</span> object:<span class="literal">nil</span>]</span><br><span class="line">        map:^<span class="keyword">id</span>(<span class="built_in">NSNotification</span> *notification) &#123;</span><br><span class="line">            <span class="comment">//3</span></span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">NSValue</span> valueWithCGRect:<span class="built_in">CGRectZero</span>];</span><br><span class="line">        &#125;]</span><br><span class="line">       merge:keyboardWillShowNotification]   <span class="comment">//4</span></span><br><span class="line">      takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal]  <span class="comment">//6</span></span><br><span class="line">     subscribeNext:^(<span class="built_in">NSValue</span> *value) &#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"Keyboard size is: %@"</span>, value);</span><br><span class="line">         <span class="comment">//5</span></span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="keyword">self</span>.messageEditViewContainerViewBottomConstraint.constant = <span class="number">5.0</span> + [value <span class="built_in">CGRectValue</span>].size.height;</span><br><span class="line">         </span><br><span class="line">         [<span class="keyword">self</span>.view updateConstraints];</span><br><span class="line">         [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.6</span> animations:^&#123;</span><br><span class="line">             @strongify(<span class="keyword">self</span>);</span><br><span class="line">             [<span class="keyword">self</span>.view layoutIfNeeded];</span><br><span class="line">         &#125;];</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         <span class="comment">//6</span></span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"%s, Keyboard Notification signal completed"</span>, __PRETTY_FUNCTION__);</span><br><span class="line">     &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用数字标注的地方，是比较关键的点：</p>
<ol>
<li>很多时候，Pipeline 都是只需要构建一次的，如果是针对 UIViewController，通常都是在 viewDidLoad 方法里调用 [self initPipeline]，如果是针对 UIView，则很有可能是在 awakeFromNib 方法里进行调用，这里遵循的一个策略是，在模块『活』起来之后，应该尽快的构造所有的 Pipeline，如果是 model 或 service 类型的模块，则很可能是在 init 完成后，就调用 initPipeline，但是对于 UI 性质的模块，因为有 iOS 平台相关的 view 加载策略，而且 Pipeline 通常又是和 UI 交互有关，所以通常是需要在 view 生命期相关的方法中才构造 Pipeline。</li>
<li>通过 map 操作，把 UIKeyboardWillShowNotification 转换成一个 CGRect(包装在 NSValue 里面)。<a href="http://rxmarbles.com/#map" target="_blank" rel="noopener">map</a> 操作是 FRP 里面最核心的一个基本操作，也是最体现函数式编程(FP)哲学的一个操作，所谓的这个哲学，用通俗的话来描述，就是『把复杂的业务拆分成一个一个的<strong>小任务</strong>，每一个小任务，都需要一个输入值，并且会给出一个输出值(当然也会反馈错误信息)，而且每个小任务都只专心的做一件事情』。如果第一个小任务的输出值，是第二个小任务的输入值，那么，就可以用 map 操作把这两个小任务串联在一起。在接收到 UIKeyboardWillShowNotification 消息通知的时候，这个小任务的输入值就是 NSNotification，输出值是键盘尺寸对应的 CGRect，小任务本身做的事情，就是从 NSNotification 里面取出包装着这个 CGRect 的 NSValue。</li>
<li>当接收到 UIKeyboardWillHideNotification 消息通知的时候，这个小任务要做的事情，和 2 里面的小任务是类似的，只不过这一次，NSNotification 并没有包含键盘的尺寸，那我们自己用 CGRectZero 构造一个就行了。</li>
<li>终于到了这段代码的重点了，<a href="http://rxmarbles.com/#merge" target="_blank" rel="noopener">merge</a> 操作在这里的使用效果，相当于把 2 和 3 里面的两个小任务的输出值作为自己的输入值，按照时间先后顺序排列起来，然后作为自己这个小任务的输出值，返回给 Pipeline 中的下一个环节。<code>这样描述还是很抽象，看不懂，是吧？没关系，早就说过用语言很难描述了。把代码运行起来，通过 NSLog(@&quot;Keyboard size is: %@&quot;, value) 这句代码的输出信息体会一下 merge 的实际效果。</code></li>
<li>这里才是真正的实现业务想要的效果，根据前一个小任务的输出值(键盘尺寸 CGRect)来计算 layout 的尺寸。</li>
<li><a href="http://rxmarbles.com/#takeUntil" target="_blank" rel="noopener">takeUntil</a> 是一个难点，如果没有这一句代码调用，运行代码后会发现，前面 5 里面的业务还是正常执行了，但是当 self 被 dealloc 后(比如 pop UIViewController 后)，NSLog(@”Keyboard size is: %@”, value) 这句代码还是会被执行到(因为已经处理过 retain cycle，所以此时 self 是 nil)，这是因为当 self 被 dealloc 后，这个 Pipeline 并没有被释放，Pipeline 里面还是有数据在继续流动。这个话题牵扯到 RAC 框架中的<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/Legacy/MemoryManagement.md" target="_blank" rel="noopener">内存管理策略</a>，很重要，后面的内容中还会讲到这个话题。这里暂时只需要知道可以借助 takeUntil:self.rac_willDeallocSignal 这样的一行代码方便的解决问题就行了。</li>
</ol>
<h3 id="Singal上的-next、complete、error"><a href="#Singal上的-next、complete、error" class="headerlink" title="Singal上的 next、complete、error"></a>Singal上的 next、complete、error</h3><p>在学习的过程中，发现有一个问题很容易被忽略掉，那就是 Signal 的 next、complete、error 这 3 种数据，会在什么时候被发送出来，针对这个问题做过一个总结，放在了 <a href="https://github.com/ziipin-code/ZiipinTemplateProject/blob/master/rac.md" target="_blank" rel="noopener">这篇文档</a> 中，主要目的是使用一种简单易懂的格式把 Signal 的关键信息描述出来，这里简单摘录一下。</p>
<h4 id="基础格式"><a href="#基础格式" class="headerlink" title="基础格式"></a>基础格式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HotSignal&lt;T, E&gt;   // or ColdSignal&lt;T, E&gt;</span><br><span class="line">Completion: ...</span><br><span class="line">Error: ...</span><br><span class="line">Scheduler: ...</span><br><span class="line">Multicast: ...</span><br></pre></td></tr></table></figure>
<h4 id="关键字解释"><a href="#关键字解释" class="headerlink" title="关键字解释"></a>关键字解释</h4><ul>
<li><a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/master/Documentation/Legacy/DesignGuidelines.md#use-descriptive-declarations-for-methods-and-properties-that-return-a-signal" target="_blank" rel="noopener">HotSignal And ColdSignal</a>:<ul>
<li><code>HotSignal</code>: Signal 已经处于活动状态(activated);</li>
<li><code>ColdSignal</code>: Signal 需要订阅(subscribed)才会活动(activate);</li>
</ul>
</li>
<li>T: Signal sendNext 的类型, 可以下面几种情况:<ul>
<li><code>T</code>: 表示只会发送 1 次 next 事件, 内容是类型 <code>T</code> 的实例;</li>
<li><code>T?</code>:  表示只会发送 1 次 next 事件, 内容是类型 <code>T</code> 的实例或者 <code>nil</code>;</li>
<li><code>[T]</code>: 表示会发送 0 到 n 次 next 事件, 内容是类型 <code>T</code> 的实例;</li>
<li><code>[T?]</code>: 表示会发送 0 到 n 次 next 事件, 内容是类型 <code>T</code> 的实例或者 <code>nil</code>;</li>
<li><code>None</code>: 表示<strong>不会</strong>发送 next 事件;</li>
</ul>
</li>
<li>E: Signal sendError 的类型, 通常是 <code>NSError</code> 或 <code>NoError</code>; <code>NoError</code> 表示 Signal 不会 sendError;</li>
<li>Completion: 描述什么情况 sendCompleted;<ul>
<li>如果 next 事件的发送次数是 <code>无穷多次</code>，相当于使用者永远也接收不到 Completed 事件，所以这一行可以不写;</li>
</ul>
</li>
<li>Error:  描述什么情况 sendError;<br>如果 Signal 不会 sendError, 这一行可以不写;</li>
<li>Scheduler: Signal 所在的线程，通常是 <code>main</code> <code>specified</code> <code>current</code>, 默认是 <code>current</code><ul>
<li>main 模块内部的pipeline有切换不同的scheduler，所以模块内部有责任确保最终的signal始终是在main schedular上的</li>
<li>specified 模块内部自定义了一个任务队列，模块会确保最终返回的signal都在这个特定的schedular中(或者是使用全局默认的后台schedular)</li>
<li>current 模块内部pipeline没有做任何scheduler的切换，且不指定特定的schedular，所以最终返回的signal和外部调用者的线程保持一致</li>
</ul>
</li>
<li>Multicast: 是否广播，通常是 <code>YES</code> <code>NO</code>, 默认是 <code>NO</code></li>
</ul>
<h4 id="所有可能出现的有意义的非嵌套-Signal"><a href="#所有可能出现的有意义的非嵌套-Signal" class="headerlink" title="所有可能出现的有意义的非嵌套 Signal"></a>所有可能出现的有意义的非嵌套 Signal</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">*    HotSignal&lt;T, NoError&gt;</span><br><span class="line">*    HotSignal&lt;T?, NoError&gt;</span><br><span class="line">*    HotSignal&lt;[T], NoError&gt;</span><br><span class="line">*    HotSignal&lt;[T?], NoError&gt;</span><br><span class="line">*    HotSignal&lt;None, NoError&gt;</span><br><span class="line">*    HotSignal&lt;T, NSError&gt;</span><br><span class="line">*    HotSignal&lt;T?, NSError&gt;</span><br><span class="line">*    HotSignal&lt;[T], NSError&gt;</span><br><span class="line">*    HotSignal&lt;[T?], NSError&gt;</span><br><span class="line">*    HotSignal&lt;None, NSError&gt;</span><br><span class="line"></span><br><span class="line">*    ColdSignal&lt;T, NoError&gt;</span><br><span class="line">*    ColdSignal&lt;T?, NoError&gt;</span><br><span class="line">*    ColdSignal&lt;[T], NoError&gt;</span><br><span class="line">*    ColdSignal&lt;[T?], NoError&gt;</span><br><span class="line">*    ColdSignal&lt;None, NoError&gt;</span><br><span class="line">*    ColdSignal&lt;T, NSError&gt;</span><br><span class="line">*    ColdSignal&lt;T?, NSError&gt;</span><br><span class="line">*    ColdSignal&lt;[T], NSError&gt;</span><br><span class="line">*    ColdSignal&lt;[T?], NSError&gt;</span><br><span class="line">*    ColdSignal&lt;None, NSError&gt;</span><br></pre></td></tr></table></figure>
<h3 id="发送验证码的倒计时按钮"><a href="#发送验证码的倒计时按钮" class="headerlink" title="发送验证码的倒计时按钮"></a>发送验证码的倒计时按钮</h3><p><img src="/images/retryButton.png" alt="Retry Button"></p>
<p>如上图，这里的需求是，点击右上角的按钮后，该按钮不可以使用，同时在按钮上显示一个倒计时时间，当达到倒计时时间后，按钮恢复可用状态。这个需求并不难，相信大家都可以写出来，但是，每个人写出来的代码，风格肯定千差万别，而且，免不了会需要一些状态变量来记录一些信息，比如定时器对象和倒计时的时间等等。如果换用 RAC，则可以在一段连续的代码中，满足所有的需求，代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> ColdSignal&lt;RACTuple&lt;NSString, NSNumber&lt;BOOL&gt; &gt;), NoError&gt;</span></span><br><span class="line"><span class="comment"> Completion: 1分钟倒计时结束;</span></span><br><span class="line"><span class="comment"> Error: none;</span></span><br><span class="line"><span class="comment"> Scheduler: main;</span></span><br><span class="line"><span class="comment"> Multicast: NO;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (RACSignal *)retryButtonTitleAndEnable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">NSInteger</span> n = <span class="number">60</span>;</span><br><span class="line">    </span><br><span class="line">    RACSignal *timer = [[[RACSignal interval:<span class="number">1</span> onScheduler:[RACScheduler mainThreadScheduler]]  <span class="comment">//7</span></span><br><span class="line">                         map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                             <span class="keyword">return</span> <span class="literal">nil</span>; <span class="comment">//8</span></span><br><span class="line">                         &#125;]</span><br><span class="line">                        startWith:<span class="literal">nil</span>]; <span class="comment">//9</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//10</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *numbers = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = n; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        [numbers addObject:[<span class="built_in">NSNumber</span> numberWithInteger:i]];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [[[[[numbers.rac_sequence.signal zipWith:timer]  <span class="comment">//11</span></span><br><span class="line">               map:^<span class="keyword">id</span>(RACTuple *tuple) &#123;</span><br><span class="line">                   <span class="comment">//12</span></span><br><span class="line">                   <span class="built_in">NSNumber</span> *number = tuple.first;</span><br><span class="line">                   <span class="built_in">NSInteger</span> count = number.integerValue;</span><br><span class="line">                   </span><br><span class="line">                   <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">return</span> RACTuplePack(<span class="string">@"重试"</span>, [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]);</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="built_in">NSString</span> *title = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"重试(%lds)"</span>, (<span class="keyword">long</span>)count];</span><br><span class="line">                       <span class="keyword">return</span> RACTuplePack(title, [<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">NO</span>]);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;]</span><br><span class="line">              takeUntil:[<span class="keyword">self</span> rac_willDeallocSignal]] <span class="comment">//13</span></span><br><span class="line">             setNameWithFormat:<span class="string">@"%s, retryButtonTitleAndEnable signal"</span>, __PRETTY_FUNCTION__]</span><br><span class="line">            logCompleted]; <span class="comment">//14</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initPipeline &#123;</span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    [[[[[[<span class="keyword">self</span>.retryButtton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">         map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">             <span class="comment">//2</span></span><br><span class="line">             @strongify(<span class="keyword">self</span>);</span><br><span class="line">             <span class="keyword">return</span> [<span class="keyword">self</span> retryButtonTitleAndEnable];</span><br><span class="line">         &#125;]</span><br><span class="line">        startWith:[<span class="keyword">self</span> retryButtonTitleAndEnable]]  <span class="comment">//3</span></span><br><span class="line">       switchToLatest]  <span class="comment">//4</span></span><br><span class="line">      takeUntil:[<span class="keyword">self</span> rac_willDeallocSignal]]  <span class="comment">//5</span></span><br><span class="line">     subscribeNext:^(RACTuple *tuple) &#123;</span><br><span class="line">         <span class="comment">//6</span></span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="built_in">NSString</span> *title = tuple.first;</span><br><span class="line">         [<span class="keyword">self</span>.retryButtton setTitle:title forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">         <span class="keyword">self</span>.retryButtton.enabled = ((<span class="built_in">NSNumber</span> *)tuple.second).boolValue;</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">         <span class="comment">//5</span></span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"%s, pipeline completed"</span>, __PRETTY_FUNCTION__);</span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里省略了点击 retryButtton 后具体要做的业务逻辑，同时也省略了验证按钮和验证码输入框的处理逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对关键代码的描述如下：</p>
<ol>
<li>设计一个 RACSignal，这个 Signal 每次发送的 Next 数据里面包含的就是按钮上要显示的文本信息和按钮的可用状态。从模块的角度来看，这个 Signal 的内部细节(倒计时逻辑)，外部使用者是不需要知道的，所以后面我们会先看外层 Pipeline 的实现代码，然后再倒回来看这个 Signal 的内部逻辑。</li>
<li>每当 retryButtton 被点击的时候，要重新启动一个定时器，所以在这个 map 操作里面，调用 [self retryButtonTitleAndEnable] 得到一个 Signal，将这个 Signal 作为这个小任务的输出值。注意，因为这里 map 操作返回的是一个 Signal，形成了一个 Pipeline 的嵌套，所以可以预见到，在外层 Pipeline 的后续操作中，肯定是需要把这个内嵌的 Pipeline flatten 出来的。</li>
<li>在业务需求中，点击这个 retryButtton 后，要请求服务器发送一个验证码(省略了这部分的代码，如果要用 RAC 实现的话，是比较容易的)，同时，当每次进入这个 UI 页面的时候，不需要用户主动点击这个 retryButtton 按钮，首先就要自动的请求服务器发送一个验证码，这种情况下，也要求 retryButtton 开始进入倒计时的模式，所以，用 <a href="http://rxmarbles.com/#startWith" target="_blank" rel="noopener">startWith</a> 操作，在外层 Pipeline 中先插入第一个 Next 数据，因为是同样的倒计时逻辑，所以这里也是调用 [self retryButtonTitleAndEnable] 得到内嵌的 Pipeline。</li>
<li>前面已经提过了，既然形成了 Pipeline 的嵌套，那肯定是要把这种嵌套解出来的，这里使用 <a href="http://reactivex.io/documentation/operators/images/switch.c.png" target="_blank" rel="noopener">switchToLatest</a> 更合适。要注意区分一下和 <a href="http://reactivex.io/documentation/operators/flatmap.html" target="_blank" rel="noopener">flattenMap</a> 的差异。</li>
<li>Pipeline 的生命期控制，前面的例子中已经讲过这种技巧了，但是，这是写上这句，只是一个双保险。复杂的地方在于外层 Pipeline 有 switchToLatest 操作，这个 switchToLatest 后的 Signal 什么时候才会 Completed，请继续看至后面 13 中的解释。</li>
<li>这里是更新 retryButtton 的 title 和状态。</li>
<li>现在开始回到内层 Pipeline 的逻辑中去。用 Pipeline 的方式实现一个定时器，借助 RAC 提供的 interval 操作就行。每隔一秒都会在主线程上发送一个 Next。</li>
<li>7 里面的定时器上的 Next 数据，是当前的系统时间值，我们的需求里面并不需要这个时间值，所以这里直接 map 成 nil。</li>
<li>RACSignal interval 要隔一秒后才会发出第一次，需要用 startWith 立刻发送一个，代表倒计时的初始值。</li>
<li>把倒计时要用到的数字放到一个数组里面，然后通过 numbers.rac_sequence.signal 语句转换成一个 Signal。</li>
<li>把前面 10 中得到的 Signal 和 9 中得到的 timer Signal，用 <a href="http://rxmarbles.com/#zip" target="_blank" rel="noopener">zipWith</a> 组装起来。注意一点，这个通过 zipWith 组装出来的 Signal，会在 numbers.rac_sequence.signal Completed 的时候 Completed (这句话有点绕，需要结合 zipWith 的定义仔细体会一下)。</li>
<li>根据倒计时的数值，计算按钮上需要显示的 title 信息和按钮的状态。</li>
<li>前面 11 里面的 zipWith 操作，可以确保倒计时结束时，会触发 Completed，但是万一在倒计时的过程中，用户离开了当前页面，这个时候就需要通过 takeUntil 来触发 Completed。之所以在这里这么注重 Completed，是因为前面的 5 里面的 switchToLatest 操作，会 <code>sends completed when both the receiver and the last sent signal complete</code>。</li>
<li>通过 setNameWithFormat 和 logCompleted 打印一些 log 信息，方便调试，注意观察一下 Signal 的 Completed。</li>
</ol>
<h3 id="内存管理，自动释放-Pipeline"><a href="#内存管理，自动释放-Pipeline" class="headerlink" title="内存管理，自动释放 Pipeline"></a>内存管理，自动释放 Pipeline</h3><p>从前面的 code 中可以看到，好几个地方都在强调要触发 Completed，这完全就是为了正确的进行内存管理，避免内存泄露，<a href="https://github.com/ReactiveCocoa/ReactiveCocoa/blob/7877f99bdfb4be1c82c4804082e99c35d0a93a91/Documentation/Legacy/DesignGuidelines.md#avoid-explicit-subscriptions-and-disposal" target="_blank" rel="noopener">避免手动的调用 disposal</a>。takeUntil:self.rac_willDeallocSignal 是一种常用的手段。</p>
<p>还有一种典型的场景，也可以通过 takeUntil 操作来触发 Completed，代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UICollectionViewCell</span> *)collectionView:(<span class="built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    WWKPhoto *photo = <span class="keyword">self</span>.photos[indexPath.row];</span><br><span class="line">    XMCollectionImageViewCell *cell = [<span class="keyword">self</span>.imageCollectionView dequeueReusableCellWithReuseIdentifier:<span class="built_in">NSStringFromClass</span>([XMCollectionImageViewCell <span class="keyword">class</span>]) forIndexPath:indexPath];</span><br><span class="line">    cell.imageView.image = photo.thumbnail;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @weakify(<span class="keyword">self</span>);</span><br><span class="line">    [[[cell.longPressSignal map:^<span class="keyword">id</span>(XMCollectionImageViewCell *viewCell) &#123;</span><br><span class="line">        @strongify(<span class="keyword">self</span>);</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.imageCollectionView indexPathForCell:viewCell];</span><br><span class="line">    &#125;]</span><br><span class="line">      takeUntil:[cell rac_prepareForReuseSignal]]</span><br><span class="line">     subscribeNext:^(<span class="built_in">NSIndexPath</span> *longPressIndexPath) &#123;</span><br><span class="line">         @strongify(<span class="keyword">self</span>);</span><br><span class="line">         <span class="built_in">UIAlertController</span> *alert= [<span class="built_in">UIAlertController</span></span><br><span class="line">                                    alertControllerWithTitle:<span class="string">@"确定删除此图片"</span></span><br><span class="line">                                    message:<span class="literal">nil</span></span><br><span class="line">                                    preferredStyle:<span class="built_in">UIAlertControllerStyleAlert</span>];</span><br><span class="line">         </span><br><span class="line">         <span class="built_in">UIAlertAction</span>* ok = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"确定"</span> style:<span class="built_in">UIAlertActionStyleDefault</span></span><br><span class="line">                                                    handler:^(<span class="built_in">UIAlertAction</span> * action)&#123;</span><br><span class="line">                                                        @strongify(<span class="keyword">self</span>);</span><br><span class="line">                                                        [[<span class="keyword">self</span> mutableArrayValueForKey:@keypath(<span class="keyword">self</span>, photos)] removeObjectAtIndex:longPressIndexPath.row];</span><br><span class="line">                                                        [<span class="keyword">self</span>.imageCollectionView deleteItemsAtIndexPaths:@[longPressIndexPath]];</span><br><span class="line">                                                    &#125;];</span><br><span class="line">         <span class="built_in">UIAlertAction</span>* cancel = [<span class="built_in">UIAlertAction</span> actionWithTitle:<span class="string">@"取消"</span> style:<span class="built_in">UIAlertActionStyleDefault</span></span><br><span class="line">                                                        handler:^(<span class="built_in">UIAlertAction</span> * action) &#123;</span><br><span class="line">                                                            [alert dismissViewControllerAnimated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">                                                        &#125;];</span><br><span class="line">         </span><br><span class="line">         [alert addAction:ok];</span><br><span class="line">         [alert addAction:cancel];</span><br><span class="line">         </span><br><span class="line">         [<span class="keyword">self</span>.containerViewController presentViewController:alert animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">     &#125; completed:^&#123;</span><br><span class="line">     &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码也很简单，唯一需要特别注意的就是 takeUntil:[cell rac_prepareForReuseSignal] 这一句，因为 UICollectionViewCell 本身是有一套复用机制的，每个 cell 上的 Pipeline 的生命期和 cell 本身的生命期并不一致，所以不能依赖于 cell.rac_willDeallocSignal，而应该使用 [cell rac_prepareForReuseSignal] 这个更准确的 Signal。</p>
<p>讨论到这里，还可以得到一个结论，在设计 Signal 的时候，要尽量的让这个 Signal 能够发送 Completed 事件，这样才能够充分的利用 Pipeline 的自动释放功能，保持代码的简洁。RAC 框架里，有一些很常用的 Signal，其实它们的内部实现也是用类似 takeUntil 的操作做了这种处理，比如下面这些 Signal：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIControl</span> (<span class="title">RACSignalSupport</span>)</span></span><br><span class="line">- (RACSignal *)rac_signalForControlEvents:(<span class="built_in">UIControlEvents</span>)controlEvents;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">UIGestureRecognizer</span> (<span class="title">RACSignalSupport</span>)</span></span><br><span class="line">- (RACSignal *)rac_gestureSignal;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">RACObserve 宏定义</span><br></pre></td></tr></table></figure></p>
<p>下面这个 Signal，则是没有 Completed 事件的，要求它的使用者来决定什么时候释放对应的 Pipeline：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSNotificationCenter</span> (<span class="title">RACSupport</span>)</span></span><br><span class="line">- (RACSignal *)rac_addObserverForName:(<span class="built_in">NSString</span> *)notificationName object:(<span class="keyword">id</span>)object;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/10/CSP-Concurrency-Patterns-In-Swift/" itemprop="url">
                  通过 Swift 学习 CSP 并发模型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-10T22:45:16+08:00" content="2016-04-10">
              2016-04-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/10/CSP-Concurrency-Patterns-In-Swift/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/10/CSP-Concurrency-Patterns-In-Swift/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这篇文章的主要内容，是从 <a href="https://talks.golang.org/2012/concurrency.slide" target="_blank" rel="noopener">Go Concurrency Patterns</a> 翻译过来的。</p>
<p>原文是介绍 <a href="http://golang.info/" target="_blank" rel="noopener">Golang</a> 里面的 <a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes" target="_blank" rel="noopener">CSP</a> 并发模型(Communicating Sequential Processes)，这里则是使用一个基于 Swift3.0 的库 <a href="https://github.com/VeniceX/Venice" target="_blank" rel="noopener">Venice</a> 编写的代码。</p>
<p>这篇文章的主要目的，并不是鼓励大家立刻就用 Swift 进行后端开发(至少不是目前这个阶段)，但是，对于想尝试全栈开发的 iOS 工程师来说，则可以通过这篇文章入门学习 CSP 这种并发编程模型。</p>
<p><em>2016/04/08 update: 为了成功运行本文中的代码，需要安装 <a href="https://swift.org/builds/development/xcode/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a-osx.pkg" target="_blank" rel="noopener">https://swift.org/builds/development/xcode/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a/swift-DEVELOPMENT-SNAPSHOT-2016-03-24-a-osx.pkg</a> 这个版本的 swift。</em></p>
<p><em>2016/04/13 update: <a href="https://github.com/VeniceX/Venice" target="_blank" rel="noopener">Venice</a> 里面的 Channel 不再支持基于自定义运算符的读写操作，只能使用 func api。</em></p>
<h3 id="为什么要讨论并发-concurrency"><a href="#为什么要讨论并发-concurrency" class="headerlink" title="为什么要讨论并发 (concurrency)"></a>为什么要讨论并发 (concurrency)</h3><p>观察一下我们周围，能发现什么？</p>
<p>我们的世界里发生的事情，总是一步一步按顺序执行的吗？</p>
<p>或者说，发生在我们身边的所有的事件，是一个很复杂的组合体，里面充满了更独立、更小型的事件单元，这些单元之间，则是有各种各样的交互和组织关系。</p>
<p>其实就像后者描述的这样，顺序处理 (Sequential processing) 并不是完美的建模思路。</p>
<h3 id="什么是并发？"><a href="#什么是并发？" class="headerlink" title="什么是并发？"></a>什么是并发？</h3><p>并发是独立的计算任务的组合。</p>
<p>并发是一种软件的设计模式，用并发的思维模式，可以编写出更清晰的代码。</p>
<h3 id="并发-concurrency-不是并行-parallelism"><a href="#并发-concurrency-不是并行-parallelism" class="headerlink" title="并发 (concurrency) 不是并行 (parallelism)"></a>并发 (concurrency) 不是并行 (parallelism)</h3><p>并发不是并行，但是可以在并行的基础上形成并发。</p>
<p>如果只有一个单核处理器(单线程模式)，则谈不上并行，但是仍然可以写出并发的代码。</p>
<p>另一方面，如果一段代码已经按照并发的思路进行了设计，那它也是可以很容易的在多核处理器(多线程模式)中并行执行。</p>
<p><em>关于这个话题，更详细的讨论可以参看 <a href="http://talks.golang.org/2012/waza.slide" target="_blank" rel="noopener">Concurrency is not Parallelism</a></em></p>
<h3 id="什么是好的代码架构"><a href="#什么是好的代码架构" class="headerlink" title="什么是好的代码架构"></a>什么是好的代码架构</h3><ul>
<li>要容易理解</li>
<li>要容易使用</li>
<li>要容易描述出设计意图</li>
<li>不需要人人都是专家 (不应该总是出现大量threads，semaphores，locks，barriers等等高深的话题)</li>
</ul>
<h3 id="CSP-的历史"><a href="#CSP-的历史" class="headerlink" title="CSP 的历史"></a>CSP 的历史</h3><p>CSP 并不是新技术，Communicating Sequential Processes 是 Tony Hoare 在 1978 年就提出来的概念，甚至在更早的 1975 年，Edsger Dijkstra 的 Guarded Command Language 里面，也能看到 CSP 的影子。</p>
<p>还有其他的一些语言，也有类似的并发模型</p>
<ul>
<li>Occam (May, 1983)</li>
<li>Erlang (Armstrong, 1986)</li>
<li>Newsqueak (Pike, 1988)</li>
<li>Concurrent ML (Reppy, 1993)</li>
<li>Alef (Winterbottom, 1995)</li>
<li>Limbo (Dorward, Pike, Winterbottom, 1996).</li>
</ul>
<h3 id="Venice-Golang-和-Erlang-的差异"><a href="#Venice-Golang-和-Erlang-的差异" class="headerlink" title="Venice / Golang 和 Erlang 的差异"></a>Venice / Golang 和 Erlang 的差异</h3><p>Venice / Golang 通过 channels 来实现 CSP。</p>
<p>Erlang 是最接近于原始的 CSP 定义的，通过 name 进行通信，而非 channel。</p>
<p>它们的模型其实是一致的，只不过具体的表现形式有差异。</p>
<p>粗略来看相当于：writing to a file by name (process, Erlang) vs. writing to a file descriptor (channel, Venice / Golang).</p>
<h3 id="CSP-的基本使用"><a href="#CSP-的基本使用" class="headerlink" title="CSP 的基本使用"></a>CSP 的基本使用</h3><p>这篇文章最主要的目的是讨论并发模式，为了避免陷入编程语言本身的各种细节，我们只会使用到 Swift 很少的语法特性。</p>
<h4 id="从下面这个简单的-boring-函数开始"><a href="#从下面这个简单的-boring-函数开始" class="headerlink" title="从下面这个简单的 boring 函数开始"></a>从下面这个简单的 boring 函数开始</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>...<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">        usleep(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run01</span><span class="params">()</span></span> &#123;</span><br><span class="line">    boring(<span class="string">"this is a boring func"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很容易想象到，这段代码的执行结果会是下买这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">this is a boring func 0</span><br><span class="line">this is a boring func 1</span><br><span class="line">this is a boring func 2</span><br><span class="line">this is a boring func 3</span><br><span class="line">this is a boring func 4</span><br><span class="line">this is a boring func 5</span><br><span class="line">this is a boring func 6</span><br><span class="line">this is a boring func 7</span><br><span class="line">this is a boring func 8</span><br><span class="line">this is a boring func 9</span><br><span class="line">this is a boring func 10</span><br></pre></td></tr></table></figure>
<h4 id="稍微改动一下"><a href="#稍微改动一下" class="headerlink" title="稍微改动一下"></a>稍微改动一下</h4><p>增加一点随机的延时，让 message 出现的时机不可预测 (延迟时间仍然控制在1秒之内)。并且让 boring 函数一直循环运行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">        usleep(<span class="number">1000</span> * (arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run02</span><span class="params">()</span></span> &#123;</span><br><span class="line">    boring(<span class="string">"this is a less boring func"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="进入正题"><a href="#进入正题" class="headerlink" title="进入正题"></a>进入正题</h4><p>Venice 的 co 函数，传入的参数是一个函数，在 co 的内部会执行这个传入的函数，但是并不会等待这个函数执行结束，对于 co 的调用者来说，co 函数本身会立刻返回。co 函数其实是开启了一个新的协程 (轻量级线程) 来真正的执行传入的函数。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)<span class="comment">//sleep</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run03</span><span class="params">()</span></span> &#123;</span><br><span class="line">    co &#123;</span><br><span class="line">        boring(<span class="string">"co a less boring func"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    //if do not want run03() finish, run the loop below</span></span><br><span class="line"><span class="comment">    for i in 0..&lt;Int.max &#123;</span></span><br><span class="line"><span class="comment">        yield</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"run03() will return"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段代码的运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">co a less boring func 0</span><br><span class="line">run03() will return</span><br></pre></td></tr></table></figure>
<p>可以看到，boring函数里面的循环只执行了一次，这是因为 co 函数是立刻返回的，紧接着，run03() 执行完 print 后也立刻返回，然后 run03() 的调用者 main 函数也就执行结束了 (进程结束)，之前 co 启动的协程自然也就无法继续执行了。</p>
<p>如果想让 co 里面的协程一直运行下去，可以在 co 调用返回后，执行代码中的那段 for loop。</p>
<p><em>要注意的一点是，for loop 里面调用的 yield，是 Venice 引入的一种操作，意思是让出 CPU 给其他的协程。Golang 是不需要手动进行这种调用的，runtime 会自动的进行调度。</em></p>
<p><em>在 Venice 里面，如果是在 channel 上进行读写操作，读写的同时已经相当于调用过 yield 了，所以也不需要使用者再次显式的调用 yield。在后面的例子的，就会看到这种不需要手动调用 yield 的场景。</em></p>
<h4 id="继续改动代码"><a href="#继续改动代码" class="headerlink" title="继续改动代码"></a>继续改动代码</h4><p>调整代码成下面这个样子，在 co 调用后，让 run04() 所在的协程 sleep 一小段时间。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run04</span><span class="params">()</span></span> &#123;</span><br><span class="line">    co(boring(<span class="string">"co a less boring func"</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"I'm listening"</span>)</span><br><span class="line">    nap(<span class="keyword">for</span>: <span class="number">2</span>.second)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的执行结果是下面这个样子的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">co a less boring func 0</span><br><span class="line">I&apos;m listening</span><br><span class="line">co a less boring func 1</span><br><span class="line">co a less boring func 2</span><br><span class="line">co a less boring func 3</span><br><span class="line">co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p><em>nap()是Venice提供的sleep函数，它的内部，相当于调用了yield。</em></p>
<p>当main函数结束的时候，boring函数所在的协程也会结束。</p>
<h4 id="协程-coroutine"><a href="#协程-coroutine" class="headerlink" title="协程 (coroutine)"></a>协程 (coroutine)</h4><p>协程是一段独立运行的代码集合，通过 co 函数来启动。</p>
<p>协程的系统开销是很小的 (比 thread 小很多)，可以同时存在大量的协程 (具体到 Venice 底层使用的 <a href="http://libmill.org/" target="_blank" rel="noopener">libmill</a>，可以同时运行 <strong>2000万个</strong> 协程，并且每秒可以进行 <strong>5000万次</strong> 协程上下文切换)。</p>
<p>协程不是线程。</p>
<p>一个程序里面，可以只运行一个线程，但是在这个线程里面，可以包含千万个协程。</p>
<p>可以把协程看成是轻量级的线程。</p>
<h4 id="通讯-communication"><a href="#通讯-communication" class="headerlink" title="通讯 (communication)"></a>通讯 (communication)</h4><p>在 run04() 里面，是不能看到在协程中运行的 boring 函数的运行结果的。</p>
<p>boring 函数仅仅是把 msg 打印到了终端上。</p>
<p>想在协程之间真正的传递数据，需要用到通讯 (communication)。</p>
<h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>在 Venice 里面，两个协程之间，通过 Channel 进行通讯。</p>
<p>Channel 的基本操作就是下面这3个:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明、初始化</span></span><br><span class="line"><span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">//在channel上发送数据</span></span><br><span class="line">channel.send(<span class="string">"ping"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//在channel上接收数据</span></span><br><span class="line"><span class="keyword">let</span> message = channel.receive()!</span><br></pre></td></tr></table></figure>
<h4 id="使用-Channel"><a href="#使用-Channel" class="headerlink" title="使用 Channel"></a>使用 Channel</h4><p>用 channel 连接 boring 函数和 run05 函数</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, channel: SendingChannel&lt;String&gt; )</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">        channel.send(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">        nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run05</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        boring(msg: <span class="string">"co a less boring func"</span>, channel: channel.sendingChannel)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"You say: \(channel.receivingChannel.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">    channel.close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">You say: co a less boring func 0</span><br><span class="line">You say: co a less boring func 1</span><br><span class="line">You say: co a less boring func 2</span><br><span class="line">You say: co a less boring func 3</span><br><span class="line">You say: co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="同步-Synchronization"><a href="#同步-Synchronization" class="headerlink" title="同步 (Synchronization)"></a>同步 (Synchronization)</h4><p>在 channel 上的读、写操作，是同步的、阻塞的。</p>
<p>run05() 执行到 channel.receivingChannel.receive()! 的时候，只有当 channel 里面有数据被写入的时候，这个读操作才会返回 (读到数据的时候才返回)，否则 run05() 就会一直在这里等待，不会继续往下执行。</p>
<p>同样的，在 boring 函数里面，执行 channel.send(“(msg) (i)”) 这个写操作的时候，只有当 channel 里面为空的时候，数据才能被写到 channel 里面，channel.send(“(msg) (i)”) 才会返回，否则，send 操作也会阻塞在这里。</p>
<p>在通讯过程中，发送者和接收者，必须都分别完成他们的写和读动作，否则双方就会一直互相等待下去 (死锁)。</p>
<p>channel 在协程之间完成通讯的同时，也达到了同步的目的。</p>
<h4 id="带缓冲的-channel"><a href="#带缓冲的-channel" class="headerlink" title="带缓冲的 channel"></a>带缓冲的 channel</h4><p>可以创建具有 buffer 的 channel。</p>
<p>这种 channel，当 buffer 还没有写满的时候，是没有前面描述的那种同步特性的。</p>
<p>buffering 有点类似 Erlang 语言里面的 mailboxes。</p>
<p>没有特殊理由的时候，不应该使用 buffered channel。</p>
<p>这篇文章后续的讨论，都不会使用 buffer。</p>
<h4 id="Golang-哲学"><a href="#Golang-哲学" class="headerlink" title="Golang 哲学"></a>Golang 哲学</h4><p>Don’t communicate by sharing memory, share memory by communicating.</p>
<h3 id="模式-Patterns"><a href="#模式-Patterns" class="headerlink" title="模式 (Patterns)"></a>模式 (Patterns)</h3><h4 id="Generator-模式：通过函数返回一个-channel-给调用者"><a href="#Generator-模式：通过函数返回一个-channel-给调用者" class="headerlink" title="Generator 模式：通过函数返回一个 channel 给调用者"></a>Generator 模式：通过函数返回一个 channel 给调用者</h4><p>Channel 是一等公民，和 class、struct、closure 同等重要。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run06</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> receivingChannel = boring(<span class="string">"co a less boring func"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"You say: \(receivingChannel.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码和前面的代码的运行结果，没有什么差别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">You say: co a less boring func 0</span><br><span class="line">You say: co a less boring func 1</span><br><span class="line">You say: co a less boring func 2</span><br><span class="line">You say: co a less boring func 3</span><br><span class="line">You say: co a less boring func 4</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p>但是代码本身确有明显的变化，boring 函数返回一个 channel 给调用者，同时，在 boring 函数内部，通过 co 启动一个新的协程做具体的业务，并且通过刚才创建的 channel 把结果发送出去。</p>
<h4 id="利用-channel-作为-service-的接口"><a href="#利用-channel-作为-service-的接口" class="headerlink" title="利用 channel 作为 service 的接口"></a>利用 channel 作为 service 的接口</h4><p>boring 函数对外提供了一个 service，这个 service 运行在独立的协程里面，并且通过channel 把数据传递给 service 的使用者。</p>
<p>可以同时使用多个 service。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run07</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(joe.receive()!)"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(ann.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 996 ms)</span><br><span class="line">Ann 0  (will sleep 681 ms)</span><br><span class="line">Joe 1  (will sleep 173 ms)</span><br><span class="line">Ann 1  (will sleep 147 ms)</span><br><span class="line">Joe 2  (will sleep 750 ms)</span><br><span class="line">Ann 2  (will sleep 374 ms)</span><br><span class="line">Joe 3  (will sleep 318 ms)</span><br><span class="line">Ann 3  (will sleep 705 ms)</span><br><span class="line">Joe 4  (will sleep 126 ms)</span><br><span class="line">Ann 4  (will sleep 828 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="多路复用-Multiplexing"><a href="#多路复用-Multiplexing" class="headerlink" title="多路复用 (Multiplexing)"></a>多路复用 (Multiplexing)</h4><p>前面 run07() 里面的代码，始终都是先从 joe 里面读取数据，然后再从 ann 里面读取。如果 ann 里面的数据早于 joe 里面的数据就发送了，由于 channel 的同步特性，ann channel 其实会阻塞在它的 send 操作上，直到 run07 从 joe 里面读取完数据后，ann 所在的协程才能继续运行。</p>
<p>为了改善这种情况，可以使用 fan-in 模式。不管是 joe 还是 ann，只要有数据准备好并且执行了 send 操作，都可以立刻读取到。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;String&gt;, input2: ReceivingChannel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input1.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input2.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run08</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(c.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 75 ms)</span><br><span class="line">Ann 0  (will sleep 473 ms)</span><br><span class="line">Joe 1  (will sleep 57 ms)</span><br><span class="line">Joe 2  (will sleep 219 ms)</span><br><span class="line">Joe 3  (will sleep 20 ms)</span><br><span class="line">Joe 4  (will sleep 723 ms)</span><br><span class="line">Ann 1  (will sleep 712 ms)</span><br><span class="line">Joe 5  (will sleep 377 ms)</span><br><span class="line">Ann 2  (will sleep 431 ms)</span><br><span class="line">Joe 6  (will sleep 228 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="回复消息-Restoring-sequencing"><a href="#回复消息-Restoring-sequencing" class="headerlink" title="回复消息 (Restoring sequencing)"></a>回复消息 (Restoring sequencing)</h4><p>前面 run08 里面的 fan-in 模式，boring 函数只负责 send 消息，并不需要消息的接收者做一个答复。如果需要，可以像下面这样修改代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">struct</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> str: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> wait: <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">let</span> waitForIt = <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;() <span class="comment">// Shared between all messages</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">Message</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">Message</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> message = <span class="type">Message</span>(str: <span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>, wait: waitForIt)</span><br><span class="line">            </span><br><span class="line">            channel.send(message)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            waitForIt.receive()!</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;Message&gt;, input2: ReceivingChannel&lt;Message&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">Message</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">Message</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input1.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            channel.send(input2.receive()!)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run09</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">5</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> message1 = <span class="built_in">c</span>.receive()!</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(message1.str)"</span>)</span><br><span class="line">        message1.wait.send(<span class="literal">true</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> message2 = <span class="built_in">c</span>.receive()!</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(message2.str)"</span>)</span><br><span class="line">        message2.wait.send(<span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果会是下面这个样子，并没有明显的区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 551 ms)</span><br><span class="line">Ann 0  (will sleep 53 ms)</span><br><span class="line">Ann 1  (will sleep 543 ms)</span><br><span class="line">Joe 1  (will sleep 412 ms)</span><br><span class="line">Ann 2  (will sleep 847 ms)</span><br><span class="line">Joe 2  (will sleep 46 ms)</span><br><span class="line">Joe 3  (will sleep 274 ms)</span><br><span class="line">Joe 4  (will sleep 69 ms)</span><br><span class="line">Joe 5  (will sleep 202 ms)</span><br><span class="line">Ann 3  (will sleep 962 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h4><p>前面介绍的多路复用技术，是通过启动多个协程实现的，每个 channel 对应一个协程。</p>
<p>另一种更常用的办法，是使用 select 操作，在一个协程里面同时读写多个 channel。</p>
<p>可以用 select 操作重新实现一遍 fan-in 模式</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>)</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1 input1: ReceivingChannel&lt;String&gt;, input2: ReceivingChannel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> &#123;</span><br><span class="line">            select &#123; when <span class="keyword">in</span></span><br><span class="line">                when.receive(from: input1) &#123; value <span class="keyword">in</span></span><br><span class="line">                    <span class="comment">//print("received \(value)")</span></span><br><span class="line">                    channel.send(value)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                when.receive(from: input2) &#123; value <span class="keyword">in</span></span><br><span class="line">                    channel.send(value)</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                when.otherwise &#123;</span><br><span class="line">                    <span class="comment">//print("default case")</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run10</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> ann = boring(<span class="string">"Ann"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = fanIn(input1: joe, input2: ann)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(c.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果和之前的 fan-in 没有区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Ann 0  (will sleep 816 ms)</span><br><span class="line">Joe 0  (will sleep 252 ms)</span><br><span class="line">Joe 1  (will sleep 756 ms)</span><br><span class="line">Ann 1  (will sleep 879 ms)</span><br><span class="line">Joe 2  (will sleep 157 ms)</span><br><span class="line">Joe 3  (will sleep 578 ms)</span><br><span class="line">Ann 2  (will sleep 700 ms)</span><br><span class="line">Joe 4  (will sleep 499 ms)</span><br><span class="line">Joe 5  (will sleep 352 ms)</span><br><span class="line">Ann 3  (will sleep 642 ms)</span><br><span class="line">You&apos;re both boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<p><em>这里用的 select 操作，和 Linux / Unix 里面的 select、poll、epoll，都是类似的，只不过前者监听的是 channel，后者监听的是 fd</em></p>
<h4 id="在-Select-的基础上实现超时机制-Timeout"><a href="#在-Select-的基础上实现超时机制-Timeout" class="headerlink" title="在 Select 的基础上实现超时机制 (Timeout)"></a>在 Select 的基础上实现超时机制 (Timeout)</h4><p>定时器是基于 channel 实现出来的，当达到定时时间的时候，定时器 channel 上会发送一个消息。</p>
<p>定时器可以放在 select 操作的里面</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run11</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> !done &#123;</span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: joe) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\(value)"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.timeout(<span class="number">800</span>.millisecond.fromNow()) &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"You are too slow."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果是下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 48 ms)</span><br><span class="line">Joe 1  (will sleep 706 ms)</span><br><span class="line">Joe 2  (will sleep 747 ms)</span><br><span class="line">Joe 3  (will sleep 304 ms)</span><br><span class="line">You are too slow.</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Select-操作的整体超时"><a href="#Select-操作的整体超时" class="headerlink" title="Select 操作的整体超时"></a>Select 操作的整体超时</h4><p>前面的 run11，是在每次进入 select 的时候，设置了一个超时 channel。</p>
<p>也可以在 while 循环的外面，设置一个整体的超时 channel，像下面这样</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg: String)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int</span>.<span class="built_in">max</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            channel.send(<span class="string">"\(msg) \(i)  (will sleep \(Int(sleepTime * 1000)) ms)"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run12</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> joe = boring(<span class="string">"Joe"</span>)</span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">5</span>.second.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">while</span> !done &#123;</span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: joe) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\(value)"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"You are too slow."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Joe 0  (will sleep 586 ms)</span><br><span class="line">Joe 1  (will sleep 226 ms)</span><br><span class="line">Joe 2  (will sleep 297 ms)</span><br><span class="line">Joe 3  (will sleep 850 ms)</span><br><span class="line">Joe 4  (will sleep 442 ms)</span><br><span class="line">Joe 5  (will sleep 525 ms)</span><br><span class="line">Joe 6  (will sleep 730 ms)</span><br><span class="line">Joe 7  (will sleep 227 ms)</span><br><span class="line">Joe 8  (will sleep 630 ms)</span><br><span class="line">Joe 9  (will sleep 411 ms)</span><br><span class="line">You are too slow.</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="取消-quit-channel"><a href="#取消-quit-channel" class="headerlink" title="取消 (quit channel)"></a>取消 (quit channel)</h4><p>boring 函数的调用者，可以主动的让 boring 内部的协程停止工作，也是通过 channel 来实现。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, quit: ReceivingChannel&lt;Bool&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        forSelect &#123; when, done <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            when.send(<span class="string">"\(msg), and will sleep \(Int(sleepTime * 1000)) ms"</span>, to: channel) &#123;</span><br><span class="line">                <span class="comment">//print("sent value")</span></span><br><span class="line">            &#125;</span><br><span class="line">            when.receive(from: quit) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                done()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run13</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> quit = <span class="type">Channel</span>&lt;<span class="type">Bool</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> joe = boring(msg: <span class="string">"Joe"</span>, quit: quit.receivingChannel)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int64</span>(arc4random_uniform(<span class="number">10</span>) + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(joe.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    quit.send(<span class="literal">true</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果仍然是类似的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Joe, and will sleep 154 ms</span><br><span class="line">Joe, and will sleep 390 ms</span><br><span class="line">Joe, and will sleep 133 ms</span><br><span class="line">Joe, and will sleep 520 ms</span><br><span class="line">Joe, and will sleep 752 ms</span><br><span class="line">Joe, and will sleep 482 ms</span><br><span class="line">Joe, and will sleep 47 ms</span><br><span class="line">Joe, and will sleep 359 ms</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="在-quit-channel-上接收消息"><a href="#在-quit-channel-上接收消息" class="headerlink" title="在 quit channel 上接收消息"></a>在 quit channel 上接收消息</h4><p>接着上面的例子，当 run13 向 quit channel 发送 true 的时候，run13 怎样才能知道 boring 函数成功的结束了自己的运行呢？让 boring 告诉它的调用者就行，同样，还是通过 quit channel。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">cleanup</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Here, do clean up"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg msg: String, quit: Channel&lt;String&gt;)</span></span> -&gt; <span class="type">ReceivingChannel</span>&lt;<span class="type">String</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        forSelect &#123; when, done <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">            nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">            </span><br><span class="line">            when.send(<span class="string">"\(msg), and will sleep \(Int(sleepTime * 1000)) ms"</span>, to: channel) &#123;</span><br><span class="line">                <span class="comment">//print("sent value")</span></span><br><span class="line">            &#125;</span><br><span class="line">            when.receive(from: quit) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                cleanup()</span><br><span class="line">                quit.send(<span class="string">"See you!"</span>)</span><br><span class="line">                done()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        channel.close()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receivingChannel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run14</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> quit = <span class="type">Channel</span>&lt;<span class="type">String</span>&gt;()</span><br><span class="line">    <span class="keyword">let</span> joe = boring(msg: <span class="string">"Joe"</span>, quit: quit)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="type">Int64</span>(arc4random_uniform(<span class="number">10</span>) + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\(joe.receive()!)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    quit.send(<span class="string">"Bye"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Joe says: \(quit.receive()!)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在运行结果会变成下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Joe, and will sleep 220 ms</span><br><span class="line">Joe, and will sleep 736 ms</span><br><span class="line">Joe, and will sleep 308 ms</span><br><span class="line">Joe, and will sleep 858 ms</span><br><span class="line">Joe, and will sleep 527 ms</span><br><span class="line">Joe, and will sleep 163 ms</span><br><span class="line">Joe, and will sleep 844 ms</span><br><span class="line">Here, do clean up</span><br><span class="line">Joe says: See you!</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h4 id="Daisy-chain"><a href="#Daisy-chain" class="headerlink" title="Daisy-chain"></a>Daisy-chain</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(<span class="keyword">left</span> <span class="keyword">left</span>: Channel&lt;Int&gt;, <span class="keyword">right</span>: Channel&lt;Int&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">left</span>.send(<span class="keyword">right</span>.receive()! + <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run15</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> leftMost = <span class="type">Channel</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">right</span> = leftMost</span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">left</span> = leftMost</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">10000</span> &#123;</span><br><span class="line">        <span class="keyword">right</span> = <span class="type">Channel</span>&lt;<span class="type">Int</span>&gt;()</span><br><span class="line">        co &#123;</span><br><span class="line">            f(<span class="keyword">left</span>: <span class="keyword">left</span>, <span class="keyword">right</span>: <span class="keyword">right</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">left</span> = <span class="keyword">right</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        <span class="keyword">right</span>.send(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Joe says: \(leftMost.receive()!)"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Joe says: 10001</span><br><span class="line">You&apos;re boring; I&apos;m leaving.</span><br></pre></td></tr></table></figure>
<h3 id="系统软件-Systems-Software"><a href="#系统软件-Systems-Software" class="headerlink" title="系统软件 (Systems Software)"></a>系统软件 (Systems Software)</h3><p>让我们具体看一下 CSP 这种并发模型，是如何用在系统软件的开发中的。</p>
<h4 id="例子：Google-Search"><a href="#例子：Google-Search" class="headerlink" title="例子：Google Search"></a>例子：Google Search</h4><p>问: Google search 需要做什么事情?</p>
<p>答: 输入一个搜索关键字 (query)，得到一组搜索结果 (和一些广告)。</p>
<p>问: 怎样获取这样的一组搜索结果？</p>
<p>答: 把搜索关键字分别发送给 Web search service，Image search service，YouTube search service，Maps search service，News search service 等等，然后把它们返回的结果再组合到一起。</p>
<p>那么，怎样做呢？</p>
<h4 id="模拟各种-search-service"><a href="#模拟各种-search-service" class="headerlink" title="模拟各种 search service"></a>模拟各种 search service</h4><p>模拟 3 个 search service，每次执行 search 的时候，随机延时一小段时间。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">typealias</span> <span class="type">GoogleSearchResult</span> = <span class="type">String</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">fakeSearch</span><span class="params">(kind: String)</span></span> -&gt; (<span class="type">String</span>) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">search</span><span class="params">(query: String)</span></span> -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> sleepTime = <span class="type">Int</span>(arc4random_uniform(<span class="number">1000</span>) + <span class="number">1</span>).milliseconds</span><br><span class="line">        <span class="comment">//print("--&gt;\(kind) search use time: \(Int(sleepTime * 1000)) ms")</span></span><br><span class="line">        nap(<span class="keyword">for</span>: sleepTime)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">GoogleSearchResult</span>(<span class="string">"\(kind) result for \(query), use time: \(Int(sleepTime * 1000)) ms"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> search</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> web = fakeSearch(<span class="string">"web"</span>)</span><br><span class="line"><span class="keyword">let</span> image = fakeSearch(<span class="string">"image"</span>)</span><br><span class="line"><span class="keyword">let</span> video = fakeSearch(<span class="string">"video"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//some util</span></span><br><span class="line"><span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">time</span><span class="params">(desc: String, function: <span class="params">()</span></span></span>-&gt;()) &#123;</span><br><span class="line">    <span class="keyword">let</span> start : <span class="type">UInt64</span> = mach_absolute_time()</span><br><span class="line">    function()</span><br><span class="line">    <span class="keyword">let</span> duration : <span class="type">UInt64</span> = mach_absolute_time() - start</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> info : mach_timebase_info = mach_timebase_info(numer: <span class="number">0</span>, denom: <span class="number">0</span>)</span><br><span class="line">    mach_timebase_info(&amp;info)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> total = (duration * <span class="type">UInt64</span>(info.numer) / <span class="type">UInt64</span>(info.denom)) / <span class="type">NSEC_PER_MSEC</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\(desc)\(total) ms."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GoogleSearchResult</span>: <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"  \(self)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">extension</span> <span class="title">Array</span> <span class="title">where</span> <span class="title">Element</span>: <span class="title">GoogleSearchResultDebugAble</span> </span>&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="function"><span class="keyword">func</span> <span class="title">log</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"google search result is:"</span>)</span><br><span class="line">        <span class="keyword">for</span> searchResult <span class="keyword">in</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            searchResult.log()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-1-0"><a href="#Google-Search-1-0" class="headerlink" title="Google Search 1.0"></a>Google Search 1.0</h4><p>google 函数有一个输入参数，返回一个数组。</p>
<p>google 内部按照顺序依次调用 web、image、video search service，然后把它们的结果组装在一个数组内。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    results.append(web(query))</span><br><span class="line">    results.append(image(query))</span><br><span class="line">    results.append(video(query))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run17</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v1.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果是下面这个样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v1.0, use time: 1237 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web result for CSP, use time: 743 ms</span><br><span class="line">  image result for CSP, use time: 240 ms</span><br><span class="line">  video result for CSP, use time: 243 ms</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-2-0"><a href="#Google-Search-2-0" class="headerlink" title="Google Search 2.0"></a>Google Search 2.0</h4><p>并发调用 web、image、video search service，然后等待它们的返回结果。</p>
<p>不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co(channel.send(web(query)))</span><br><span class="line">    co(channel.send(image(query)))</span><br><span class="line">    co(channel.send(video(query)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        results.append(channel.receive()!)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run18</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v2.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v2.0, use time: 871 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  image result for CSP, use time: 40 ms</span><br><span class="line">  video result for CSP, use time: 307 ms</span><br><span class="line">  web result for CSP, use time: 864 ms</span><br></pre></td></tr></table></figure>
<p>很明显，并发执行的效果比顺序执行的效果好很多。</p>
<h4 id="Google-Search-2-1"><a href="#Google-Search-2-1" class="headerlink" title="Google Search 2.1"></a>Google Search 2.1</h4><p>还可以加上超时机制，如果某个 search service 执行的时间太长，就不等待它的返回结果。</p>
<p>不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co(channel.send(web(query)))</span><br><span class="line">    co(channel.send(image(query)))</span><br><span class="line">    co(channel.send(video(query)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">800</span>.milliseconds.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> done == <span class="literal">true</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: channel) &#123; value <span class="keyword">in</span></span><br><span class="line">                results.append(value)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"timeout."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run19</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v2.1, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果看到下面这种形式的运行结果，则说明是触发了超时的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">timeout.</span><br><span class="line">google search v2.1, use time: 810 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web result for CSP, use time: 341 ms</span><br><span class="line">  video result for CSP, use time: 537 ms</span><br></pre></td></tr></table></figure>
<h4 id="避免超时"><a href="#避免超时" class="headerlink" title="避免超时"></a>避免超时</h4><p>问：怎样才能避免丢弃响应速度更慢的服务器返回的搜索结果？</p>
<p>答：使用 Replicate 策略。同时向多个同类型的 search service 发送请求，使用第一个返回来的查询结果。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">first</span><span class="params">(query query: String, replicas: <span class="params">(<span class="params">(String)</span></span></span></span> -&gt; <span class="type">GoogleSearchResult</span>)...) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> search <span class="keyword">in</span> replicas &#123;</span><br><span class="line">        co(channel.send(search(query)))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receive()!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Google-Search-3-0"><a href="#Google-Search-3-0" class="headerlink" title="Google Search 3.0"></a>Google Search 3.0</h4><p>仍然不使用锁机制，不使用条件状态变量，不使用 callback。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> Venice</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> web1 = fakeSearch(<span class="string">"web1"</span>)</span><br><span class="line"><span class="keyword">let</span> web2 = fakeSearch(<span class="string">"web2"</span>)</span><br><span class="line"><span class="keyword">let</span> image1 = fakeSearch(<span class="string">"image1"</span>)</span><br><span class="line"><span class="keyword">let</span> image2 = fakeSearch(<span class="string">"image2"</span>)</span><br><span class="line"><span class="keyword">let</span> video1 = fakeSearch(<span class="string">"video1"</span>)</span><br><span class="line"><span class="keyword">let</span> video2 = fakeSearch(<span class="string">"video2"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">first</span><span class="params">(query query: String, replicas: <span class="params">(<span class="params">(String)</span></span></span></span> -&gt; <span class="type">GoogleSearchResult</span>)...) -&gt; <span class="type">GoogleSearchResult</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> search <span class="keyword">in</span> replicas &#123;</span><br><span class="line">        co(channel.send(search(query)))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> channel.receive()!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">google</span><span class="params">(query: String)</span></span> -&gt; <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> channel = <span class="type">Channel</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: web1, web2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: image1, image2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    co &#123;</span><br><span class="line">        channel.send(first(query: query, replicas: video1, video2))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> results = <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> timeout = <span class="type">Timer</span>(timingOut: <span class="number">1000</span>.milliseconds.fromNow()).channel</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> done = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> <span class="number">_</span> <span class="keyword">in</span> <span class="number">0</span>..&lt;<span class="number">3</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> done == <span class="literal">true</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        select &#123; when <span class="keyword">in</span></span><br><span class="line">            when.receive(from: channel) &#123; value <span class="keyword">in</span></span><br><span class="line">                <span class="comment">//print("receive \(value)")</span></span><br><span class="line">                results.append(value)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            when.receive(from: timeout) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"timeout."</span>)</span><br><span class="line">                done = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">run20</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Array</span>&lt;<span class="type">GoogleSearchResult</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    time(<span class="string">"google search v3.0, use time: "</span>) &#123; () -&gt; () <span class="keyword">in</span></span><br><span class="line">        result = google(<span class="string">"CSP"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    result?.log()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的运行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">google search v3.0, use time: 506 ms.</span><br><span class="line">google search result is:</span><br><span class="line">  web1 result for CSP, use time: 433 ms</span><br><span class="line">  image1 result for CSP, use time: 434 ms</span><br><span class="line">  video2 result for CSP, use time: 499 ms</span><br></pre></td></tr></table></figure>
<h3 id="不要过度使用"><a href="#不要过度使用" class="headerlink" title="不要过度使用"></a>不要过度使用</h3><p>coroutine 和 channel 是一种很好的设计思想，可以解决某些类型的问题。</p>
<p>但是，有时我们仍然会面对一些需要用传统思路来解决的小问题，也就是基于锁机制 (共享内存)。</p>
<p>这两种不同的技术思路，并不冲突，它们是可以共存的。</p>
<p>正确的工具做正确的事情。</p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>这篇文章里面的 demo code 位于 <a href="https://github.com/fengjian0106/CSP-tutorial.git" target="_blank" rel="noopener">https://github.com/fengjian0106/CSP-tutorial.git</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/02/11/Minuum-And-Fleksy-Input-Method-Fuzzy-Matching/" itemprop="url">
                  如何实现Minuum和Fleksy输入法中的智能纠错功能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-02-11T10:56:30+08:00" content="2015-02-11">
              2015-02-11
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/02/11/Minuum-And-Fleksy-Input-Method-Fuzzy-Matching/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/02/11/Minuum-And-Fleksy-Input-Method-Fuzzy-Matching/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>输入法的产品一直在持续技术演进，最近的一项工作，是实现了一个类似 <a href="http://minuum.com/" target="_blank" rel="noopener">Minuum</a> 和 <a href="http://fleksy.com/" target="_blank" rel="noopener">Fleksy</a> 这两款输入法中的模糊输入功能的单词智能纠错引擎，前后尝试过4种不同的算法思路，最终才找到适合手机的解决方案，特此记录一下。</p>
<ol>
<li>基于贝叶斯推断的，主要线索是 <a href="http://norvig.com/spell-correct.html" target="_blank" rel="noopener">http://norvig.com/spell-correct.html</a></li>
<li>基于Levenshtein自动机的，主要线索是 <a href="http://blog.notdot.net/2010/07/Damn-Cool-Algorithms-Levenshtein-Automata" target="_blank" rel="noopener">http://blog.notdot.net/2010/07/Damn-Cool-Algorithms-Levenshtein-Automata</a></li>
<li>一种基于预处理词库的改进算法，主要线索是 <a href="http://blog.faroo.com/2012/06/07/improved-edit-distance-based-spelling-correction/" target="_blank" rel="noopener">http://blog.faroo.com/2012/06/07/improved-edit-distance-based-spelling-correction/</a></li>
<li>使用机器学习中的kNN算法，主要线索是 <a href="http://minuum.com/model-your-users-algorithms-behind-the-minuum-keyboard/" target="_blank" rel="noopener">http://minuum.com/model-your-users-algorithms-behind-the-minuum-keyboard/</a> 和 <a href="http://www.zhihu.com/question/27567987" target="_blank" rel="noopener">http://www.zhihu.com/question/27567987</a></li>
</ol>
<p>前三个方案，都是用传统的算法思路，基于<a href="http://en.wikipedia.org/wiki/Levenshtein_distance" target="_blank" rel="noopener">编辑距离</a>来实现模糊匹配，但是在手机上无法满足输入法的性能需求，尤其是查询速度这一点，而且也无法做到和Minuum或Fleksy类似的纠错效果。最终的第4个方案，则是彻底更换了思路，直接用机器学习中的 <a href="http://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm" target="_blank" rel="noopener">kNN</a> 算法，把字符串映射到更抽象的几何空间中，也就是所谓的特征向量，进行纯粹的数学计算。学习和研究的过程中，是直接用Python做的代码原型验证，放到github上了，有兴趣的朋友可以看看 <a href="https://github.com/fengjian0106/Minuum-Fleksy-Fuzzy-Matching" target="_blank" rel="noopener">https://github.com/fengjian0106/Minuum-Fleksy-Fuzzy-Matching</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/12/09/Ultrasonic-Communication/" itemprop="url">
                  手机超声波通信
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-12-09T11:30:11+08:00" content="2014-12-09">
              2014-12-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2014/12/09/Ultrasonic-Communication/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2014/12/09/Ultrasonic-Communication/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这其实是两年前的一个产品，使用场景类似于基于苹果推出的<code>iBeacon</code>实现室内定位，利用一个小巧的超声波硬件设备，周期性的广播信标信号，手机直接使用麦克风接收这个音频信号并且解码，得到信标信号中的有效数据，最后再根据这个数据进行室内定位的算法逻辑处理。声波通信部分，是技术基础，开发难度比较大，在当时的情况下，对于产品来说，是一个技术壁垒。现在已经过去两年时间了，而且其实出于商业层面的原因，团队也早已放弃这个产品转战其他方向了，所以我还是准备把其中的一些技术细节记录下来。</p>
<h3 id="基于使用场景而提出的一些技术参数指标"><a href="#基于使用场景而提出的一些技术参数指标" class="headerlink" title="基于使用场景而提出的一些技术参数指标"></a>基于使用场景而提出的一些技术参数指标</h3><ol>
<li>只能使用18kHz~21kHz这个范围内的音频信号(人耳要尽量听不见这个声音，手机要能够接收到这个声音，所以只能限制在这个频率范围内)</li>
<li>通信距离最远要达到10米 </li>
<li>还有一些是硬件设备的性能要求，和通信协议无关，不是这次的讨论重点，可以忽略</li>
</ol>
<h3 id="关键技术点"><a href="#关键技术点" class="headerlink" title="关键技术点"></a>关键技术点</h3><ol>
<li>为了减小数据处理过程中的延迟现象，采取的是实时的进行音频数据采集和数据处理，而不是像某些类似SDK中使用的技术那样，先录音得到一小段音频文件，然后再进行数据处理。具体到iOS平台上，就是使用audio unit框架来搭建PCM音频数据的采集管道，在管道的最后一个节点上，对得到的PCM数据再进行进一步的处理。</li>
<li>仍然是为了降低延迟，使用手机的DSP硬件来进行快速傅里叶变换，具体到iOS上，就是用了Accelerate.framework框架中的相关函数。</li>
<li>为了提高数据传输和解码的成功率，在2FSK的基础上，做了一些调整(magic trick)。</li>
</ol>
<p>前两点没有太多可说的，对应的开发文档中有很详尽的描述，只不过稍微偏底层一些，只要静下心来老老实实的啃啃文档，还是可以搞定的。第3点中用到的技巧，可能不太常见，我会详细解释一下。</p>
<p>基于标准的2FSK，假如约定用18kHz的音频信号表示二进制的0，用19kHz的音频信号表示二进制的1，同时约定每一个bit持续的发送时间为50ms，假设要发送一个8bit的二进制数据0b11001010(忽略同步和校验部分的bit)，对于发送端来说，代码逻辑其实比较简单，只需要让特定频率的引号信号发送特定的时间就行了。但是对于接收端来说，代码就很困难了，虽然用的是2FSK，但是并没有专用的硬件来完成调制解调过程，所以要完全用代码来模拟整个过程，这个里面就涉及到了傅里叶变换、滤波等大量的数字信号处理里面的内容，这些处理完后，才会真正的进入到通信协议栈里面处理二进制的0和1。</p>
<p>如果按照标准的2FSK方式，接收端的代码必须用定时器记录0或1(18kHz或19kHz)持续的时间，然后用这个时间值和50ms做比较，才能判断出这一部分音频片段对应了多少个连续的0或1。而且这仅仅是理论上对解码算法的描述，实际情况中，发送端维持的每个bit位的持续时间是50ms，进入空气中后，会和其他的各种各样的音频信号混杂在一起，然后才进入接收端进行变换和滤波等操作，这个时候，是很难保证每个bit位仍然能够维持在50ms的(即便有50ms，代码仍然会很难编写)，正式因为这些原因，成功解码数据的概率并不高。为了改善这种情况，对2FSK做了一些调整，这里借鉴了数字电路里面的一些概念和技术。在数电的串行接口电路中，使用高低电平来表示二进制的1和0，根据传输比特率的约定，每个电平会持续特定的时间，这类似于我们的音频系统中约定的每个bit持续发送50ms，这通常称为电平检测(根据电平值持续的时间进行检测)，还有另外一种称为边缘检测的技术，它不依赖于每个电平值持续的时间，而是依赖于电平值的变化事件，比如电平从高变为低(从1变为0)。这里就是使用了边缘检测这种方式来处理音频信号，接收端需要关注的，是音频信号频率值的变化，而不是每个频率值持续的时间。为了实现这种方式，还需要对之前的约定做一些调整，调整为18kHz和19kHz的音频信号都可以表示二进制的0，20kHz和21kHz的音频信号都可以表示二进制的1，如果是为了表示两个连续的0，那么就应该是18kHz的音频信号持续50ms，然后变成19kHz的音频信号持续50ms(或者先发送19kHz的，再发送18kHz的)，对于连续的1，也采用类似的策略。举个例子，对于二进制数据0b11101000，转换成频率值后，可能就会是这样的一组值 [20kHz，21kHz，20kHz，18kHz，21kHz，18kHz，19kHz，18kHz]，因为每一个bit对应的频率值都会发生变化，那么接收端就可以忽略每个bit持续的时间，只需要检测出每一次频率值发生变化就行了，每一次变化后得到的数值，就可以对应到当前的bit位的二进制值。用了这种调制解调的思路后，接收端的代码，写起来就很容易了:]</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="FengJian" />
          <p class="site-author-name" itemprop="name">FengJian</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FengJian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"fengjian0106"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
